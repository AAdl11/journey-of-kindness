<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å–„çš„æ—…ç¨‹ Level 5: Bayesian Network | Circle of Care</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Noto Sans TC', sans-serif; box-sizing: border-box; }
        .screen { display: none; min-height: 100vh; }
        .screen.active { display: flex; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulseGlow { 0%, 100% { box-shadow: 0 0 20px rgba(251, 191, 36, 0.6); } 50% { box-shadow: 0 0 40px rgba(251, 191, 36, 0.9); } }
        @keyframes breatheRing { 0%, 100% { transform: scale(0.85); opacity: 0.7; } 50% { transform: scale(1.15); opacity: 1; } }
        @keyframes heartbeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        
        .fade-in { animation: fadeIn 0.8s ease-out; }
        .slide-up { animation: slideUp 0.6s ease-out; }
        .pulse-glow { animation: pulseGlow 2s infinite; }
        .heartbeat { animation: heartbeat 1.5s ease-in-out infinite; }
        
        /* èƒŒæ™¯ - æ›´æ¸…æ™°é€æ˜ */
        .bg-community { background: url('L5_bayviewSt_cleaned.png') center center/cover no-repeat; background-color: #fef3c7; }
        .bg-map { background: url('p12_ç¤¾å€é—œæ‡·åœ°åœ–ä»‹é¢.png') center center/cover no-repeat; background-color: #ecfdf5; }
        
        /* éœå¿ƒä¹‹é–€ - æ”¹ç”¨è²æ°ç¶²è·¯è¦–è¦ºåŒ–èƒŒæ™¯ï¼ˆæ„›å¿ƒé€£çµï¼‰ */
        .bg-ataraxy {
            background: url('p11_è²æ°ç¶²è·¯è¦–è¦ºåŒ–èƒŒæ™¯_cleaned.png') center center/cover no-repeat;
            background-color: #fce7f3;
        }
        
        /* ç»ç’ƒå¡ç‰‡ - éå¸¸é€æ˜è®“èƒŒæ™¯éœ²å‡ºä¾† */
        .glass-card { 
            background: rgba(255,255,255,0.65); 
            backdrop-filter: blur(3px); 
            border-radius: 20px; 
            border: 2px solid rgba(255,255,255,0.3); 
            box-shadow: 0 5px 20px rgba(0,0,0,0.06); 
        }
        
        /* å°è©±æ¡†èƒŒæ™¯ - æ›´é€æ˜ */
        .dialogue-box-clear {
            background: rgba(255,255,255,0.7);
            border: 3px solid #f59e0b;
            border-radius: 20px;
            padding: 20px 28px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
        }
        
        .character-card { 
            background: rgba(255,255,255,0.65); 
            border: 3px solid transparent; 
            border-radius: 16px; 
            padding: 12px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
        }
        .character-card:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .character-card.selected { border-color: #ec4899; box-shadow: 0 0 25px rgba(236, 72, 153, 0.5); }
        .character-avatar { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; border: 3px solid white; box-shadow: 0 3px 15px rgba(0,0,0,0.15); }
        
        /* å¤§é ­åƒ - æ‹œè¨ªå ´æ™¯ç”¨ */
        .character-avatar-large {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid white;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .prob-bar-container { width: 100%; height: 20px; background: linear-gradient(to right, #dcfce7, #fef9c3, #fee2e2); border-radius: 10px; overflow: hidden; position: relative; border: 2px solid rgba(0,0,0,0.1); }
        .prob-bar-fill { height: 100%; background: linear-gradient(90deg, #22c55e, #eab308, #ef4444); border-radius: 8px; transition: width 0.5s ease; }
        .prob-indicator { position: absolute; top: -6px; transform: translateX(-50%); font-size: 1.2rem; }
        
        .dialogue-text { font-size: 1.4rem; line-height: 1.8; color: #374151; font-weight: 500; }
        
        /* æ‹œè¨ªå ´æ™¯ - å·¦å³ä½ˆå±€ */
        .visit-layout {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
            min-height: 100vh;
            padding: 40px;
        }
        .visit-left {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .visit-right {
            max-width: 500px;
        }
        
        .result-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.85); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .result-card { background: linear-gradient(135deg, #ffffff, #fef3c7); border-radius: 24px; padding: 2.5rem; text-align: center; max-width: 550px; border: 4px solid; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
        .result-card.surprise { border-color: #f59e0b; }
        .result-card.touching { border-color: #ec4899; }
        
        /* å‘¼å¸ç’° - é‡‘è‰² (è·Ÿ Level 2 ä¸€æ¨£) */
        .breath-ring {
            width: 120px; 
            height: 120px; 
            border-radius: 50%;
            border: 4px solid rgba(251, 191, 36, 0.9);
            animation: breatheRing 4s ease-in-out infinite;
            box-shadow: 0 0 40px rgba(251, 191, 36, 0.5);
            display: flex; 
            align-items: center; 
            justify-content: center;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
        }
        
        /* éœæ€èªå¡ç‰‡ - ç©ºéˆç§‘å¹»æ„Ÿ */
        .jingsi-card {
            background: rgba(255, 255, 255, 0.25); 
            backdrop-filter: blur(12px);
            border-radius: 20px; 
            padding: 1.5rem 2.5rem; 
            max-width: 500px;
            text-align: center; 
            border: 2px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }
        
        .elo-badge { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #1f2937; padding: 8px 16px; border-radius: 9999px; font-weight: bold; }
        
        .btn-primary { background: linear-gradient(135deg, #ec4899, #8b5cf6); color: white; padding: 14px 28px; border-radius: 14px; font-weight: bold; font-size: 1.1rem; border: none; cursor: pointer; transition: all 0.2s; box-shadow: 0 5px 20px rgba(236, 72, 153, 0.4); }
        .btn-primary:hover { transform: translateY(-3px); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        
        /* å°èˆªæŒ‰éˆ• - ä¸åŒé¡è‰² */
        .nav-btn-home { background: linear-gradient(135deg, #6b7280, #4b5563); color: white; padding: 12px 24px; border-radius: 12px; font-weight: bold; border: none; cursor: pointer; }
        .nav-btn-replay { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 12px 24px; border-radius: 12px; font-weight: bold; border: none; cursor: pointer; }
        .nav-btn-next { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; padding: 12px 24px; border-radius: 12px; font-weight: bold; border: none; cursor: pointer; }
        
        .btn-override { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 8px 16px; border-radius: 10px; font-weight: bold; font-size: 0.85rem; border: none; cursor: pointer; }
        
        .lang-toggle { position: fixed; top: 12px; right: 70px; z-index: 1000; display: flex; background: rgba(255, 255, 255, 0.95); border-radius: 9999px; padding: 4px; border: 2px solid rgba(236, 72, 153, 0.4); }
        .lang-btn { padding: 6px 14px; border-radius: 9999px; border: none; cursor: pointer; font-weight: bold; background: transparent; color: #6b7280; }
        .lang-btn.active { background: linear-gradient(135deg, #ec4899, #8b5cf6); color: white; }
        
        .music-toggle { position: fixed; top: 12px; right: 12px; z-index: 1000; background: rgba(255, 255, 255, 0.95); border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid rgba(236, 72, 153, 0.4); font-size: 1.3rem; }
        
        .nav-buttons { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 12px; z-index: 50; background: rgba(255,255,255,0.9); padding: 10px 20px; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); }
        .nav-btn { padding: 8px 16px; border-radius: 10px; border: 2px solid #e5e7eb; background: white; cursor: pointer; font-weight: 500; }
        .nav-btn:hover { border-color: #ec4899; color: #ec4899; }
        
        .game-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; height: calc(100vh - 100px); padding: 16px; }
        .math-section { background: rgba(255,255,255,0.65); border-radius: 20px; padding: 20px; border: 2px solid rgba(139, 92, 246, 0.1); overflow-y: auto; }
        @media (max-width: 1024px) { .game-layout { grid-template-columns: 1fr; } .visit-layout { flex-direction: column; } }

        /* Bottom Navigation Bar */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000;
            display: flex; justify-content: center; gap: 8px; padding: 12px 16px;
            background: linear-gradient(to top, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.9));
            backdrop-filter: blur(20px); border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        .bottom-nav .bnav-btn {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            padding: 8px 16px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.15);
            background: rgba(255, 255, 255, 0.08); color: rgba(255, 255, 255, 0.9);
            cursor: pointer; transition: all 0.3s; font-size: 12px; min-width: 70px;
        }
        .bottom-nav .bnav-btn:hover { background: rgba(255, 255, 255, 0.15); transform: translateY(-2px); }
        .bottom-nav .nav-icon { font-size: 20px; }
    </style>
</head>
<body class="bg-gray-100">

<div class="lang-toggle">
    <button class="lang-btn" onclick="setLang('en')">EN</button>
    <button class="lang-btn active" onclick="setLang('zh')">ä¸­æ–‡</button>
</div>
<div class="music-toggle" onclick="toggleMusic()" id="music-btn">ğŸ”‡</div>

<!-- INTRO -->
<div id="intro-screen" class="screen active bg-community flex-col items-center justify-center p-4">
    <div class="glass-card p-8 max-w-lg text-center fade-in">
        <h1 class="text-3xl md:text-4xl font-bold mb-3">
            <span class="bg-gradient-to-r from-pink-500 to-purple-600 bg-clip-text text-transparent">Level 5: Bayesian Network</span>
        </h1>
        <p class="text-xl text-gray-700 mb-1" data-en="Circle of Care" data-zh="å¿ƒçš„å¾ªç’°">å¿ƒçš„å¾ªç’°</p>
        <p class="text-sm text-gray-500 mb-5">Bayview-Hunters Point Community</p>
        
        <div class="bg-gradient-to-r from-pink-50 to-purple-50 rounded-xl p-5 mb-5 text-left border border-pink-200">
            <div class="flex items-center gap-3 mb-3">
                <span class="text-4xl heartbeat">ğŸ’—</span>
                <div>
                    <p class="font-bold text-pink-600 text-lg" data-en="Who Needs Care Today?" data-zh="ä»Šå¤©èª°éœ€è¦è¢«é—œå¿ƒï¼Ÿ">ä»Šå¤©èª°éœ€è¦è¢«é—œå¿ƒï¼Ÿ</p>
                    <p class="text-gray-600" data-en="Use Bayesian reasoning to find out" data-zh="ç”¨è²æ°æ¨ç†æ‰¾å‡ºç­”æ¡ˆ">ç”¨è²æ°æ¨ç†æ‰¾å‡ºç­”æ¡ˆ</p>
                </div>
            </div>
            <div class="space-y-2 text-gray-700">
                <p>ğŸ”® <span data-en="Observe evidence & update probabilities" data-zh="è§€å¯Ÿè­‰æ“šï¼Œæ›´æ–°æ©Ÿç‡">è§€å¯Ÿè­‰æ“šï¼Œæ›´æ–°æ©Ÿç‡</span></p>
                <p>ğŸšª <span data-en="Choose who to visit (limited time!)" data-zh="é¸æ“‡è¦æ‹œè¨ªèª°ï¼ˆæ™‚é–“æœ‰é™ï¼ï¼‰">é¸æ“‡è¦æ‹œè¨ªèª°ï¼ˆæ™‚é–“æœ‰é™ï¼ï¼‰</span></p>
                <p>ğŸ’¡ <span data-en="Sometimes data lies... trust your heart" data-zh="æœ‰æ™‚æ•¸æ“šæœƒé¨™äºº... ç›¸ä¿¡ä½ çš„å¿ƒ">æœ‰æ™‚æ•¸æ“šæœƒé¨™äºº... ç›¸ä¿¡ä½ çš„å¿ƒ</span></p>
            </div>
        </div>
        
        <div class="bg-yellow-50 rounded-lg p-4 mb-5 border border-yellow-200">
            <p class="text-gray-700"><span class="font-bold text-yellow-600">â­ ELO</span> - <span data-en="Good decisions earn points!" data-zh="åšå°æ±ºç­–å¾—åˆ†ï¼">åšå°æ±ºç­–å¾—åˆ†ï¼</span></p>
        </div>
        
        <button onclick="startGame()" class="btn-primary text-xl px-12 py-4 pulse-glow">ğŸŒŸ <span data-en="Start" data-zh="é–‹å§‹éŠæˆ²">é–‹å§‹éŠæˆ²</span></button>
    </div>
    <div class="nav-buttons">
        <button class="nav-btn" onclick="goToMainMenu()">ğŸ  <span data-en="Main Menu" data-zh="ä¸»é¸å–®">ä¸»é¸å–®</span></button>
        <button class="nav-btn" onclick="goToPrevLevel()">â¬…ï¸ <span data-en="Prev Level" data-zh="ä¸Šä¸€é—œ">ä¸Šä¸€é—œ</span></button>
    </div>
</div>

<!-- GAME -->
<div id="game-screen" class="screen bg-map flex-col">
    <div class="glass-card mx-4 mt-4 p-3 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <span class="font-bold text-lg text-pink-600">ğŸ’— <span data-en="Community Care" data-zh="ç¤¾å€é—œæ‡·">ç¤¾å€é—œæ‡·</span></span>
            <span class="text-gray-500"><span data-en="Round" data-zh="å›åˆ">å›åˆ</span> <span id="round-display" class="text-purple-600 font-bold">1</span>/3</span>
        </div>
        <div class="flex items-center gap-4">
            <div class="elo-badge">â­ <span id="elo-display">1500</span></div>
            <div class="text-lg"><span class="text-green-600">ğŸ˜Š <span id="good-count">0</span></span><span class="text-blue-600 ml-2">ğŸ˜¢ <span id="sad-count">0</span></span></div>
        </div>
    </div>
    
    <div class="game-layout mx-4 mt-4">
        <div class="game-section">
            <div class="dialogue-box-clear mb-4">
                <p class="text-lg text-gray-700" data-en="You are a Bayview community volunteer. This afternoon you can visit 2 neighbors. Based on Bayesian Network analysis, who needs the most care?" data-zh="ä½ æ˜¯ Bayview ç¤¾å€çš„é—œæ‡·å¿—å·¥ã€‚ä»Šå¤©ä¸‹åˆä½ æœ‰æ™‚é–“æ‹œè¨ª 2 ä½é„°å±…ã€‚æ ¹æ“šè²æ°ç¶²è·¯çš„åˆ†æï¼Œèª°æœ€éœ€è¦è¢«é—œå¿ƒå‘¢ï¼Ÿ">ä½ æ˜¯ Bayview ç¤¾å€çš„é—œæ‡·å¿—å·¥ã€‚ä»Šå¤©ä¸‹åˆä½ æœ‰æ™‚é–“æ‹œè¨ª <strong>2 ä½</strong>é„°å±…ã€‚æ ¹æ“šè²æ°ç¶²è·¯çš„åˆ†æï¼Œèª°æœ€éœ€è¦è¢«é—œå¿ƒå‘¢ï¼Ÿ</p>
            </div>
            <div class="grid grid-cols-5 gap-3 mb-4" id="characters-grid"></div>
            <div class="glass-card p-4 text-center">
                <p class="text-gray-600 mb-3 text-lg"><span data-en="Selected:" data-zh="å·²é¸æ“‡ï¼š">å·²é¸æ“‡ï¼š</span><span id="selected-count" class="font-bold text-pink-600 text-xl">0</span>/3</p>
                <div class="flex gap-3 justify-center mb-3">
                    <button onclick="clearSelection()" class="nav-btn-home px-4 py-2 text-sm">ğŸ”„ <span data-en="Clear" data-zh="é‡é¸">é‡é¸</span></button>
                    <button id="visit-btn" onclick="confirmVisit()" class="btn-primary" disabled>ğŸšª <span data-en="Visit Selected" data-zh="æ‹œè¨ªé¸ä¸­çš„é„°å±…">æ‹œè¨ªé¸ä¸­çš„é„°å±…</span></button>
                </div>
                <p class="text-sm text-gray-500" data-en="Or click 'Override' on someone the data says is fine" data-zh="æˆ–å°ã€Œæ•¸æ“šé¡¯ç¤ºæ²’äº‹ã€çš„äººæŒ‰ Override">æˆ–å°ã€Œæ•¸æ“šé¡¯ç¤ºæ²’äº‹ã€çš„äººæŒ‰ Override</p>
            </div>
        </div>
        
        <div class="math-section">
            <h3 class="font-bold text-purple-600 text-xl mb-4">ğŸ”® <span data-en="Bayesian Analysis" data-zh="è²æ°ç¶²è·¯åˆ†æ">è²æ°ç¶²è·¯åˆ†æ</span></h3>
            <div class="bg-white rounded-xl p-4 mb-4 border-2 border-purple-200">
                <p class="text-sm text-gray-500 mb-2" data-en="Hover to see details:" data-zh="æ»‘é¼ ç§»åˆ°è§’è‰²ä¸ŠæŸ¥çœ‹ï¼š">æ»‘é¼ ç§»åˆ°è§’è‰²ä¸ŠæŸ¥çœ‹ï¼š</p>
                <div class="space-y-3">
                    <div class="flex justify-between"><span class="text-gray-600" data-en="Life Stress" data-zh="ç”Ÿæ´»å£“åŠ›">ç”Ÿæ´»å£“åŠ›</span><span class="font-bold text-pink-600" id="bn-stress">-</span></div>
                    <div class="flex justify-between"><span class="text-gray-600" data-en="Connection" data-zh="ç¤¾å€é€£çµ">ç¤¾å€é€£çµ</span><span class="font-bold text-purple-600" id="bn-connection">-</span></div>
                    <div class="flex justify-between"><span class="text-gray-600" data-en="Interaction" data-zh="æœ€è¿‘äº’å‹•">æœ€è¿‘äº’å‹•</span><span class="font-bold text-blue-600" id="bn-interaction">-</span></div>
                    <div class="flex justify-between"><span class="text-gray-600" data-en="Behavior" data-zh="å¤–é¡¯è¡Œç‚º">å¤–é¡¯è¡Œç‚º</span><span class="font-bold text-yellow-600" id="bn-behavior">-</span></div>
                </div>
            </div>
            <div class="bg-gradient-to-r from-green-50 via-yellow-50 to-red-50 rounded-xl p-4 mb-4 border-2 border-orange-200">
                <p class="text-center text-gray-600 mb-2" data-en="Need Care Probability" data-zh="éœ€é—œæ‡·æ©Ÿç‡">éœ€é—œæ‡·æ©Ÿç‡</p>
                <p class="text-center text-4xl font-bold" id="bn-probability" style="color: #22c55e;">-</p>
            </div>
            <div class="bg-purple-50 rounded-xl p-4 border border-purple-200">
                <p class="text-sm text-purple-700 font-mono mb-2">P(NeedsCare | Evidence)</p>
                <p class="text-xs text-gray-500 italic" data-en="Some evidence is invisible to algorithms..." data-zh="æœ‰äº›è­‰æ“šæ˜¯ç®—æ³•çœ‹ä¸è¦‹çš„...">æœ‰äº›è­‰æ“šæ˜¯ç®—æ³•çœ‹ä¸è¦‹çš„...</p>
            </div>
        </div>
    </div>
</div>

<!-- VISIT - å·¦é‚Šå¤§é ­åƒï¼Œå³é‚Šå°è©±æ¡† -->
<div id="visit-screen" class="screen flex-col">
    <div class="visit-layout">
        <!-- å·¦é‚Šï¼šå¤§é ­åƒ -->
        <div class="visit-left">
            <img id="visit-avatar" class="character-avatar-large mb-4" src="" alt="">
            <h2 id="visit-name" class="text-3xl font-bold text-white mb-1" style="text-shadow: 0 2px 10px rgba(0,0,0,0.5);"></h2>
            <p id="visit-location" class="text-xl text-white" style="text-shadow: 0 2px 8px rgba(0,0,0,0.5);"></p>
        </div>
        
        <!-- å³é‚Šï¼šå°è©±æ¡† -->
        <div class="visit-right">
            <div class="dialogue-box-clear slide-up">
                <p id="dialogue-text" class="dialogue-text"></p>
            </div>
            <div class="mt-6 text-center flex gap-3 justify-center">
                <button onclick="goBackToSelect()" class="nav-btn-home">â¬…ï¸ <span data-en="Back" data-zh="è¿”å›">è¿”å›</span></button>
                <button onclick="nextDialogue()" class="btn-primary text-lg"><span data-en="Continue" data-zh="ç¹¼çºŒ">ç¹¼çºŒ</span> â†’</button>
            </div>
        </div>
    </div>
</div>

<!-- RESULT -->
<div id="result-overlay" class="result-overlay" style="display: none;">
    <div id="result-card" class="result-card surprise slide-up">
        <div id="result-emoji" class="text-7xl mb-4">ğŸ˜®</div>
        <h2 id="result-title" class="text-2xl font-bold mb-3 text-gray-800"></h2>
        <p id="result-message" class="text-lg text-gray-600 mb-4"></p>
        <div class="bg-purple-50 rounded-lg p-4 mb-4 border-2 border-purple-200"><p id="result-insight" class="text-purple-700 text-sm"></p></div>
        <p id="result-elo" class="text-2xl font-bold text-orange-500 mb-4">+30 ELO</p>
        <button onclick="nextRound()" class="btn-primary text-lg"><span data-en="Continue" data-zh="ç¹¼çºŒ">ç¹¼çºŒ</span> â†’</button>
    </div>
</div>

<!-- ATARAXY - éœå¿ƒä¹‹é–€ (è²æ°ç¶²è·¯è¦–è¦ºåŒ–èƒŒæ™¯ - æ„›å¿ƒé€£çµ) -->
<div id="ataraxy-screen" class="screen bg-ataraxy flex-col items-center justify-center p-4">
    <div class="text-center fade-in" style="position: relative; z-index: 10;">
        <!-- æ¨™é¡Œ - ç™½è‰²æ–‡å­— -->
        <p class="text-3xl mb-4 font-bold text-white" style="text-shadow: 0 2px 10px rgba(0,0,0,0.3);" data-en="Gate of Stillness" data-zh="éœå¿ƒä¹‹é–€">éœå¿ƒä¹‹é–€</p>
        
        <!-- é‡‘è‰²å‘¼å¸ç’° -->
        <div class="breath-ring mb-4 mx-auto">
            <span id="breath-counter" class="text-3xl font-bold" style="color: #fbbf24;">3</span>
        </div>
        
        <!-- æ·±å‘¼å¸æç¤º - ç™½è‰² -->
        <p class="text-xl mb-5 font-medium text-white" style="text-shadow: 0 2px 8px rgba(0,0,0,0.3);" data-en="Take 3 Deep Breaths" data-zh="æ·±å‘¼å¸ä¸‰æ¬¡">æ·±å‘¼å¸ä¸‰æ¬¡</p>
        
        <!-- éœæ€èªå¡ç‰‡ - ç©ºéˆé€æ˜ -->
        <div class="jingsi-card mx-auto mb-5">
            <p class="text-2xl font-bold text-white mb-2" style="text-shadow: 0 2px 10px rgba(0,0,0,0.3);">ã€Œè¢«æ„›çš„äººï¼Œå­¸æœƒå»æ„›ã€</p>
            <p class="text-lg text-white" style="text-shadow: 0 2px 8px rgba(0,0,0,0.3);">Those who are loved, learn to love.</p>
            <p class="text-sm text-white mt-2" style="text-shadow: 0 2px 6px rgba(0,0,0,0.3);">â€” è­‰åš´æ³•å¸« éœæ€èª</p>
        </div>
        
        <!-- åˆ†æ•¸ - ç™½è‰²æ–‡å­— -->
        <div class="space-y-2 text-lg mb-6">
            <p class="font-bold text-white text-xl" style="text-shadow: 0 2px 8px rgba(0,0,0,0.3);">ğŸ‰ Level 5 Complete!</p>
            <p class="text-xl font-bold">
                <span class="text-white" style="text-shadow: 0 2px 8px rgba(0,0,0,0.3);">ğŸ˜Š <span id="final-good">0</span></span>
                <span class="text-white mx-2" style="text-shadow: 0 2px 8px rgba(0,0,0,0.3);">|</span>
                <span class="text-white" style="text-shadow: 0 2px 8px rgba(0,0,0,0.3);">ğŸ˜¢ <span id="final-sad">0</span></span>
            </p>
            <p class="text-xl font-bold text-yellow-300" style="text-shadow: 0 2px 8px rgba(0,0,0,0.3);">ELO: +<span id="elo-earned">0</span></p>
        </div>
        
        <!-- å°èˆªæŒ‰éˆ• - ä¸åŒé¡è‰² -->
        <div class="flex gap-4 justify-center flex-wrap">
            <button onclick="goToMainMenu()" class="nav-btn-home">ğŸ  <span data-en="Home" data-zh="ä¸»é ">ä¸»é </span></button>
            <button onclick="location.reload()" class="nav-btn-replay">ğŸ”„ <span data-en="Replay" data-zh="é‡ç©">é‡ç©</span></button>
            <button onclick="goToNextLevel()" class="nav-btn-next"><span data-en="Next Level" data-zh="ä¸‹ä¸€é—œ">ä¸‹ä¸€é—œ</span> â†’</button>
        </div>
    </div>
</div>

<!-- AUDIO -->
<audio id="bg-music" loop><source src="children-funny-background-spy.mp3" type="audio/mpeg"></audio>
<audio id="ataraxy-music" loop><source src="ataraxy-music.mp3" type="audio/mpeg"></audio>

<script>
let currentLang = 'zh';
let musicPlaying = false;
let state = { elo: 1500, eloEarned: 0, round: 1, maxRounds: 3, goodCount: 0, sadCount: 0, selected: [], currentVisitIndex: 0, dialogueIndex: 0 };

const characters = [
    { id: 'johnson', name: { en: 'Mr. Johnson', zh: 'Johnson å…ˆç”Ÿ' }, avatar: 'P1_MrJonson.png', location: { en: 'Park Bench', zh: 'å…¬åœ’é•·æ¤…' }, scene: 'p6_å…¬åœ’é•·æ¤…å ´æ™¯_cleaned.png',
      bayesian: { stress: { en: 'Low', zh: 'ä½' }, connection: { en: 'High', zh: 'é«˜' }, interaction: { en: 'Daily', zh: 'æ¯å¤©' }, behavior: { en: 'Normal', zh: 'æ­£å¸¸' }, probability: 15 },
      truth: 'surprise', dialogues: { zh: ['ï¼ˆJohnson å…ˆç”Ÿååœ¨é•·æ¤…ä¸Šï¼Œçœ‹è‘—é æ–¹ï¼‰', 'ã€Œå•Šï¼Œæ˜¯ä½ å•Šã€‚åå§ã€‚ã€', 'ã€Œæˆ‘æ¯å¤©éƒ½ä¾†é€™è£¡... å…¶å¯¦æ˜¯å› ç‚ºå®¶è£¡å¤ªå®‰éœäº†ã€‚ã€', 'ã€Œè€ä¼´ä¸Šå€‹æœˆèµ°äº†ï¼Œæˆ‘ä¸æƒ³è®“äººæ“”å¿ƒï¼Œæ‰€ä»¥æ¯å¤©å‡è£å¾ˆå¥½ã€‚ã€', 'ã€Œè¬è¬ä½ éä¾†ã€‚å…¶å¯¦... æˆ‘å¾ˆéœ€è¦æœ‰äººèªªèªªè©±ã€‚ã€'], en: ['(Mr. Johnson sits on the bench, gazing into the distance)', '"Oh, it\'s you. Have a seat."', '"I come here every day... actually because home is too quiet."', '"My wife passed last month. I pretend I\'m fine."', '"Thank you for coming. I really needed someone to talk to."'] },
      resultTitle: { en: 'Hidden Grief', zh: 'éš±è—çš„æ‚²å‚·' }, resultMessage: { en: 'Data can\'t see a broken heart.', zh: 'æ•¸æ“šçœ‹ä¸è¦‹ç ´ç¢çš„å¿ƒã€‚' }, insight: { en: 'P(NeedsCare|Evidence) was LOW. But some evidence is invisible.', zh: 'P(éœ€è¦é—œæ‡·|è­‰æ“š) å¾ˆä½ã€‚ä½†æœ‰äº›è­‰æ“šæ˜¯çœ‹ä¸è¦‹çš„ã€‚' } },
    { id: 'maria', name: { en: 'Maria', zh: 'Maria' }, avatar: 'P2_Maria.png', location: { en: 'Apartment', zh: 'å…¬å¯“é–€å£' }, scene: 'p_7_å…¬å¯“é–€å£å ´æ™¯.png',
      bayesian: { stress: { en: 'High', zh: 'é«˜' }, connection: { en: 'Low', zh: 'ä½' }, interaction: { en: 'Rare', zh: 'å¾ˆå°‘' }, behavior: { en: 'Rushing', zh: 'åŒ†å¿™' }, probability: 85 },
      truth: 'touching', dialogues: { zh: ['ï¼ˆMaria æŠ±è‘—å…©è¢‹èœï¼ŒåŒ†åŒ†å¿™å¿™ï¼‰', 'ã€Œæˆ‘æ²’äº‹ï¼çœŸçš„ï¼ã€', 'ï¼ˆä½ å¹«å¥¹æäº†ä¸€è¢‹èœï¼‰', 'ã€Œ...è¬è¬ã€‚ã€', 'ã€Œå…¶å¯¦æˆ‘å‰›æ‰¾åˆ°æ–°å·¥ä½œäº†ã€‚äº‹æƒ…åœ¨å¥½è½‰ã€‚ã€', 'ã€Œè¬è¬ä½ é—œå¿ƒã€‚ã€'], en: ['(Maria holds two grocery bags, rushing)', '"I\'m fine! Really!"', '(You help carry her bags)', '"...Thank you."', '"Actually, I just got a new job. Things are looking up."', '"Thank you for caring."'] },
      resultTitle: { en: 'Things Are Looking Up', zh: 'äº‹æƒ…åœ¨å¥½è½‰' }, resultMessage: { en: 'She was already on her way up.', zh: 'å¥¹å·²ç¶“åœ¨å¥½è½‰çš„è·¯ä¸Šã€‚' }, insight: { en: 'High probability â‰  intervention always needed.', zh: 'é«˜æ©Ÿç‡ â‰  ä¸€å®šè¦ä»‹å…¥ã€‚' } },
    { id: 'tane', name: { en: 'Tane', zh: 'Tane' }, avatar: 'p3_Tane.png', location: { en: 'Basketball Court', zh: 'ç±ƒçƒå ´' }, scene: 'p8_ç±ƒçƒå ´å ´æ™¯_cleaned.png',
      bayesian: { stress: { en: 'Medium', zh: 'ä¸­' }, connection: { en: 'Low', zh: 'ä½' }, interaction: { en: 'Rare', zh: 'å¾ˆå°‘' }, behavior: { en: 'Withdrawn', zh: 'é€€ç¸®' }, probability: 65 },
      truth: 'surprise', dialogues: { zh: ['ï¼ˆTane ä¸€å€‹äººååœ¨çƒå ´é‚Šï¼‰', 'ã€Œ...ã€', 'ã€Œä½ æ˜¯ç¤¾å€çš„å¿—å·¥ï¼Ÿã€', 'ã€Œ...å…¶å¯¦æˆ‘æ¯é€±éƒ½å·å·å»å¹« Johnson å…ˆç”Ÿå€’åƒåœ¾ã€‚ã€', 'ã€Œæˆ‘æƒ³å¹«å¿™ï¼Œæ€éº¼æ­£å¼åŠ å…¥ä½ å€‘ï¼Ÿã€'], en: ['(Tane sits alone by the court)', '"..."', '"You\'re a community volunteer?"', '"Actually, I secretly help Mr. Johnson every week."', '"I want to help. How can I join?"'] },
      resultTitle: { en: 'A Hidden Helper', zh: 'éš±è—çš„å¹«æ‰‹' }, resultMessage: { en: 'You found someone who wanted TO help!', zh: 'ä½ æ‰¾åˆ°äº†æƒ³è¦å¹«åŠ©åˆ¥äººçš„äººï¼' }, insight: { en: 'He was already caring for others!', zh: 'ä»–å·²ç¶“åœ¨é—œå¿ƒåˆ¥äººäº†ï¼' } },
    { id: 'chen', name: { en: 'Mrs. Chen', zh: 'é™³å¥¶å¥¶' }, avatar: 'p4_é™³å¥¶å¥¶.png', location: { en: 'Garden', zh: 'ç¤¾å€èœåœ’' }, scene: 'p9_ç¤¾å€èœåœ’å ´æ™¯_cleaned.png',
      bayesian: { stress: { en: 'Low', zh: 'ä½' }, connection: { en: 'High', zh: 'é«˜' }, interaction: { en: 'Daily', zh: 'æ¯å¤©' }, behavior: { en: 'Happy', zh: 'é–‹å¿ƒ' }, probability: 10 },
      truth: 'touching', dialogues: { zh: ['ï¼ˆé™³å¥¶å¥¶åœ¨èœåœ’è£¡æ¾†æ°´ï¼Œç¬‘ç‡ç‡çš„ï¼‰', 'ã€Œä¾†ä¾†ä¾†ï¼åƒé’èœï¼ã€', 'ã€Œæ²’äº‹æ²’äº‹ï¼æˆ‘å¾ˆå¥½ï¼ã€', 'ï¼ˆå¥¹çªç„¶å®‰éœä¸‹ä¾†ï¼‰', 'ã€Œ...å…¶å¯¦æˆ‘æ¯å¤©ä¾†é€™è£¡ï¼Œæ˜¯å› ç‚ºæƒ³å¿µå°ç£çš„å®¶ã€‚ã€', 'ã€Œé€™äº›èœï¼Œæ˜¯æˆ‘åª½åª½æ•™æˆ‘ç¨®çš„ã€‚ã€', 'ã€Œè¬è¬ä½ è½æˆ‘èªªã€‚å¾ˆä¹…æ²’äººè·Ÿæˆ‘èŠå¤©äº†ã€‚ã€'], en: ['(Mrs. Chen waters plants, smiling)', '"Come! Eat vegetables!"', '"I\'m fine!"', '(She suddenly goes quiet)', '"I come here because I miss Taiwan."', '"My mother taught me to grow these."', '"Thank you for listening."'] },
      resultTitle: { en: 'Hidden Loneliness', zh: 'éš±è—çš„å¯‚å¯' }, resultMessage: { en: 'Beneath the smile was a longing.', zh: 'ç¬‘å®¹ä¸‹æ˜¯æ€å¿µã€‚' }, insight: { en: 'Outward behavior â‰  inner state.', zh: 'å¤–é¡¯è¡Œç‚º â‰  å…§å¿ƒç‹€æ…‹ã€‚' } },
    { id: 'devon', name: { en: 'Devon', zh: 'Devon' }, avatar: 'p5_Devon.png', location: { en: 'Moving Truck', zh: 'æ¬å®¶å¡è»Šæ—' }, scene: 'p10_æ¬å®¶å ´æ™¯_cleaned.png',
      bayesian: { stress: { en: 'High', zh: 'é«˜' }, connection: { en: 'None', zh: 'ç„¡' }, interaction: { en: 'New', zh: 'æ–°ä¾†çš„' }, behavior: { en: 'Busy', zh: 'å¿™ç¢Œ' }, probability: 75 },
      truth: 'touching', dialogues: { zh: ['ï¼ˆDevon æ¬è‘—ç®±å­ï¼Œæ»¿é ­å¤§æ±—ï¼‰', 'ã€Œå˜¿ï¼éœ€è¦å¹«å¿™å—ï¼Ÿã€', 'ã€ŒçœŸçš„å¯ä»¥å—ï¼Ÿã€', 'ï¼ˆä½ å¹«ä»–æ¬äº†å¹¾å€‹ç®±å­ï¼‰', 'ã€Œè¬è¬ï¼æˆ‘å€‘å‰›æ¬ä¾†ã€‚ã€', 'ã€Œé€™å€‹ç¤¾å€æ„Ÿè¦ºå¾ˆæº«æš–ã€‚è¬è¬ä½ ï¼ã€'], en: ['(Devon carries boxes, sweating)', '"Hey! Need help?"', '"Really?"', '(You help with boxes)', '"Thanks! We just moved here."', '"This community feels warm. Thank you!"'] },
      resultTitle: { en: 'Welcome Home', zh: 'æ­¡è¿å›å®¶' }, resultMessage: { en: 'You were the first to offer.', zh: 'ä½ æ˜¯ç¬¬ä¸€å€‹ä¼¸å‡ºæ‰‹çš„äººã€‚' }, insight: { en: 'This time the data was correct!', zh: 'é€™æ¬¡æ•¸æ“šæ˜¯å°çš„ï¼' } }
];

function setLang(lang) {
    currentLang = lang;
    document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.toggle('active', (lang==='en'&&btn.textContent.trim()==='EN')||(lang==='zh'&&btn.textContent.trim()==='ä¸­æ–‡')));
    document.querySelectorAll('[data-en][data-zh]').forEach(el => el.textContent = el.getAttribute('data-'+lang));
    if(document.getElementById('game-screen').classList.contains('active')) renderCharacters();
}

function toggleMusic() {
    const bgMusic = document.getElementById('bg-music');
    const ataraxyMusic = document.getElementById('ataraxy-music');
    const btn = document.getElementById('music-btn');
    if(musicPlaying) {
        bgMusic.pause();
        ataraxyMusic.pause();
        btn.textContent = 'ğŸ”‡';
        musicPlaying = false;
    } else {
        if(document.getElementById('ataraxy-screen').classList.contains('active')) {
            ataraxyMusic.play().catch(()=>{});
        } else {
            bgMusic.play().catch(()=>{});
        }
        btn.textContent = 'ğŸ”Š';
        musicPlaying = true;
    }
}

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

function startGame() {
    const m = document.getElementById('bg-music');
    m.volume = 0.4;
    m.play().catch(()=>{});
    document.getElementById('music-btn').textContent = 'ğŸ”Š';
    musicPlaying = true;
    showScreen('game-screen');
    renderCharacters();
}

function renderCharacters() {
    const g = document.getElementById('characters-grid');
    g.innerHTML = characters.map(c => `
        <div class="character-card ${state.selected.includes(c.id)?'selected':''}" id="char-${c.id}" onclick="selectCharacter('${c.id}')" onmouseenter="showBayesian('${c.id}')">
            <img src="${c.avatar}" class="character-avatar mx-auto mb-2" alt="${c.name[currentLang]}">
            <h3 class="font-bold text-gray-800 text-center text-sm">${c.name[currentLang]}</h3>
            <p class="text-xs text-gray-500 text-center mb-2">${c.location[currentLang]}</p>
            <div class="mb-2">
                <div class="prob-bar-container">
                    <div class="prob-bar-fill" style="width:${c.bayesian.probability}%"></div>
                    <div class="prob-indicator" style="left:${c.bayesian.probability}%">ğŸ’—</div>
                </div>
                <p class="text-center text-sm mt-1 font-bold" style="color:${getProbColor(c.bayesian.probability)}">${c.bayesian.probability}%</p>
            </div>
            ${c.bayesian.probability < 30 ? `<button class="btn-override w-full" onclick="event.stopPropagation();overrideSelect('${c.id}')">âš ï¸ Override</button>` : ''}
        </div>
    `).join('');
}

function getProbColor(p) { return p >= 70 ? '#ef4444' : p >= 40 ? '#f59e0b' : '#22c55e'; }

function showBayesian(id) {
    const c = characters.find(x => x.id === id);
    if(!c) return;
    document.getElementById('bn-stress').textContent = c.bayesian.stress[currentLang];
    document.getElementById('bn-connection').textContent = c.bayesian.connection[currentLang];
    document.getElementById('bn-interaction').textContent = c.bayesian.interaction[currentLang];
    document.getElementById('bn-behavior').textContent = c.bayesian.behavior[currentLang];
    const p = document.getElementById('bn-probability');
    p.textContent = c.bayesian.probability + '%';
    p.style.color = getProbColor(c.bayesian.probability);
}

function selectCharacter(id) {
    const card = document.getElementById('char-' + id);
    const idx = state.selected.indexOf(id);
    if(idx > -1) {
        state.selected.splice(idx, 1);
        card.classList.remove('selected');
    } else if(state.selected.length < 3) {
        state.selected.push(id);
        card.classList.add('selected');
    }
    document.getElementById('selected-count').textContent = state.selected.length;
    document.getElementById('visit-btn').disabled = state.selected.length === 0;
}

function overrideSelect(id) {
    if(!state.selected.includes(id)) {
        if(state.selected.length >= 3) {
            const r = state.selected.shift();
            document.getElementById('char-' + r).classList.remove('selected');
        }
        state.selected.push(id);
        document.getElementById('char-' + id).classList.add('selected');
        document.getElementById('selected-count').textContent = state.selected.length;
        document.getElementById('visit-btn').disabled = false;
    }
}

function clearSelection() {
    state.selected.forEach(id => {
        const card = document.getElementById('char-' + id);
        if(card) card.classList.remove('selected');
    });
    state.selected = [];
    document.getElementById('selected-count').textContent = 0;
    document.getElementById('visit-btn').disabled = true;
}

function goBackToSelect() {
    showScreen('game-screen');
    renderCharacters();
}

function confirmVisit() { state.currentVisitIndex = 0; state.dialogueIndex = 0; startVisit(); }

function startVisit() {
    const id = state.selected[state.currentVisitIndex];
    const c = characters.find(x => x.id === id);
    const vs = document.getElementById('visit-screen');
    vs.style.background = `url('${c.scene}') center center/cover no-repeat`;
    vs.style.backgroundColor = '#fef3c7';
    document.getElementById('visit-avatar').src = c.avatar;
    document.getElementById('visit-name').textContent = c.name[currentLang];
    document.getElementById('visit-location').textContent = c.location[currentLang];
    document.getElementById('dialogue-text').textContent = c.dialogues[currentLang][0];
    state.dialogueIndex = 0;
    showScreen('visit-screen');
}

function nextDialogue() {
    const id = state.selected[state.currentVisitIndex];
    const c = characters.find(x => x.id === id);
    state.dialogueIndex++;
    if(state.dialogueIndex < c.dialogues[currentLang].length) {
        document.getElementById('dialogue-text').textContent = c.dialogues[currentLang][state.dialogueIndex];
    } else {
        showResult(c);
    }
}

function showResult(c) {
    const override = c.bayesian.probability < 30;
    let elo = override && c.truth === 'surprise' ? 50 : c.truth === 'surprise' ? 30 : 20;
    state.elo += elo;
    state.eloEarned += elo;
    state.goodCount++;
    
    document.getElementById('result-card').className = 'result-card ' + c.truth + ' slide-up';
    document.getElementById('result-emoji').textContent = c.truth === 'surprise' ? 'ğŸ˜®' : 'ğŸ¥¹';
    document.getElementById('result-title').textContent = c.resultTitle[currentLang];
    document.getElementById('result-message').textContent = c.resultMessage[currentLang];
    document.getElementById('result-insight').textContent = c.insight[currentLang];
    document.getElementById('result-elo').textContent = '+' + elo + ' ELO';
    document.getElementById('result-overlay').style.display = 'flex';
    
    if(typeof confetti === 'function') confetti({ particleCount: 60, spread: 70, origin: { y: 0.7 } });
}

function nextRound() {
    document.getElementById('result-overlay').style.display = 'none';
    state.currentVisitIndex++;
    if(state.currentVisitIndex < state.selected.length) {
        state.dialogueIndex = 0;
        startVisit();
    } else {
        state.round++;
        state.selected = [];
        document.getElementById('elo-display').textContent = state.elo;
        document.getElementById('good-count').textContent = state.goodCount;
        if(state.round > state.maxRounds) {
            completeLevel();
        } else {
            document.getElementById('round-display').textContent = state.round;
            showScreen('game-screen');
            renderCharacters();
        }
    }
}

function completeLevel() {
    // åˆ‡æ›åˆ°éœå¿ƒéŸ³æ¨‚
    document.getElementById('bg-music').pause();
    const ataraxyMusic = document.getElementById('ataraxy-music');
    ataraxyMusic.volume = 0.5;
    if(musicPlaying) ataraxyMusic.play().catch(()=>{});
    
    document.getElementById('final-good').textContent = state.goodCount;
    document.getElementById('final-sad').textContent = state.sadCount;
    document.getElementById('elo-earned').textContent = state.eloEarned;
    showScreen('ataraxy-screen');
    startBreathing();
    if(typeof confetti === 'function') setTimeout(() => confetti({ particleCount: 150, spread: 100, origin: { y: 0.5 } }), 800);
}

function startBreathing() {
    let c = 3;
    const e = document.getElementById('breath-counter');
    e.textContent = '3';
    const t = setInterval(() => {
        c--;
        if(c > 0) e.textContent = c;
        else { clearInterval(t); e.textContent = 'ğŸ™'; }
    }, 2500);
}

function goToMainMenu() {
    document.getElementById('ataraxy-music').pause();
    window.location.href = '../index.html';
}
function goToPrevLevel() {
    document.getElementById('ataraxy-music').pause();
    window.location.href = '../level4/index.html';
}
function goToNextLevel() {
    document.getElementById('ataraxy-music').pause();
    window.location.href = '../level6/index.html';
}

// BOTTOM NAVIGATION
function navHome() { goToMainMenu(); }
function navPrev() { goToPrevLevel(); }
function navNext() { goToNextLevel(); }
function navReplayStory() {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('intro-screen').classList.add('active');
}

document.addEventListener('DOMContentLoaded', () => setLang('zh'));
</script>

<nav class="bottom-nav">
    <button class="bnav-btn" onclick="navHome()"><span class="nav-icon">ğŸ </span><span>ä¸»é </span></button>
    <button class="bnav-btn" onclick="navPrev()"><span class="nav-icon">â¬…ï¸</span><span>ä¸Šä¸€é—œ</span></button>
    <button class="bnav-btn" onclick="navNext()"><span class="nav-icon">â¡ï¸</span><span>ä¸‹ä¸€é—œ</span></button>
    <button class="bnav-btn" onclick="navReplayStory()"><span class="nav-icon">ğŸ¬</span><span>é‡è½æ•…äº‹</span></button>
</nav>

</body>
</html>
