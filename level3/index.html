<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google" content="notranslate">
    <title>ÂñÑÁöÑÊóÖÁ®ã Level 3: MDP | Sister Maya ÁöÑÊïÖ‰∫ã</title>
    
    <!-- Audio Files -->
    <audio id="bgMusic" loop>
        <source src="stage3.mp3" type="audio/mpeg">
    </audio>
    <audio id="meditationMusic" loop>
        <source src="AnaCaptainslogue_-_Noir_Et_Blanc_Vie.mp3" type="audio/mpeg">
    </audio>
    <audio id="levelUpSound">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdH2LkZeUj4J0ZFtXXWVvfIiRl5aOgXJkWVVbY3B9iZKYlo+CdGVbV11lcH2IkZeWjoFyZFpVW2NwfYmSmJaPgnRlW1ddZXB9iJGXlo6BcmRaVVtjcH2JkpiWj4J0ZVtXXWVwfYiRl5aOgXJkWlVbY3B9iZKYlo+CdGVbV11lcH2IkZeWjoFyZFpVW2NwfQ==" type="audio/wav">
    </audio>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Noto Sans TC', sans-serif; box-sizing: border-box; margin: 0; padding: 0; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        :root {
            --warm-gold: #f59e0b;
            --soft-green: #10b981;
            --calm-blue: #3b82f6;
            --gentle-purple: #8b5cf6;
            --warm-pink: #ec4899;
        }
        
        .screen { display: none; min-height: 100vh; position: relative; }
        .screen.active { display: flex; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 20px rgba(245, 158, 11, 0.3); } 50% { box-shadow: 0 0 40px rgba(245, 158, 11, 0.6); } }
        @keyframes breathe { 0%, 100% { transform: scale(0.95); opacity: 0.7; } 50% { transform: scale(1.05); opacity: 1; } }
        
        .fade-in { animation: fadeIn 0.6s ease-out; }
        .pulse { animation: pulse 2s infinite; }
        .glow { animation: glow 3s infinite; }
        .breathe { animation: breathe 4s ease-in-out infinite; }
        
        .bg-warm {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 50%, #3d5a7f 100%);
        }
        
        /* Scene background - FULL VISIBILITY */
        .scene-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            opacity: 0.95;
            z-index: 0;
            transition: background-image 0.5s ease;
        }
        
        .game-content {
            position: relative;
            z-index: 1;
        }
        
        /* Journey path */
        .journey-path {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 20px;
            flex-wrap: wrap;
        }
        
        .stage-node {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            transition: all 0.3s;
            border: 3px solid rgba(255,255,255,0.35);
            background: rgba(255,255,255,0.1);
            cursor: pointer;
        }
        
        .stage-node.current {
            background: linear-gradient(135deg, var(--warm-gold), #fbbf24);
            border-color: white;
            transform: scale(1.15);
            box-shadow: 0 0 30px rgba(245, 158, 11, 0.6);
        }
        
        .stage-node.completed {
            background: linear-gradient(135deg, var(--soft-green), #34d399);
            border-color: rgba(255,255,255,0.8);
        }
        
        .stage-node.locked {
            opacity: 0.4;
            background: rgba(255,255,255,0.05);
        }
        
        .stage-label {
            font-size: 10px;
            color: white;
            text-align: center;
            margin-top: 6px;
        }
        
        .path-connector {
            width: 30px;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
        }
        
        .path-connector.active {
            background: linear-gradient(90deg, var(--soft-green), var(--warm-gold));
        }
        
        /* Action cards - GLASS EFFECT */
        .action-card {
            background: rgba(30, 50, 80, 0.2);
            backdrop-filter: blur(3px);
            border-radius: 16px;
            padding: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            cursor: pointer;
            transition: all 0.3s;
            min-width: 140px;
            text-align: center;
        }
        
        .action-card:hover {
            transform: translateY(-5px);
            border-color: var(--warm-gold);
            background: rgba(245, 158, 11, 0.15);
        }
        
        .action-card.selected {
            border-color: var(--warm-gold);
            background: rgba(245, 158, 11, 0.25);
        }
        
        .action-icon { font-size: 2.5rem; margin-bottom: 10px; }
        
        /* Info panel - GLASS EFFECT - very transparent */
        .info-panel {
            background: rgba(20, 40, 70, 0.2);
            backdrop-filter: blur(4px);
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.25);
            padding: 15px;
            color: white;
        }
        
        .value-display {
            background: rgba(20, 40, 70, 0.15);
            border-radius: 12px;
            padding: 15px;
            font-family: 'JetBrains Mono', monospace;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .bellman-box {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.35), rgba(59, 130, 246, 0.35));
            border: 2px solid rgba(251, 191, 36, 0.5);
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            backdrop-filter: blur(4px);
        }
        
        /* Buttons */
        .btn {
            padding: 12px 28px;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            font-size: 14px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--warm-gold), #fbbf24);
            color: #1e3a5f;
        }
        
        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(245, 158, 11, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.4);
        }
        
        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* Story panel - GLASS EFFECT */
        .story-panel {
            background: rgba(20, 40, 70, 0.25);
            backdrop-filter: blur(6px);
            border-radius: 20px;
            border: 2px solid rgba(251, 191, 36, 0.4);
            padding: 25px;
            max-width: 600px;
            color: white;
        }
        
        /* Meditation styles */
        .breath-ring {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            border: 5px solid #fbbf24;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.6), 0 0 40px rgba(251, 191, 36, 0.3);
            animation: breathe 4s ease-in-out infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(5px);
        }
        
        .jingsi-card {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.25), rgba(168, 85, 247, 0.15));
            backdrop-filter: blur(8px);
            border-radius: 20px;
            padding: 30px 40px;
            border: 2px solid rgba(251, 191, 36, 0.5);
            text-align: center;
        }
        
        /* Language toggle */
        .lang-toggle { display: flex; gap: 8px; }
        
        .lang-btn {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            background: rgba(255,255,255,0.15);
            color: white;
        }
        
        .lang-btn.active {
            background: var(--warm-gold);
            color: #1e3a5f;
        }
        
        .lang-btn:not(.active) {
            border-color: rgba(255,255,255,0.3);
        }
        
        /* Music button */
        .music-btn {
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.15);
        }
        
        .music-btn.playing {
            background: var(--soft-green);
            border-color: var(--soft-green);
        }
        
        /* Probability bar */
        .prob-bar {
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .prob-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s;
        }
        
        /* ELO badge */
        .elo-badge {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #1e3a5f;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .stage-node { width: 60px; height: 60px; font-size: 1.5rem; }
            .action-card { min-width: 100px; padding: 15px; }
        }
    </style>
</head>
<body class="bg-warm text-white overflow-x-hidden">

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN 1: INTRO
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="intro-screen" class="screen active flex-col items-center justify-center p-6" style="background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 100%);">
    <div class="text-center fade-in">
        <!-- Controls -->
        <div class="flex justify-center gap-4 mb-6">
            <div class="lang-toggle">
                <button class="lang-btn active" onclick="setLanguage('en')" data-lang="en">EN</button>
                <button class="lang-btn" onclick="setLanguage('zh')" data-lang="zh">‰∏≠Êñá</button>
                <button class="lang-btn" onclick="setLanguage('es')" data-lang="es">ES</button>
            </div>
            <button onclick="toggleMusic()" class="music-btn" id="intro-music-btn">üîá</button>
        </div>
        
        <h1 class="text-4xl font-bold mb-4" style="text-shadow: 0 0 30px rgba(245, 158, 11, 0.5);">
            üå± <span class="lang-text" data-en="Level 3: MDP" data-zh="Á¨¨‰∏âÈóúÔºöMDP" data-es="Nivel 3: MDP">Level 3: MDP</span>
        </h1>
        <h2 class="text-2xl text-yellow-300 mb-4 lang-text" data-en="Sister Maya's Journey" data-zh="Áë™ÈõÖÂ∏´ÂßäÁöÑÊïÖ‰∫ã" data-es="El Viaje de la Hermana Maya">Sister Maya's Journey</h2>
        <p class="text-white/80 mb-6 lang-text" data-en="A Story of Transformation" data-zh="‰∏ÄÂÄãËΩâËÆäÁöÑÊïÖ‰∫ã" data-es="Una Historia de Transformaci√≥n">A Story of Transformation</p>
        
        <div class="story-panel mx-auto mb-8 text-left">
            <div class="flex items-center gap-4 mb-4">
                <div class="w-20 h-20 rounded-full bg-gradient-to-br from-yellow-400 to-orange-500 flex items-center justify-center text-4xl">üë©üèø</div>
                <div>
                    <h3 class="text-yellow-300 font-bold text-lg">Sister Maya</h3>
                    <p class="text-white/70 text-sm lang-text" data-en="First Local Commissioner from Hunters Point" data-zh="Áçµ‰∫∫ËßíÁ¨¨‰∏Ä‰ΩçÊú¨ÂúüÂ•≥ÂßîÂì°" data-es="Primera Comisionada Local de Hunters Point">First Local Commissioner from Hunters Point</p>
                </div>
            </div>
            <p class="text-lg leading-relaxed mb-4 lang-text" data-en="Maya first came to Tzu Chi's food distribution as a single mother seeking help. She never imagined she would one day become a Commissioner ‚Äî leading the very program that once helped her. This is her story of growth, choice by choice." data-zh="Áë™ÈõÖÁ¨¨‰∏ÄÊ¨°‰æÜÊÖàÊøüÈ£üÁâ©ÁôºÊîæÊôÇÔºåÊòØ‰∏Ä‰ΩçÂ∞ãÊ±ÇÂπ´Âä©ÁöÑÂñÆË¶™Â™ΩÂ™Ω„ÄÇÂ•πÂæûÊú™ÊÉ≥ÈÅéÊúâ‰∏ÄÂ§©ÊúÉÊàêÁÇ∫ÂßîÂì°‚Äî‚ÄîÂ∏∂È†òÁï∂ÂàùÂπ´Âä©Â•πÁöÑÈÄôÂÄãË®àÁï´„ÄÇÈÄôÊòØÂ•π‰∏ÄÊ≠•‰∏ÄÊ≠•ÊàêÈï∑ÁöÑÊïÖ‰∫ã„ÄÇ" data-es="Maya lleg√≥ por primera vez a la distribuci√≥n de alimentos de Tzu Chi como madre soltera buscando ayuda. Nunca imagin√≥ que un d√≠a se convertir√≠a en Comisionada ‚Äî liderando el mismo programa que una vez la ayud√≥. Esta es su historia de crecimiento, elecci√≥n por elecci√≥n.">Maya first came to Tzu Chi's food distribution as a single mother seeking help. She never imagined she would one day become a Commissioner ‚Äî leading the very program that once helped her. This is her story of growth, choice by choice.</p>
            <p class="text-yellow-300 text-center italic text-lg lang-text" data-en="„ÄåWilling to do, happy to receive„Äç" data-zh="„ÄåÁîòÈ°òÂÅöÔºåÊ≠°ÂñúÂèó„Äç" data-es="„ÄåDispuesto a hacer, feliz de recibir„Äç">„ÄåWilling to do, happy to receive„Äç</p>
        </div>
        
        <div class="info-panel mx-auto mb-6" style="max-width: 500px; background: rgba(139, 92, 246, 0.25);">
            <p class="text-purple-200 text-sm lang-text" data-en="‚ö†Ô∏è This is a fictional story inspired by real volunteers. Names and timelines are created for educational purposes." data-zh="‚ö†Ô∏è ÈÄôÊòØ‰∏ÄÂÄãËôõÊßãÊïÖ‰∫ãÔºåÈùàÊÑü‰æÜËá™ÁúüÂØ¶ÂøóÂ∑•„ÄÇÂßìÂêçÂíåÊôÇÈñìÁ∑öÁÇ∫ÊïôËÇ≤ÁõÆÁöÑËÄåÂâµ‰Ωú„ÄÇ" data-es="‚ö†Ô∏è Esta es una historia ficticia inspirada en voluntarios reales. Los nombres y l√≠neas de tiempo se crearon con fines educativos.">‚ö†Ô∏è This is a fictional story inspired by real volunteers. Names and timelines are created for educational purposes.</p>
        </div>
        
        <p class="text-sm text-white/70 mb-6 lang-text" data-en="Learn how MDP (Markov Decision Process) models decision-making under uncertainty" data-zh="Â≠∏Áøí MDPÔºàÈ¶¨ÂèØÂ§´Ê±∫Á≠ñÈÅéÁ®ãÔºâÂ¶Ç‰ΩïÂú®‰∏çÁ¢∫ÂÆöÊÄß‰∏ãÂÅöÊ±∫Á≠ñ" data-es="Aprende c√≥mo MDP (Proceso de Decisi√≥n de Markov) modela la toma de decisiones bajo incertidumbre">Learn how MDP (Markov Decision Process) models decision-making under uncertainty</p>
        
        <button onclick="startGame()" class="btn btn-primary text-lg glow">
            <span class="lang-text" data-en="Begin Maya's Journey üöÄ" data-zh="ÈñãÂßãÁë™ÈõÖÁöÑÊóÖÁ®ã üöÄ" data-es="Comenzar el Viaje de Maya üöÄ">Begin Maya's Journey üöÄ</span>
        </button>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN 2: GAME
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="game-screen" class="screen flex-col bg-warm" style="position: relative;">
    <!-- Scene Background -->
    <div class="scene-bg" id="scene-background"></div>
    
    <!-- Header -->
    <div class="flex justify-between items-center p-4 game-content" style="background: rgba(20, 40, 70, 0.25); backdrop-filter: blur(4px);">
        <button onclick="goBack()" class="text-white/80 hover:text-white">
            ‚Üê <span class="lang-text" data-en="Menu" data-zh="ÈÅ∏ÂñÆ" data-es="Men√∫">Menu</span>
        </button>
        <div class="text-center">
            <div class="text-lg font-bold">üå± Level 3: MDP</div>
            <div class="text-xs text-yellow-300 lang-text" data-en="Sister Maya's Journey" data-zh="Áë™ÈõÖÂ∏´ÂßäÁöÑÊïÖ‰∫ã" data-es="El Viaje de la Hermana Maya">Sister Maya's Journey</div>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="toggleMusic()" class="music-btn" id="game-music-btn">üîá</button>
            <div class="elo-badge">‚≠ê <span id="elo-display">1200</span></div>
            <div class="lang-toggle">
                <button class="lang-btn active" onclick="setLanguage('en')" data-lang="en">EN</button>
                <button class="lang-btn" onclick="setLanguage('zh')" data-lang="zh">‰∏≠Êñá</button>
                <button class="lang-btn" onclick="setLanguage('es')" data-lang="es">ES</button>
            </div>
        </div>
    </div>
    
    <!-- Main Game Area -->
    <div class="flex-1 flex flex-col lg:flex-row gap-4 p-4 overflow-auto game-content">
        <!-- Left: Journey Visualization -->
        <div class="lg:w-2/3 flex flex-col gap-4">
            <!-- Journey Path -->
            <div class="info-panel">
                <h3 class="text-yellow-300 font-bold mb-3">üó∫Ô∏è <span class="lang-text" data-en="Your Journey" data-zh="‰Ω†ÁöÑÊóÖÁ®ã" data-es="Tu Viaje">Your Journey</span></h3>
                <div class="journey-path" id="journey-path"></div>
            </div>
            
            <!-- Current Situation -->
            <div class="info-panel flex-1">
                <h3 class="text-yellow-300 font-bold mb-3">üìç <span class="lang-text" data-en="Current Situation" data-zh="ÁõÆÂâçÁãÄÊ≥Å" data-es="Situaci√≥n Actual">Current Situation</span></h3>
                <div id="situation-text" class="text-lg mb-4"></div>
                
                <h4 class="text-blue-300 font-bold mb-3">üéØ <span class="lang-text" data-en="Choose Your Action" data-zh="ÈÅ∏Êìá‰Ω†ÁöÑË°åÂãï" data-es="Elige Tu Acci√≥n">Choose Your Action</span></h4>
                <div class="flex flex-wrap gap-4 justify-center" id="action-cards"></div>
                
                <div class="mt-4 text-center">
                    <button onclick="executeAction()" class="btn btn-primary" id="execute-btn" disabled>
                        <span class="lang-text" data-en="Make Decision" data-zh="ÂÅöÂá∫Ê±∫ÂÆö" data-es="Tomar Decisi√≥n">Make Decision</span>
                    </button>
                </div>
            </div>
            
            <!-- Story/Result Panel -->
            <div class="info-panel" id="story-panel" style="display:none;">
                <div id="story-content" class="text-center"></div>
            </div>
        </div>
        
        <!-- Right: MDP Visualization -->
        <div class="lg:w-1/3 flex flex-col gap-4">
            <div class="info-panel">
                <h3 class="text-purple-300 font-bold mb-2">üß† <span class="lang-text" data-en="MDP Components" data-zh="MDP ÂÖÉ‰ª∂" data-es="Componentes MDP">MDP Components</span></h3>
                <div class="text-sm space-y-2">
                    <div><span class="text-yellow-300">S</span> = <span class="lang-text" data-en="States (growth stages)" data-zh="ÁãÄÊÖãÔºàÊàêÈï∑ÈöéÊÆµÔºâ" data-es="Estados (etapas de crecimiento)">States (growth stages)</span></div>
                    <div><span class="text-green-300">A</span> = <span class="lang-text" data-en="Actions (your choices)" data-zh="Âãï‰ΩúÔºà‰Ω†ÁöÑÈÅ∏ÊìáÔºâ" data-es="Acciones (tus elecciones)">Actions (your choices)</span></div>
                    <div><span class="text-blue-300">P</span> = <span class="lang-text" data-en="Probability (uncertainty)" data-zh="Ê©üÁéáÔºà‰∏çÁ¢∫ÂÆöÊÄßÔºâ" data-es="Probabilidad (incertidumbre)">Probability (uncertainty)</span></div>
                    <div><span class="text-pink-300">R</span> = <span class="lang-text" data-en="Reward (inner joy)" data-zh="ÁçéÂãµÔºàÂÖßÂøÉÂñúÊÇÖÔºâ" data-es="Recompensa (alegr√≠a interior)">Reward (inner joy)</span></div>
                    <div><span class="text-orange-300">Œ≥</span> = <span class="lang-text" data-en="Discount (0.9)" data-zh="ÊäòÊâ£Âõ†Â≠ê (0.9)" data-es="Descuento (0.9)">Discount (0.9)</span></div>
                </div>
            </div>
            
            <div class="bellman-box">
                <h4 class="text-purple-300 font-bold mb-2">üìê Bellman Equation</h4>
                <div class="mono text-sm text-center" style="color:#fef3c7; text-shadow: 0 0 10px rgba(251, 191, 36, 0.5);">V*(s) = max<sub>a</sub> Œ£ P(s'|s,a)[R + Œ≥V*(s')]</div>
                <p class="text-xs text-yellow-100/90 mt-2 text-center lang-text" data-en="Optimal value = best action's expected reward + future value" data-zh="ÊúÄÂÑ™ÂÉπÂÄº = ÊúÄ‰Ω≥Ë°åÂãïÁöÑÊúüÊúõÁçéÂãµ + Êú™‰æÜÂÉπÂÄº" data-es="Valor √≥ptimo = recompensa esperada de la mejor acci√≥n + valor futuro">Optimal value = best action's expected reward + future value</p>
            </div>
            
            <div class="info-panel flex-1">
                <h3 class="text-blue-300 font-bold mb-2">üìä <span class="lang-text" data-en="Value Iteration" data-zh="ÂÉπÂÄºËø≠‰ª£" data-es="Iteraci√≥n de Valor">Value Iteration</span></h3>
                <div class="value-display text-xs" id="value-display"></div>
            </div>
            
            <div class="info-panel">
                <h3 class="text-green-300 font-bold mb-2">üìà <span class="lang-text" data-en="Statistics" data-zh="Áµ±Ë®à" data-es="Estad√≠sticas">Statistics</span></h3>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div><span class="lang-text" data-en="Week" data-zh="ÈÄ±Êï∏" data-es="Semana">Week</span>: <span id="week-display" class="text-yellow-300">1</span></div>
                    <div><span class="lang-text" data-en="Stage" data-zh="ÈöéÊÆµ" data-es="Etapa">Stage</span>: <span id="stage-display" class="text-green-300">1/6</span></div>
                    <div><span class="lang-text" data-en="Joy" data-zh="ÂñúÊÇÖ" data-es="Alegr√≠a">Joy</span>: <span id="joy-display" class="text-pink-300">0</span></div>
                    <div><span class="lang-text" data-en="Impact" data-zh="ÂΩ±Èüø" data-es="Impacto">Impact</span>: <span id="impact-display" class="text-blue-300">0</span></div>
                </div>
            </div>
            
            <div class="info-panel" style="background:rgba(236, 72, 153, 0.15);border-color:rgba(236, 72, 153, 0.4);">
                <div class="text-pink-300 font-bold text-sm">üìê Russell & Norvig Ch. 17</div>
                <div class="text-xs mt-1">‚Ä¢ Markov Decision Processes<br>‚Ä¢ Value Iteration Algorithm<br>‚Ä¢ Bellman Optimality Equation</div>
            </div>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN 3: MEDITATION GATE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="meditation-screen" class="screen flex-col items-center justify-center p-6" style="background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);">
    <div class="absolute inset-0" style="background: url('L3_p7_lotus_.png') center center/cover no-repeat; opacity: 0.85;"></div>
    
    <div class="relative z-10 text-center">
        <h2 class="text-3xl font-bold text-white mb-8 lang-text" style="text-shadow: 0 0 30px rgba(251, 191, 36, 0.8);" data-en="Ataraxy Portico" data-zh="ÈùúÂøÉ‰πãÈñÄ" data-es="Portal de Serenidad">ÈùúÂøÉ‰πãÈñÄ</h2>
        
        <div class="breath-ring mx-auto mb-6">
            <span id="breath-counter" class="text-2xl font-bold mono" style="color: #fbbf24; text-shadow: 0 0 10px #000, 0 0 20px #000, 0 0 30px rgba(251, 191, 36, 0.8); transition: transform 0.5s ease-in-out;">Ê∫ñÂÇô...</span>
        </div>
        
        <p id="breath-instruction" class="text-xl mb-8 font-bold" style="color: #fcd34d; text-shadow: 0 0 10px #000, 0 0 20px #000;">Ë∑üÈö®ÂëºÂê∏...</p>
        
        <div class="jingsi-card max-w-lg mx-auto mb-8">
            <p class="text-xl font-bold text-yellow-300 mb-3 lang-text" data-en="„ÄåWilling to do, happy to receive„Äç" data-zh="„ÄåÁîòÈ°òÂÅöÔºåÊ≠°ÂñúÂèó„Äç" data-es="„ÄåDispuesto a hacer, feliz de recibir„Äç">„ÄåWilling to do, happy to receive„Äç</p>
            <p class="text-white/90 mb-4 lang-text" data-en="Maya's journey shows us: every choice matters. From receiving help to giving it ‚Äî transformation happens one decision at a time." data-zh="Áë™ÈõÖÁöÑÊóÖÁ®ãÂëäË®¥ÊàëÂÄëÔºöÊØèÂÄãÈÅ∏ÊìáÈÉΩÈáçË¶Å„ÄÇÂæûÊé•ÂèóÂπ´Âä©Âà∞‰ªòÂá∫Âπ´Âä©‚Äî‚ÄîËΩâËÆäÊòØ‰∏ÄÂÄãÊ±∫ÂÆö‰∏ÄÂÄãÊ±∫ÂÆöÁ¥ØÁ©çÁöÑ„ÄÇ" data-es="El viaje de Maya nos muestra: cada elecci√≥n importa. De recibir ayuda a darla ‚Äî la transformaci√≥n sucede una decisi√≥n a la vez.">Maya's journey shows us: every choice matters. From receiving help to giving it ‚Äî transformation happens one decision at a time.</p>
            <p class="text-purple-200 text-sm lang-text" data-en="‚Äî Master Cheng Yen" data-zh="‚Äî Ë≠âÂö¥‰∏ä‰∫∫" data-es="‚Äî Maestra Cheng Yen">‚Äî Master Cheng Yen</p>
        </div>
        
        <div class="info-panel mx-auto mb-6" style="max-width: 500px; background: rgba(0,0,0,0.25);">
            <p class="text-sm text-white/90 lang-text" data-en="üß† MDP Insight: The algorithm modeled Maya's decisions, but her real journey was shaped by agency, relationships, and choices no probability can fully capture." data-zh="üß† MDP ÂèçÊÄùÔºöÊºîÁÆóÊ≥ïÊ®°Êì¨‰∫ÜÁë™ÈõÖÁöÑÊ±∫Á≠ñÔºå‰ΩÜÂ•πÁúüÊ≠£ÁöÑÊóÖÁ®ãÊòØÁî±‰∏ªÈ´îÊÄß„ÄÅÈóú‰øÇÂíåÈÅ∏ÊìáÂ°ëÈÄ†ÁöÑ‚Äî‚ÄîÈÄô‰∫õÊòØÊ©üÁéáÁÑ°Ê≥ïÂÆåÂÖ®ÊçïÊçâÁöÑ„ÄÇ" data-es="üß† Reflexi√≥n MDP: El algoritmo model√≥ las decisiones de Maya, pero su verdadero viaje fue moldeado por la voluntad, las relaciones y las elecciones que ninguna probabilidad puede capturar completamente.">üß† MDP Insight: The algorithm modeled Maya's decisions, but her real journey was shaped by agency, relationships, and choices no probability can fully capture.</p>
        </div>
        
        <div class="flex flex-wrap gap-4 justify-center">
            <button onclick="goToMainMenu()" class="btn btn-secondary lang-text" data-en="üè† Main Menu" data-zh="üè† ‰∏ªÈ†ÅÈù¢" data-es="üè† Men√∫">üè† Main Menu</button>
            <button onclick="backToGame()" class="btn btn-secondary lang-text" data-en="‚Üê Play Again" data-zh="‚Üê ÂÜçÁé©‰∏ÄÊ¨°" data-es="‚Üê Jugar de nuevo">‚Üê Play Again</button>
            <button onclick="goToNextLevel()" class="btn btn-primary lang-text" data-en="Level 4: KB-Agent ‚Üí" data-zh="Á¨¨ÂõõÈóúÔºöKB-Agent ‚Üí" data-es="Nivel 4: KB-Agent ‚Üí">Level 4: KB-Agent ‚Üí</button>
        </div>
    </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIGURATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentLang = 'en';
let currentStage = 0;
let selectedAction = null;
let musicPlaying = false;
let gameStats = { week: 1, joy: 0, impact: 0, elo: 1200 };

const bgMusic = document.getElementById('bgMusic');
const meditationMusic = document.getElementById('meditationMusic');
const levelUpSound = document.getElementById('levelUpSound');

// MDP States
const STAGES = [
    { id: 'newcomer', emoji: 'üëÄ', en: 'Newcomer', zh: 'Êñ∞ÊúãÂèã', es: 'Novato', value: 0, bg: 'L3_p1.png' },
    { id: 'curious', emoji: 'ü§î', en: 'Curious', zh: 'Â•ΩÂ•áËÄÖ', es: 'Curioso', value: 2, bg: 'L3_p2.png' },
    { id: 'helper', emoji: 'ü§ù', en: 'Helper', zh: 'Âπ´Êâã', es: 'Ayudante', value: 5, bg: 'L3_p3.png' },
    { id: 'regular', emoji: 'üí™', en: 'Regular', zh: 'Â∏∏ÂÆ¢', es: 'Regular', value: 10, bg: 'L3_p4.png' },
    { id: 'mentor', emoji: 'üåü', en: 'Mentor', zh: 'Â∞éÂ∏´', es: 'Mentor', value: 18, bg: 'L3_p5.png' },
    { id: 'leader', emoji: 'üéì', en: 'Leader', zh: 'È†òË¢ñ', es: 'L√≠der', value: 30, bg: 'L3_p6.png' }
];

// Situations
const SITUATIONS = {
    newcomer: {
        en: "It's a Saturday morning in Hunters Point. Maya, a single mother, has heard about Tzu Chi's food distribution. She hesitates outside the community center, watching volunteers in blue vests setting up tables with fresh vegetables...",
        zh: "Áçµ‰∫∫ËßíÁöÑ‰∏ÄÂÄãÈÄ±ÂÖ≠Êó©Êô®„ÄÇÂñÆË¶™Â™ΩÂ™ΩÁë™ÈõÖËÅΩË™™ÊÖàÊøüÂú®ÁôºÊîæÈ£üÁâ©„ÄÇÂ•πÂú®Á§æÂçÄ‰∏≠ÂøÉÂ§ñÈù¢Áå∂Ë±´ËëóÔºåÁúãËëóÁ©øËóçËâ≤ËÉåÂøÉÁöÑÂøóÂ∑•ÂÄëÊì∫ÊîæÊñ∞ÈÆÆËî¨Ëèú...",
        es: "Es una ma√±ana de s√°bado en Hunters Point. Maya, madre soltera, escuch√≥ sobre la distribuci√≥n de alimentos de Tzu Chi. Duda afuera del centro comunitario, observando a los voluntarios con chalecos azules preparando mesas con vegetales frescos..."
    },
    curious: {
        en: "Maya came back the next week. A warm volunteer named Sister Roxanne noticed her watching. 'Would you like to help sort these tomatoes? Many hands make light work!' No pressure, just a gentle invitation...",
        zh: "Áë™ÈõÖ‰∏ãÈÄ±Âèà‰æÜ‰∫Ü„ÄÇ‰∏Ä‰ΩçÊ∫´ÊöñÁöÑÂøóÂ∑• Roxanne Â∏´ÂßäÊ≥®ÊÑèÂà∞Â•πÂú®ÊóÅÈÇäÁúã„ÄÇ„ÄåË¶Å‰∏çË¶Å‰æÜÂπ´ÂøôÂàÜÈ°ûÈÄô‰∫õÁï™ËåÑÔºü‰∫∫Â§öÂ•ΩËæ¶‰∫ãÔºÅ„ÄçÊ≤íÊúâÂ£ìÂäõÔºåÂè™ÊòØËºïËºïÁöÑÈÇÄË´ã...",
        es: "Maya regres√≥ la siguiente semana. Una c√°lida voluntaria llamada Hermana Roxanne la not√≥ observando. '¬øTe gustar√≠a ayudar a clasificar estos tomates? ¬°Muchas manos hacen el trabajo m√°s ligero!' Sin presi√≥n, solo una invitaci√≥n gentil..."
    },
    helper: {
        en: "Maya has helped several times now. The other volunteers treat her like family. Today, Sister Roxanne mentions a training workshop. 'It's totally optional,' she says with a smile, 'but I think you'd enjoy learning about our mission.'",
        zh: "Áë™ÈõÖÂ∑≤Á∂ìÂπ´Âøô‰∫ÜÂ•ΩÂπæÊ¨°„ÄÇÂÖ∂‰ªñÂøóÂ∑•ÊääÂ•πÁï∂ÂÆ∂‰∫∫„ÄÇ‰ªäÂ§©ÔºåRoxanne Â∏´ÂßäÊèêÂà∞‰∏ÄÂÄãÂüπË®ìÂ∑•‰ΩúÂùä„ÄÇ„ÄåÂÆåÂÖ®Ëá™È°òÔºå„ÄçÂ•πÂæÆÁ¨ëËëóË™™Ôºå„Äå‰ΩÜÊàëË¶∫Âæó‰Ω†ÊúÉÂñúÊ≠°‰∫ÜËß£ÊàëÂÄëÁöÑ‰ΩøÂëΩ„ÄÇ„Äç",
        es: "Maya ha ayudado varias veces. Los otros voluntarios la tratan como familia. Hoy, la Hermana Roxanne menciona un taller de capacitaci√≥n. 'Es totalmente opcional,' dice con una sonrisa, 'pero creo que disfrutar√≠as aprender sobre nuestra misi√≥n.'"
    },
    regular: {
        en: "A year has passed. Maya knows everyone's names now. A teenage boy named Marcus asks shyly if she can teach him how to organize the vegetable boxes. 'You're so good at this, Miss Maya...' She feels something shift inside her.",
        zh: "‰∏ÄÂπ¥ÈÅéÂéª‰∫Ü„ÄÇÁë™ÈõÖÁèæÂú®Ë™çË≠òÊØèÂÄã‰∫∫ÁöÑÂêçÂ≠ó„ÄÇ‰∏ÄÂÄãÂè´ Marcus ÁöÑÈùíÂ∞ëÂπ¥ÂÆ≥ÁæûÂú∞ÂïèÂ•πËÉΩ‰∏çËÉΩÊïô‰ªñÊï¥ÁêÜËî¨ËèúÁÆ±„ÄÇ„ÄåÁë™ÈõÖÂßêÂßêÔºå‰Ω†ÂÅöÂæóÂ•ΩÂ•ΩÂñî...„ÄçÂ•πÂøÉË£°Êúâ‰ªÄÈ∫ºÊù±Ë•øÈñãÂßãËΩâËÆä„ÄÇ",
        es: "Ha pasado un a√±o. Maya ahora conoce los nombres de todos. Un adolescente llamado Marcus le pregunta t√≠midamente si puede ense√±arle a organizar las cajas de vegetales. 'Eres muy buena en esto, Se√±orita Maya...' Ella siente algo cambiar dentro de ella."
    },
    mentor: {
        en: "Two years of mentoring new volunteers. Maya has watched many people grow, just as she once did. Sister Roxanne pulls her aside one day: 'Maya, we see your dedication. Would you consider the Commissioner certification training?' Maya's heart races...",
        zh: "ÂÖ©Âπ¥ÁöÑÂ∏∂È†òÊñ∞ÂøóÂ∑•„ÄÇÁë™ÈõÖÁúãËëóË®±Â§ö‰∫∫ÊàêÈï∑ÔºåÂ∞±ÂÉèÁï∂ÂàùÁöÑÂ•π‰∏ÄÊ®£„ÄÇÊúâ‰∏ÄÂ§© Roxanne Â∏´ÂßäÊääÂ•πÊãâÂà∞‰∏ÄÊóÅÔºö„ÄåÁë™ÈõÖÔºåÊàëÂÄëÁúãÂà∞‰Ω†ÁöÑ‰ªòÂá∫„ÄÇ‰Ω†È°òÊÑèËÄÉÊÖÆÂßîÂì°Ë™çË≠âÂüπË®ìÂóéÔºü„ÄçÁë™ÈõÖÁöÑÂøÉË∑≥Âä†ÈÄü...",
        es: "Dos a√±os guiando nuevos voluntarios. Maya ha visto crecer a muchas personas, como ella una vez lo hizo. La Hermana Roxanne la lleva aparte un d√≠a: 'Maya, vemos tu dedicaci√≥n. ¬øConsiderar√≠as la capacitaci√≥n para certificaci√≥n de Comisionada?' El coraz√≥n de Maya se acelera..."
    },
    leader: {
        en: "üéâ Maya did it! From a single mother seeking food assistance to the first local female Commissioner from Hunters Point. The same community center where she once hesitated to enter ‚Äî she now leads with grace and compassion. Her journey has come full circle.",
        zh: "üéâ Áë™ÈõÖÂÅöÂà∞‰∫ÜÔºÅÂæûÂ∞ãÊ±ÇÈ£üÁâ©Êè¥Âä©ÁöÑÂñÆË¶™Â™ΩÂ™ΩÔºåÂà∞Áçµ‰∫∫ËßíÁ¨¨‰∏Ä‰ΩçÊú¨ÂúüÂ•≥ÂßîÂì°„ÄÇÁï∂ÂàùÂ•πÁå∂Ë±´Ëëó‰∏çÊï¢ÈÄ≤ÂÖ•ÁöÑÁ§æÂçÄ‰∏≠ÂøÉ‚Äî‚ÄîÁèæÂú®Â•π‰ª•ÂÑ™ÈõÖÂíåÊÖàÊÇ≤Âú®ÈÄôË£°Â∏∂È†ò„ÄÇÂ•πÁöÑÊóÖÁ®ãÁï´‰∫Ü‰∏ÄÂÄãÂÆåÊï¥ÁöÑÂúì„ÄÇ",
        es: "üéâ ¬°Maya lo logr√≥! De madre soltera buscando asistencia alimentaria a la primera Comisionada local femenina de Hunters Point. El mismo centro comunitario donde una vez dud√≥ en entrar ‚Äî ahora lidera con gracia y compasi√≥n. Su viaje ha completado el c√≠rculo."
    }
};

// Actions
const ACTIONS = {
    newcomer: [
        { id: 'observe', emoji: 'üëÄ', en: 'Just watch', zh: 'Âè™ÊòØÁúãÁúã', es: 'Solo mirar', prob: { stay: 0.6, advance: 0.4 }, reward: 1 },
        { id: 'approach', emoji: 'üëã', en: 'Say hello', zh: 'ÊâìÂÄãÊãõÂëº', es: 'Saludar', prob: { stay: 0.3, advance: 0.7 }, reward: 3 },
        { id: 'leave', emoji: 'üè†', en: 'Go home', zh: 'ÂõûÂÆ∂', es: 'Ir a casa', prob: { stay: 1.0, advance: 0 }, reward: 0 }
    ],
    curious: [
        { id: 'decline', emoji: 'üôÖ', en: 'Not today', zh: '‰ªäÂ§©‰∏çË°å', es: 'Hoy no', prob: { stay: 0.7, advance: 0.3 }, reward: 1 },
        { id: 'help_once', emoji: 'ü§ù', en: 'Help today', zh: '‰ªäÂ§©Âπ´Âøô', es: 'Ayudar hoy', prob: { stay: 0.2, advance: 0.8 }, reward: 5 },
        { id: 'leave', emoji: 'üè†', en: 'Just take food', zh: 'Âè™ÊãøÈ£üÁâ©', es: 'Solo tomar comida', prob: { stay: 0.9, advance: 0.1 }, reward: 0 }
    ],
    helper: [
        { id: 'occasional', emoji: 'üìÖ', en: 'Come sometimes', zh: 'ÂÅ∂Áàæ‰æÜ', es: 'Venir a veces', prob: { stay: 0.5, advance: 0.5 }, reward: 3 },
        { id: 'training', emoji: 'üìö', en: 'Join training', zh: 'ÂèÉÂä†ÂüπË®ì', es: 'Unirse a capacitaci√≥n', prob: { stay: 0.1, advance: 0.9 }, reward: 8 },
        { id: 'pause', emoji: '‚è∏Ô∏è', en: 'Take a break', zh: '‰ºëÊÅØ‰∏Ä‰∏ã', es: 'Tomar un descanso', prob: { stay: 0.8, advance: 0.2 }, reward: 1 }
    ],
    regular: [
        { id: 'continue', emoji: 'üí™', en: 'Keep helping', zh: 'ÁπºÁ∫åÂπ´Âøô', es: 'Seguir ayudando', prob: { stay: 0.4, advance: 0.6 }, reward: 5 },
        { id: 'mentor', emoji: 'üåü', en: 'Mentor Marcus', zh: 'ÊåáÂ∞é Marcus', es: 'Guiar a Marcus', prob: { stay: 0.1, advance: 0.9 }, reward: 12 },
        { id: 'reduce', emoji: 'üìâ', en: 'Reduce time', zh: 'Ê∏õÂ∞ëÊôÇÈñì', es: 'Reducir tiempo', prob: { stay: 0.7, advance: 0.3 }, reward: 2 }
    ],
    mentor: [
        { id: 'decline_cert', emoji: 'üôè', en: 'Not ready yet', zh: 'ÈÇÑÊ≤íÊ∫ñÂÇôÂ•Ω', es: 'A√∫n no estoy lista', prob: { stay: 0.6, advance: 0.4 }, reward: 5 },
        { id: 'accept_cert', emoji: 'üéì', en: 'Accept training', zh: 'Êé•ÂèóÂüπË®ì', es: 'Aceptar capacitaci√≥n', prob: { stay: 0.05, advance: 0.95 }, reward: 20 },
        { id: 'think', emoji: 'ü§î', en: 'Think about it', zh: 'ËÄÉÊÖÆ‰∏Ä‰∏ã', es: 'Pensarlo', prob: { stay: 0.4, advance: 0.6 }, reward: 3 }
    ]
};

const VALUES = { newcomer: 15.2, curious: 18.7, helper: 22.4, regular: 26.8, mentor: 28.5, leader: 30.0 };

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MUSIC CONTROL - FIXED
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleMusic() {
    if (musicPlaying) {
        bgMusic.pause();
        meditationMusic.pause();
        musicPlaying = false;
    } else {
        const currentScreen = document.querySelector('.screen.active');
        if (currentScreen.id === 'meditation-screen') {
            meditationMusic.volume = 0.4;
            meditationMusic.play().catch(e => console.log('Audio error:', e));
        } else {
            bgMusic.volume = 0.3;
            bgMusic.play().catch(e => console.log('Audio error:', e));
        }
        musicPlaying = true;
    }
    updateMusicButtons();
}

function updateMusicButtons() {
    const btns = document.querySelectorAll('.music-btn');
    btns.forEach(btn => {
        btn.textContent = musicPlaying ? 'üîä' : 'üîá';
        btn.classList.toggle('playing', musicPlaying);
    });
}

function switchToMeditationMusic() {
    bgMusic.pause();
    if (musicPlaying) {
        meditationMusic.volume = 0.4;
        meditationMusic.play().catch(e => console.log('Audio error:', e));
    }
}

function playLevelUpSound() {
    // Create a simple level up sound
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
    oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
    oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
    
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.4);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LANGUAGE SYSTEM - FIXED
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setLanguage(lang) {
    currentLang = lang;
    
    // Update toggle buttons
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-lang') === lang);
    });
    
    // Update all text elements
    document.querySelectorAll('.lang-text').forEach(el => {
        const text = el.getAttribute(`data-${lang}`) || el.getAttribute('data-en');
        if (text) el.textContent = text;
    });
    
    // Re-render game elements if in game
    if (document.getElementById('game-screen').classList.contains('active')) {
        renderJourneyPath();
        renderSituation();
        renderActions();
        updateValueDisplay();
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCREEN MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
}

function startGame() {
    currentStage = 0;
    gameStats = { week: 1, joy: 0, impact: 0, elo: 1200 };
    selectedAction = null;
    
    showScreen('game-screen');
    renderJourneyPath();
    renderSituation();
    renderActions();
    updateStats();
    updateValueDisplay();
    
    // Start music if not playing
    if (!musicPlaying) {
        toggleMusic();
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderJourneyPath() {
    const container = document.getElementById('journey-path');
    container.innerHTML = '';
    
    STAGES.forEach((stage, idx) => {
        const node = document.createElement('div');
        node.className = 'stage-node';
        if (idx < currentStage) node.classList.add('completed');
        else if (idx === currentStage) node.classList.add('current');
        else node.classList.add('locked');
        
        const label = stage[currentLang] || stage.en;
        node.innerHTML = `<span>${stage.emoji}</span>`;
        
        const labelDiv = document.createElement('div');
        labelDiv.className = 'stage-label';
        labelDiv.textContent = label;
        
        const wrapper = document.createElement('div');
        wrapper.className = 'flex flex-col items-center';
        wrapper.appendChild(node);
        wrapper.appendChild(labelDiv);
        container.appendChild(wrapper);
        
        if (idx < STAGES.length - 1) {
            const connector = document.createElement('div');
            connector.className = 'path-connector';
            if (idx < currentStage) connector.classList.add('active');
            container.appendChild(connector);
        }
    });
}

function renderSituation() {
    const stageId = STAGES[currentStage].id;
    const situation = SITUATIONS[stageId];
    const text = situation[currentLang] || situation.en;
    document.getElementById('situation-text').innerHTML = `<p class="leading-relaxed">${text}</p>`;
    document.getElementById('story-panel').style.display = 'none';
}

function renderActions() {
    const container = document.getElementById('action-cards');
    container.innerHTML = '';
    
    const stageId = STAGES[currentStage].id;
    
    // ‰∏âË™ûÊñáÂ≠ó
    const uiText = {
        congrats: { en: "Congratulations! You've completed the journey!", zh: "ÊÅ≠ÂñúÔºÅ‰Ω†ÂÆåÊàê‰∫ÜÊóÖÁ®ãÔºÅ", es: "¬°Felicidades! ¬°Has completado el viaje!" },
        enterGate: { en: "Enter Ataraxy Portico üôè", zh: "ÈÄ≤ÂÖ•ÈùúÂøÉ‰πãÈñÄ üôè", es: "Entrar al Portal de Serenidad üôè" },
        growthChance: { en: "Growth chance", zh: "ÊàêÈï∑Ê©üÁéá", es: "Prob. crecimiento" },
        joy: { en: "joy", zh: "ÂñúÊÇÖ", es: "alegr√≠a" }
    };
    
    if (stageId === 'leader') {
        const congratsText = uiText.congrats[currentLang] || uiText.congrats.en;
        const btnText = uiText.enterGate[currentLang] || uiText.enterGate.en;
        container.innerHTML = `
            <div class="text-center">
                <p class="text-2xl mb-4">üéâ</p>
                <p class="text-yellow-300 text-lg mb-4">${congratsText}</p>
                <button onclick="openMeditationGate()" class="btn btn-primary">${btnText}</button>
            </div>
        `;
        document.getElementById('execute-btn').style.display = 'none';
        if (typeof confetti === 'function') confetti({ particleCount: 150, spread: 80 });
        return;
    }
    
    const actions = ACTIONS[stageId];
    if (!actions) return;
    
    actions.forEach(action => {
        const card = document.createElement('div');
        card.className = 'action-card';
        card.onclick = () => selectAction(action.id);
        card.id = `action-${action.id}`;
        
        const advanceProb = Math.round(action.prob.advance * 100);
        const actionName = action[currentLang] || action.en;
        const growthText = uiText.growthChance[currentLang] || uiText.growthChance.en;
        const joyText = uiText.joy[currentLang] || uiText.joy.en;
        
        card.innerHTML = `
            <div class="action-icon">${action.emoji}</div>
            <div class="font-bold text-white mb-2">${actionName}</div>
            <div class="text-xs text-white/70 mb-2">${growthText}: ${advanceProb}%</div>
            <div class="prob-bar">
                <div class="prob-fill" style="width: ${advanceProb}%; background: linear-gradient(90deg, var(--soft-green), var(--warm-gold));"></div>
            </div>
            <div class="text-xs text-pink-300 mt-2">+${action.reward} ${joyText}</div>
        `;
        container.appendChild(card);
    });
    
    document.getElementById('execute-btn').style.display = 'inline-block';
    document.getElementById('execute-btn').disabled = true;
}

function selectAction(actionId) {
    selectedAction = actionId;
    document.querySelectorAll('.action-card').forEach(card => card.classList.remove('selected'));
    document.getElementById(`action-${actionId}`).classList.add('selected');
    document.getElementById('execute-btn').disabled = false;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GAME LOGIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function executeAction() {
    if (!selectedAction) return;
    
    const stageId = STAGES[currentStage].id;
    const actions = ACTIONS[stageId];
    const action = actions.find(a => a.id === selectedAction);
    
    gameStats.joy += action.reward;
    gameStats.impact += Math.floor(action.reward / 2);
    gameStats.week++;
    
    const roll = Math.random();
    const advances = roll < action.prob.advance;
    
    showResult(action, advances);
    
    if (advances && currentStage < STAGES.length - 1) {
        currentStage++;
        gameStats.elo += 30;
        playLevelUpSound();
    } else {
        gameStats.elo += 5;
    }
    
    setTimeout(() => {
        renderJourneyPath();
        renderSituation();
        renderActions();
        updateStats();
        updateValueDisplay();
        selectedAction = null;
    }, 2000);
}

function showResult(action, advances) {
    const panel = document.getElementById('story-panel');
    const content = document.getElementById('story-content');
    
    // ‰∏âË™ûÁµêÊûúË®äÊÅØ
    const resultText = {
        growth: { 
            en: (name, emoji, reward) => `‚ú® Your choice led to growth! Moving to: ${emoji} ${name}`,
            zh: (name, emoji, reward) => `‚ú® ‰Ω†ÁöÑÈÅ∏ÊìáÂ∏∂‰æÜÊàêÈï∑ÔºÅÂâçÈÄ≤Âà∞Ôºö${emoji} ${name}`,
            es: (name, emoji, reward) => `‚ú® ¬°Tu elecci√≥n llev√≥ al crecimiento! Avanzando a: ${emoji} ${name}`
        },
        stay: {
            en: (reward) => `üå± Sometimes growth takes time. Every experience matters. +${reward} joy`,
            zh: (reward) => `üå± ÊàêÈï∑ÊúâÊôÇÈúÄË¶ÅÊôÇÈñì„ÄÇÊØèÂÄãÁ∂ìÊ≠∑ÈÉΩÂæàÈáçË¶Å„ÄÇ+${reward} ÂñúÊÇÖ`,
            es: (reward) => `üå± A veces el crecimiento toma tiempo. Cada experiencia importa. +${reward} alegr√≠a`
        }
    };
    
    let message;
    if (advances) {
        const nextStage = STAGES[currentStage + 1];
        const nextName = nextStage[currentLang] || nextStage.en;
        const getText = resultText.growth[currentLang] || resultText.growth.en;
        message = getText(nextName, nextStage.emoji, action.reward);
    } else {
        const getText = resultText.stay[currentLang] || resultText.stay.en;
        message = getText(action.reward);
    }
    
    content.innerHTML = `<p class="text-lg ${advances ? 'text-green-300' : 'text-yellow-300'}">${message}</p>`;
    panel.style.display = 'block';
    panel.classList.add('fade-in');
}

function updateStats() {
    document.getElementById('week-display').textContent = gameStats.week;
    document.getElementById('stage-display').textContent = `${currentStage + 1}/${STAGES.length}`;
    document.getElementById('joy-display').textContent = gameStats.joy;
    document.getElementById('impact-display').textContent = gameStats.impact;
    document.getElementById('elo-display').textContent = gameStats.elo;
    
    // Update scene background
    const bgElement = document.getElementById('scene-background');
    if (bgElement && STAGES[currentStage]) {
        bgElement.style.backgroundImage = `url('${STAGES[currentStage].bg}')`;
    }
}

function updateValueDisplay() {
    const display = document.getElementById('value-display');
    let html = '<div class="space-y-1">';
    
    STAGES.forEach((stage, idx) => {
        const isCurrent = idx === currentStage;
        const color = isCurrent ? 'text-yellow-300' : (idx < currentStage ? 'text-green-300' : 'text-white/50');
        const marker = isCurrent ? '‚Üí ' : '  ';
        html += `<div class="${color}">${marker}V(${stage.id.substring(0,3)}) = ${VALUES[stage.id].toFixed(1)}</div>`;
    });
    
    html += '</div>';
    const policyTexts = {
        en: 'Optimal policy: Choose actions with highest expected value',
        zh: 'ÊúÄÂÑ™Á≠ñÁï•ÔºöÈÅ∏ÊìáÊúüÊúõÂÉπÂÄºÊúÄÈ´òÁöÑË°åÂãï',
        es: 'Pol√≠tica √≥ptima: Elige acciones con mayor valor esperado'
    };
    const policyText = policyTexts[currentLang] || policyTexts.en;
    html += `<div class="mt-3 pt-3 border-t border-white/20 text-xs text-white/70">${policyText}</div>`;
    display.innerHTML = html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MEDITATION GATE - Ê∑±ÂëºÂê∏/ÂêêÊ∞£ Âæ™Áí∞
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openMeditationGate() {
    showScreen('meditation-screen');
    switchToMeditationMusic();
    
    const counter = document.getElementById('breath-counter');
    const instruction = document.getElementById('breath-instruction');
    
    const breathTexts = {
        inhale: { en: 'Inhale...', zh: 'Ê∑±ÂëºÂê∏...', es: 'Inhala...' },
        exhale: { en: 'Exhale...', zh: 'ÂêêÊ∞£...', es: 'Exhala...' },
        follow: { en: 'Follow the breathing...', zh: 'Ë∑üÈö®ÂëºÂê∏...', es: 'Sigue la respiraci√≥n...' },
        complete: { en: 'Breathe completed ‚ú®', zh: 'ÂëºÂê∏ÂÆåÊàê ‚ú®', es: 'Respiraci√≥n completada ‚ú®' },
        done: 'üôè'
    };
    
    // ÂàùÂßãÂåñÊåáÁ§∫ÊñáÂ≠ó
    instruction.textContent = breathTexts.follow[currentLang] || breathTexts.follow.en;
    
    let cycle = 0;
    const totalCycles = 3;
    
    function breathCycle() {
        if (cycle >= totalCycles) {
            counter.textContent = breathTexts.done;
            counter.style.fontSize = '3rem';
            instruction.textContent = breathTexts.complete[currentLang] || breathTexts.complete.en;
            return;
        }
        
        // Ê∑±ÂëºÂê∏ 4Áßí
        counter.textContent = breathTexts.inhale[currentLang] || breathTexts.inhale.en;
        counter.style.transform = 'scale(1.2)';
        counter.style.fontSize = '1.5rem';
        
        setTimeout(() => {
            // ÂêêÊ∞£ 4Áßí
            counter.textContent = breathTexts.exhale[currentLang] || breathTexts.exhale.en;
            counter.style.transform = 'scale(0.9)';
            
            setTimeout(() => {
                cycle++;
                counter.style.transform = 'scale(1)';
                breathCycle();
            }, 4000);
        }, 4000);
    }
    
    // ÈñãÂßãÂëºÂê∏Âæ™Áí∞
    setTimeout(breathCycle, 1000);
}

function backToGame() {
    meditationMusic.pause();
    if (musicPlaying) {
        bgMusic.play().catch(e => console.log('Audio error:', e));
    }
    startGame();
}

function goToMainMenu() {
    meditationMusic.pause();
    bgMusic.pause();
    // ËøîÂõû‰∏ªÈ†ÅÈù¢Ôºàindex.htmlÔºâ
    window.location.href = '../index.html';
}

function goToNextLevel() {
    meditationMusic.pause();
    bgMusic.pause();
    // ÂâçÂæÄÁ¨¨ÂõõÈóú
    window.location.href = '../level4/index.html';
}

function goBack() {
    const msgs = { en: 'Return to main menu?', zh: 'ËøîÂõû‰∏ªÈÅ∏ÂñÆÔºü', es: '¬øVolver al men√∫ principal?' };
    const msg = msgs[currentLang] || msgs.en;
    if (confirm(msg)) {
        bgMusic.pause();
        meditationMusic.pause();
        window.location.href = '../index.html';
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
    setLanguage('en');
    if (bgMusic) bgMusic.volume = 0.3;
    if (meditationMusic) meditationMusic.volume = 0.4;
    updateMusicButtons();
    console.log('Level 3 MDP - Sister Maya\'s Journey loaded!');
});
</script>

</body>
</html>
