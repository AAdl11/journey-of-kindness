<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google" content="notranslate">
    <title>å–„çš„æ—…ç¨‹ Level 3: MDP | Sister Maya çš„æ•…äº‹</title>
    
    <!-- Audio Files -->
    <audio id="bgMusic" loop>
        <source src="stage3.mp3" type="audio/mpeg">
    </audio>
    <audio id="meditationMusic" loop>
        <source src="AnaCaptainslogue_-_Noir_Et_Blanc_Vie.mp3" type="audio/mpeg">
    </audio>
    <audio id="levelUpSound">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdH2LkZeUj4J0ZFtXXWVvfIiRl5aOgXJkWVVbY3B9iZKYlo+CdGVbV11lcH2IkZeWjoFyZFpVW2NwfYmSmJaPgnRlW1ddZXB9iJGXlo6BcmRaVVtjcH2JkpiWj4J0ZVtXXWVwfYiRl5aOgXJkWlVbY3B9iZKYlo+CdGVbV11lcH2IkZeWjoFyZFpVW2NwfQ==" type="audio/wav">
    </audio>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Noto Sans TC', sans-serif; box-sizing: border-box; margin: 0; padding: 0; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        :root {
            --warm-gold: #f59e0b;
            --soft-green: #10b981;
            --calm-blue: #3b82f6;
            --gentle-purple: #8b5cf6;
            --warm-pink: #ec4899;
        }
        
        .screen { display: none; min-height: 100vh; position: relative; }
        .screen.active { display: flex; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 20px rgba(245, 158, 11, 0.3); } 50% { box-shadow: 0 0 40px rgba(245, 158, 11, 0.6); } }
        @keyframes breathe { 0%, 100% { transform: scale(0.95); opacity: 0.7; } 50% { transform: scale(1.05); opacity: 1; } }
        
        .fade-in { animation: fadeIn 0.6s ease-out; }
        .pulse { animation: pulse 2s infinite; }
        .glow { animation: glow 3s infinite; }
        .breathe { animation: breathe 4s ease-in-out infinite; }
        
        .bg-warm {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 50%, #3d5a7f 100%);
        }
        
        /* Scene background - FULL VISIBILITY */
        .scene-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            opacity: 0.95;
            z-index: 0;
            transition: background-image 0.5s ease;
        }
        
        .game-content {
            position: relative;
            z-index: 1;
        }
        
        /* Journey path */
        .journey-path {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 20px;
            flex-wrap: wrap;
        }
        
        .stage-node {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            transition: all 0.3s;
            border: 3px solid rgba(255,255,255,0.35);
            background: rgba(255,255,255,0.1);
            cursor: pointer;
        }
        
        .stage-node.current {
            background: linear-gradient(135deg, var(--warm-gold), #fbbf24);
            border-color: white;
            transform: scale(1.15);
            box-shadow: 0 0 30px rgba(245, 158, 11, 0.6);
        }
        
        .stage-node.completed {
            background: linear-gradient(135deg, var(--soft-green), #34d399);
            border-color: rgba(255,255,255,0.8);
        }
        
        .stage-node.locked {
            opacity: 0.4;
            background: rgba(255,255,255,0.05);
        }
        
        .stage-label {
            font-size: 10px;
            color: white;
            text-align: center;
            margin-top: 6px;
        }
        
        .path-connector {
            width: 30px;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
        }
        
        .path-connector.active {
            background: linear-gradient(90deg, var(--soft-green), var(--warm-gold));
        }
        
        /* Action cards - GLASS EFFECT */
        .action-card {
            background: rgba(30, 50, 80, 0.2);
            backdrop-filter: blur(3px);
            border-radius: 16px;
            padding: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            cursor: pointer;
            transition: all 0.3s;
            min-width: 140px;
            text-align: center;
        }
        
        .action-card:hover {
            transform: translateY(-5px);
            border-color: var(--warm-gold);
            background: rgba(245, 158, 11, 0.15);
        }
        
        .action-card.selected {
            border-color: var(--warm-gold);
            background: rgba(245, 158, 11, 0.25);
        }
        
        .action-icon { font-size: 2.5rem; margin-bottom: 10px; }
        
        /* Info panel - GLASS EFFECT - very transparent */
        .info-panel {
            background: rgba(20, 40, 70, 0.2);
            backdrop-filter: blur(4px);
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.25);
            padding: 15px;
            color: white;
        }
        
        .value-display {
            background: rgba(20, 40, 70, 0.15);
            border-radius: 12px;
            padding: 15px;
            font-family: 'JetBrains Mono', monospace;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .bellman-box {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.35), rgba(59, 130, 246, 0.35));
            border: 2px solid rgba(251, 191, 36, 0.5);
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            backdrop-filter: blur(4px);
        }
        
        /* Buttons */
        .btn {
            padding: 12px 28px;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            font-size: 14px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--warm-gold), #fbbf24);
            color: #1e3a5f;
        }
        
        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(245, 158, 11, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.4);
        }
        
        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* Story panel - GLASS EFFECT */
        .story-panel {
            background: rgba(20, 40, 70, 0.25);
            backdrop-filter: blur(6px);
            border-radius: 20px;
            border: 2px solid rgba(251, 191, 36, 0.4);
            padding: 25px;
            max-width: 600px;
            color: white;
        }
        
        /* Meditation styles */
        .breath-ring {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            border: 5px solid #fbbf24;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.6), 0 0 40px rgba(251, 191, 36, 0.3);
            animation: breathe 4s ease-in-out infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(5px);
        }
        
        .jingsi-card {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.25), rgba(168, 85, 247, 0.15));
            backdrop-filter: blur(8px);
            border-radius: 20px;
            padding: 30px 40px;
            border: 2px solid rgba(251, 191, 36, 0.5);
            text-align: center;
        }
        
        /* Language toggle */
        .lang-toggle { display: flex; gap: 8px; }
        
        .lang-btn {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            background: rgba(255,255,255,0.15);
            color: white;
        }
        
        .lang-btn.active {
            background: var(--warm-gold);
            color: #1e3a5f;
        }
        
        .lang-btn:not(.active) {
            border-color: rgba(255,255,255,0.3);
        }
        
        /* Music button */
        .music-btn {
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.15);
        }
        
        .music-btn.playing {
            background: var(--soft-green);
            border-color: var(--soft-green);
        }
        
        /* Probability bar */
        .prob-bar {
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .prob-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s;
        }
        
        /* ELO badge */
        .elo-badge {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #1e3a5f;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .stage-node { width: 60px; height: 60px; font-size: 1.5rem; }
            .action-card { min-width: 100px; padding: 15px; }
        }
    </style>
</head>
<body class="bg-warm text-white overflow-x-hidden">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 1: INTRO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="intro-screen" class="screen active flex-col items-center justify-center p-6" style="background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 100%);">
    <div class="text-center fade-in">
        <!-- Controls -->
        <div class="flex justify-center gap-4 mb-6">
            <div class="lang-toggle">
                <button class="lang-btn active" onclick="setLanguage('en')" data-lang="en">EN</button>
                <button class="lang-btn" onclick="setLanguage('zh')" data-lang="zh">ä¸­æ–‡</button>
                <button class="lang-btn" onclick="setLanguage('es')" data-lang="es">ES</button>
            </div>
            <button onclick="toggleMusic()" class="music-btn" id="intro-music-btn">ğŸ”‡</button>
        </div>
        
        <h1 class="text-4xl font-bold mb-4" style="text-shadow: 0 0 30px rgba(245, 158, 11, 0.5);">
            ğŸŒ± <span class="lang-text" data-en="Level 3: MDP" data-zh="ç¬¬ä¸‰é—œï¼šMDP" data-es="Nivel 3: MDP">Level 3: MDP</span>
        </h1>
        <h2 class="text-2xl text-yellow-300 mb-4 lang-text" data-en="Sister Maya's Journey" data-zh="ç‘ªé›…å¸«å§Šçš„æ•…äº‹" data-es="El Viaje de la Hermana Maya">Sister Maya's Journey</h2>
        <p class="text-white/80 mb-6 lang-text" data-en="A Story of Transformation" data-zh="ä¸€å€‹è½‰è®Šçš„æ•…äº‹" data-es="Una Historia de TransformaciÃ³n">A Story of Transformation</p>
        
        <div class="story-panel mx-auto mb-8 text-left">
            <div class="flex items-center gap-4 mb-4">
                <div class="w-20 h-20 rounded-full bg-gradient-to-br from-yellow-400 to-orange-500 flex items-center justify-center text-4xl">ğŸ‘©ğŸ¿</div>
                <div>
                    <h3 class="text-yellow-300 font-bold text-lg">Sister Maya</h3>
                    <p class="text-white/70 text-sm lang-text" data-en="First Local Commissioner from Hunters Point" data-zh="çµäººè§’ç¬¬ä¸€ä½æœ¬åœŸå¥³å§”å“¡" data-es="Primera Comisionada Local de Hunters Point">First Local Commissioner from Hunters Point</p>
                </div>
            </div>
            <p class="text-lg leading-relaxed mb-4 lang-text" data-en="Maya first came to Tzu Chi's food distribution as a single mother seeking help. She never imagined she would one day become a Commissioner â€” leading the very program that once helped her. This is her story of growth, choice by choice." data-zh="ç‘ªé›…ç¬¬ä¸€æ¬¡ä¾†æ…ˆæ¿Ÿé£Ÿç‰©ç™¼æ”¾æ™‚ï¼Œæ˜¯ä¸€ä½å°‹æ±‚å¹«åŠ©çš„å–®è¦ªåª½åª½ã€‚å¥¹å¾æœªæƒ³éæœ‰ä¸€å¤©æœƒæˆç‚ºå§”å“¡â€”â€”å¸¶é ˜ç•¶åˆå¹«åŠ©å¥¹çš„é€™å€‹è¨ˆç•«ã€‚é€™æ˜¯å¥¹ä¸€æ­¥ä¸€æ­¥æˆé•·çš„æ•…äº‹ã€‚" data-es="Maya llegÃ³ por primera vez a la distribuciÃ³n de alimentos de Tzu Chi como madre soltera buscando ayuda. Nunca imaginÃ³ que un dÃ­a se convertirÃ­a en Comisionada â€” liderando el mismo programa que una vez la ayudÃ³. Esta es su historia de crecimiento, elecciÃ³n por elecciÃ³n.">Maya first came to Tzu Chi's food distribution as a single mother seeking help. She never imagined she would one day become a Commissioner â€” leading the very program that once helped her. This is her story of growth, choice by choice.</p>
            <p class="text-yellow-300 text-center italic text-lg lang-text" data-en="ã€ŒWilling to do, happy to receiveã€" data-zh="ã€Œç”˜é¡˜åšï¼Œæ­¡å–œå—ã€" data-es="ã€ŒDispuesto a hacer, feliz de recibirã€">ã€ŒWilling to do, happy to receiveã€</p>
        </div>
        
        <div class="info-panel mx-auto mb-6" style="max-width: 500px; background: rgba(139, 92, 246, 0.25);">
            <p class="text-purple-200 text-sm lang-text" data-en="âš ï¸ This is a fictional story inspired by real volunteers. Names and timelines are created for educational purposes." data-zh="âš ï¸ é€™æ˜¯ä¸€å€‹è™›æ§‹æ•…äº‹ï¼Œéˆæ„Ÿä¾†è‡ªçœŸå¯¦å¿—å·¥ã€‚å§“åå’Œæ™‚é–“ç·šç‚ºæ•™è‚²ç›®çš„è€Œå‰µä½œã€‚" data-es="âš ï¸ Esta es una historia ficticia inspirada en voluntarios reales. Los nombres y lÃ­neas de tiempo se crearon con fines educativos.">âš ï¸ This is a fictional story inspired by real volunteers. Names and timelines are created for educational purposes.</p>
        </div>
        
        <p class="text-sm text-white/70 mb-6 lang-text" data-en="Learn how MDP (Markov Decision Process) models decision-making under uncertainty" data-zh="å­¸ç¿’ MDPï¼ˆé¦¬å¯å¤«æ±ºç­–éç¨‹ï¼‰å¦‚ä½•åœ¨ä¸ç¢ºå®šæ€§ä¸‹åšæ±ºç­–" data-es="Aprende cÃ³mo MDP (Proceso de DecisiÃ³n de Markov) modela la toma de decisiones bajo incertidumbre">Learn how MDP (Markov Decision Process) models decision-making under uncertainty</p>
        
        <button onclick="startGame()" class="btn btn-primary text-lg glow">
            <span class="lang-text" data-en="Begin Maya's Journey ğŸš€" data-zh="é–‹å§‹ç‘ªé›…çš„æ—…ç¨‹ ğŸš€" data-es="Comenzar el Viaje de Maya ğŸš€">Begin Maya's Journey ğŸš€</span>
        </button>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 2: GAME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="game-screen" class="screen flex-col bg-warm" style="position: relative;">
    <!-- Scene Background -->
    <div class="scene-bg" id="scene-background"></div>
    
    <!-- Header -->
    <div class="flex justify-between items-center p-4 game-content" style="background: rgba(20, 40, 70, 0.25); backdrop-filter: blur(4px);">
        <button onclick="goBack()" class="text-white/80 hover:text-white">
            â† <span class="lang-text" data-en="Menu" data-zh="é¸å–®" data-es="MenÃº">Menu</span>
        </button>
        <div class="text-center">
            <div class="text-lg font-bold">ğŸŒ± Level 3: MDP</div>
            <div class="text-xs text-yellow-300 lang-text" data-en="Sister Maya's Journey" data-zh="ç‘ªé›…å¸«å§Šçš„æ•…äº‹" data-es="El Viaje de la Hermana Maya">Sister Maya's Journey</div>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="toggleMusic()" class="music-btn" id="game-music-btn">ğŸ”‡</button>
            <div class="elo-badge">â­ <span id="elo-display">1200</span></div>
            <div class="lang-toggle">
                <button class="lang-btn active" onclick="setLanguage('en')" data-lang="en">EN</button>
                <button class="lang-btn" onclick="setLanguage('zh')" data-lang="zh">ä¸­æ–‡</button>
                <button class="lang-btn" onclick="setLanguage('es')" data-lang="es">ES</button>
            </div>
        </div>
    </div>
    
    <!-- Main Game Area -->
    <div class="flex-1 flex flex-col lg:flex-row gap-4 p-4 overflow-auto game-content">
        <!-- Left: Journey Visualization -->
        <div class="lg:w-2/3 flex flex-col gap-4">
            <!-- Journey Path -->
            <div class="info-panel">
                <h3 class="text-yellow-300 font-bold mb-3">ğŸ—ºï¸ <span class="lang-text" data-en="Your Journey" data-zh="ä½ çš„æ—…ç¨‹" data-es="Tu Viaje">Your Journey</span></h3>
                <div class="journey-path" id="journey-path"></div>
            </div>
            
            <!-- Current Situation -->
            <div class="info-panel flex-1">
                <h3 class="text-yellow-300 font-bold mb-3">ğŸ“ <span class="lang-text" data-en="Current Situation" data-zh="ç›®å‰ç‹€æ³" data-es="SituaciÃ³n Actual">Current Situation</span></h3>
                <div id="situation-text" class="text-lg mb-4"></div>
                
                <h4 class="text-blue-300 font-bold mb-3">ğŸ¯ <span class="lang-text" data-en="Choose Your Action" data-zh="é¸æ“‡ä½ çš„è¡Œå‹•" data-es="Elige Tu AcciÃ³n">Choose Your Action</span></h4>
                <div class="flex flex-wrap gap-4 justify-center" id="action-cards"></div>
                
                <div class="mt-4 text-center">
                    <button onclick="executeAction()" class="btn btn-primary" id="execute-btn" disabled>
                        <span class="lang-text" data-en="Make Decision" data-zh="åšå‡ºæ±ºå®š" data-es="Tomar DecisiÃ³n">Make Decision</span>
                    </button>
                </div>
            </div>
            
            <!-- Story/Result Panel -->
            <div class="info-panel" id="story-panel" style="display:none;">
                <div id="story-content" class="text-center"></div>
            </div>
        </div>
        
        <!-- Right: MDP Visualization -->
        <div class="lg:w-1/3 flex flex-col gap-4">
            <div class="info-panel">
                <h3 class="text-purple-300 font-bold mb-2">ğŸ§  <span class="lang-text" data-en="MDP Components" data-zh="MDP å…ƒä»¶" data-es="Componentes MDP">MDP Components</span></h3>
                <div class="text-sm space-y-2">
                    <div><span class="text-yellow-300">S</span> = <span class="lang-text" data-en="States (growth stages)" data-zh="ç‹€æ…‹ï¼ˆæˆé•·éšæ®µï¼‰" data-es="Estados (etapas de crecimiento)">States (growth stages)</span></div>
                    <div><span class="text-green-300">A</span> = <span class="lang-text" data-en="Actions (your choices)" data-zh="å‹•ä½œï¼ˆä½ çš„é¸æ“‡ï¼‰" data-es="Acciones (tus elecciones)">Actions (your choices)</span></div>
                    <div><span class="text-blue-300">P</span> = <span class="lang-text" data-en="Probability (uncertainty)" data-zh="æ©Ÿç‡ï¼ˆä¸ç¢ºå®šæ€§ï¼‰" data-es="Probabilidad (incertidumbre)">Probability (uncertainty)</span></div>
                    <div><span class="text-pink-300">R</span> = <span class="lang-text" data-en="Reward (inner joy)" data-zh="çå‹µï¼ˆå…§å¿ƒå–œæ‚…ï¼‰" data-es="Recompensa (alegrÃ­a interior)">Reward (inner joy)</span></div>
                    <div><span class="text-orange-300">Î³</span> = <span class="lang-text" data-en="Discount (0.9)" data-zh="æŠ˜æ‰£å› å­ (0.9)" data-es="Descuento (0.9)">Discount (0.9)</span></div>
                </div>
            </div>
            
            <div class="bellman-box">
                <h4 class="text-purple-300 font-bold mb-2">ğŸ“ Bellman Equation</h4>
                <div class="mono text-sm text-center" style="color:#fef3c7; text-shadow: 0 0 10px rgba(251, 191, 36, 0.5);">V*(s) = max<sub>a</sub> Î£ P(s'|s,a)[R + Î³V*(s')]</div>
                <p class="text-xs text-yellow-100/90 mt-2 text-center lang-text" data-en="Optimal value = best action's expected reward + future value" data-zh="æœ€å„ªåƒ¹å€¼ = æœ€ä½³è¡Œå‹•çš„æœŸæœ›çå‹µ + æœªä¾†åƒ¹å€¼" data-es="Valor Ã³ptimo = recompensa esperada de la mejor acciÃ³n + valor futuro">Optimal value = best action's expected reward + future value</p>
            </div>
            
            <div class="info-panel flex-1">
                <h3 class="text-blue-300 font-bold mb-2">ğŸ“Š <span class="lang-text" data-en="Value Iteration" data-zh="åƒ¹å€¼è¿­ä»£" data-es="IteraciÃ³n de Valor">Value Iteration</span></h3>
                <div class="value-display text-xs" id="value-display"></div>
            </div>
            
            <div class="info-panel">
                <h3 class="text-green-300 font-bold mb-2">ğŸ“ˆ <span class="lang-text" data-en="Statistics" data-zh="çµ±è¨ˆ" data-es="EstadÃ­sticas">Statistics</span></h3>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div><span class="lang-text" data-en="Week" data-zh="é€±æ•¸" data-es="Semana">Week</span>: <span id="week-display" class="text-yellow-300">1</span></div>
                    <div><span class="lang-text" data-en="Stage" data-zh="éšæ®µ" data-es="Etapa">Stage</span>: <span id="stage-display" class="text-green-300">1/6</span></div>
                    <div><span class="lang-text" data-en="Joy" data-zh="å–œæ‚…" data-es="AlegrÃ­a">Joy</span>: <span id="joy-display" class="text-pink-300">0</span></div>
                    <div><span class="lang-text" data-en="Impact" data-zh="å½±éŸ¿" data-es="Impacto">Impact</span>: <span id="impact-display" class="text-blue-300">0</span></div>
                </div>
            </div>
            
            <div class="info-panel" style="background:rgba(236, 72, 153, 0.15);border-color:rgba(236, 72, 153, 0.4);">
                <div class="text-pink-300 font-bold text-sm">ğŸ“ Russell & Norvig Ch. 17</div>
                <div class="text-xs mt-1">â€¢ Markov Decision Processes<br>â€¢ Value Iteration Algorithm<br>â€¢ Bellman Optimality Equation</div>
            </div>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 3: MEDITATION GATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="meditation-screen" class="screen flex-col items-center justify-center p-6" style="background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);">
    <div class="absolute inset-0" style="background: url('L3_p7_lotus_.png') center center/cover no-repeat; opacity: 0.85;"></div>
    
    <div class="relative z-10 text-center">
        <h2 class="text-3xl font-bold text-white mb-8 lang-text" style="text-shadow: 0 0 30px rgba(251, 191, 36, 0.8);" data-en="Ataraxy Portico" data-zh="éœå¿ƒä¹‹é–€" data-es="Portal de Serenidad">éœå¿ƒä¹‹é–€</h2>
        
        <div class="breath-ring mx-auto mb-6">
            <span id="breath-counter" class="text-3xl font-bold mono" style="color: #fbbf24; text-shadow: 0 0 15px rgba(251, 191, 36, 0.8), 0 0 30px rgba(251, 191, 36, 0.5); transition: transform 0.5s ease-in-out;">æº–å‚™...</span>
        </div>
        
        <p class="text-lg mb-8 lang-text" style="color: #fcd34d; text-shadow: 0 0 10px rgba(251, 191, 36, 0.6);" data-en="Follow the breathing..." data-zh="è·Ÿéš¨å‘¼å¸..." data-es="Sigue la respiraciÃ³n...">è·Ÿéš¨å‘¼å¸...</p>
        
        <div class="jingsi-card max-w-lg mx-auto mb-8">
            <p class="text-xl font-bold text-yellow-300 mb-3 lang-text" data-en="ã€ŒWilling to do, happy to receiveã€" data-zh="ã€Œç”˜é¡˜åšï¼Œæ­¡å–œå—ã€" data-es="ã€ŒDispuesto a hacer, feliz de recibirã€">ã€ŒWilling to do, happy to receiveã€</p>
            <p class="text-white/90 mb-4 lang-text" data-en="Maya's journey shows us: every choice matters. From receiving help to giving it â€” transformation happens one decision at a time." data-zh="ç‘ªé›…çš„æ—…ç¨‹å‘Šè¨´æˆ‘å€‘ï¼šæ¯å€‹é¸æ“‡éƒ½é‡è¦ã€‚å¾æ¥å—å¹«åŠ©åˆ°ä»˜å‡ºå¹«åŠ©â€”â€”è½‰è®Šæ˜¯ä¸€å€‹æ±ºå®šä¸€å€‹æ±ºå®šç´¯ç©çš„ã€‚" data-es="El viaje de Maya nos muestra: cada elecciÃ³n importa. De recibir ayuda a darla â€” la transformaciÃ³n sucede una decisiÃ³n a la vez.">Maya's journey shows us: every choice matters. From receiving help to giving it â€” transformation happens one decision at a time.</p>
            <p class="text-purple-200 text-sm lang-text" data-en="â€” Master Cheng Yen" data-zh="â€” è­‰åš´ä¸Šäºº" data-es="â€” Maestra Cheng Yen">â€” Master Cheng Yen</p>
        </div>
        
        <div class="info-panel mx-auto mb-6" style="max-width: 500px; background: rgba(0,0,0,0.25);">
            <p class="text-sm text-white/90 lang-text" data-en="ğŸ§  MDP Insight: The algorithm modeled Maya's decisions, but her real journey was shaped by agency, relationships, and choices no probability can fully capture." data-zh="ğŸ§  MDP åæ€ï¼šæ¼”ç®—æ³•æ¨¡æ“¬äº†ç‘ªé›…çš„æ±ºç­–ï¼Œä½†å¥¹çœŸæ­£çš„æ—…ç¨‹æ˜¯ç”±ä¸»é«”æ€§ã€é—œä¿‚å’Œé¸æ“‡å¡‘é€ çš„â€”â€”é€™äº›æ˜¯æ©Ÿç‡ç„¡æ³•å®Œå…¨æ•æ‰çš„ã€‚" data-es="ğŸ§  ReflexiÃ³n MDP: El algoritmo modelÃ³ las decisiones de Maya, pero su verdadero viaje fue moldeado por la voluntad, las relaciones y las elecciones que ninguna probabilidad puede capturar completamente.">ğŸ§  MDP Insight: The algorithm modeled Maya's decisions, but her real journey was shaped by agency, relationships, and choices no probability can fully capture.</p>
        </div>
        
        <div class="flex flex-wrap gap-4 justify-center">
            <button onclick="goToMainMenu()" class="btn btn-secondary lang-text" data-en="ğŸ  Main Menu" data-zh="ğŸ  ä¸»é é¢" data-es="ğŸ  MenÃº">ğŸ  Main Menu</button>
            <button onclick="backToGame()" class="btn btn-secondary lang-text" data-en="â† Play Again" data-zh="â† å†ç©ä¸€æ¬¡" data-es="â† Jugar de nuevo">â† Play Again</button>
            <button onclick="goToNextLevel()" class="btn btn-primary lang-text" data-en="Level 4: KB-Agent â†’" data-zh="ç¬¬å››é—œï¼šKB-Agent â†’" data-es="Nivel 4: KB-Agent â†’">Level 4: KB-Agent â†’</button>
        </div>
    </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIGURATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentLang = 'en';
let currentStage = 0;
let selectedAction = null;
let musicPlaying = false;
let gameStats = { week: 1, joy: 0, impact: 0, elo: 1200 };

const bgMusic = document.getElementById('bgMusic');
const meditationMusic = document.getElementById('meditationMusic');
const levelUpSound = document.getElementById('levelUpSound');

// MDP States
const STAGES = [
    { id: 'newcomer', emoji: 'ğŸ‘€', en: 'Newcomer', zh: 'æ–°æœ‹å‹', value: 0, bg: 'L3_p1.png' },
    { id: 'curious', emoji: 'ğŸ¤”', en: 'Curious', zh: 'å¥½å¥‡è€…', value: 2, bg: 'L3_p2.png' },
    { id: 'helper', emoji: 'ğŸ¤', en: 'Helper', zh: 'å¹«æ‰‹', value: 5, bg: 'L3_p3.png' },
    { id: 'regular', emoji: 'ğŸ’ª', en: 'Regular', zh: 'å¸¸å®¢', value: 10, bg: 'L3_p4.png' },
    { id: 'mentor', emoji: 'ğŸŒŸ', en: 'Mentor', zh: 'å°å¸«', value: 18, bg: 'L3_p5.png' },
    { id: 'leader', emoji: 'ğŸ“', en: 'Leader', zh: 'é ˜è¢–', value: 30, bg: 'L3_p6.png' }
];

// Situations
const SITUATIONS = {
    newcomer: {
        en: "It's a Saturday morning in Hunters Point. Maya, a single mother, has heard about Tzu Chi's food distribution. She hesitates outside the community center, watching volunteers in blue vests setting up tables with fresh vegetables...",
        zh: "çµäººè§’çš„ä¸€å€‹é€±å…­æ—©æ™¨ã€‚å–®è¦ªåª½åª½ç‘ªé›…è½èªªæ…ˆæ¿Ÿåœ¨ç™¼æ”¾é£Ÿç‰©ã€‚å¥¹åœ¨ç¤¾å€ä¸­å¿ƒå¤–é¢çŒ¶è±«è‘—ï¼Œçœ‹è‘—ç©¿è—è‰²èƒŒå¿ƒçš„å¿—å·¥å€‘æ“ºæ”¾æ–°é®®è”¬èœ..."
    },
    curious: {
        en: "Maya came back the next week. A warm volunteer named Sister Roxanne noticed her watching. 'Would you like to help sort these tomatoes? Many hands make light work!' No pressure, just a gentle invitation...",
        zh: "ç‘ªé›…ä¸‹é€±åˆä¾†äº†ã€‚ä¸€ä½æº«æš–çš„å¿—å·¥ Roxanne å¸«å§Šæ³¨æ„åˆ°å¥¹åœ¨æ—é‚Šçœ‹ã€‚ã€Œè¦ä¸è¦ä¾†å¹«å¿™åˆ†é¡é€™äº›ç•ªèŒ„ï¼Ÿäººå¤šå¥½è¾¦äº‹ï¼ã€æ²’æœ‰å£“åŠ›ï¼Œåªæ˜¯è¼•è¼•çš„é‚€è«‹..."
    },
    helper: {
        en: "Maya has helped several times now. The other volunteers treat her like family. Today, Sister Roxanne mentions a training workshop. 'It's totally optional,' she says with a smile, 'but I think you'd enjoy learning about our mission.'",
        zh: "ç‘ªé›…å·²ç¶“å¹«å¿™äº†å¥½å¹¾æ¬¡ã€‚å…¶ä»–å¿—å·¥æŠŠå¥¹ç•¶å®¶äººã€‚ä»Šå¤©ï¼ŒRoxanne å¸«å§Šæåˆ°ä¸€å€‹åŸ¹è¨“å·¥ä½œåŠã€‚ã€Œå®Œå…¨è‡ªé¡˜ï¼Œã€å¥¹å¾®ç¬‘è‘—èªªï¼Œã€Œä½†æˆ‘è¦ºå¾—ä½ æœƒå–œæ­¡äº†è§£æˆ‘å€‘çš„ä½¿å‘½ã€‚ã€"
    },
    regular: {
        en: "A year has passed. Maya knows everyone's names now. A teenage boy named Marcus asks shyly if she can teach him how to organize the vegetable boxes. 'You're so good at this, Miss Maya...' She feels something shift inside her.",
        zh: "ä¸€å¹´éå»äº†ã€‚ç‘ªé›…ç¾åœ¨èªè­˜æ¯å€‹äººçš„åå­—ã€‚ä¸€å€‹å« Marcus çš„é’å°‘å¹´å®³ç¾åœ°å•å¥¹èƒ½ä¸èƒ½æ•™ä»–æ•´ç†è”¬èœç®±ã€‚ã€Œç‘ªé›…å§å§ï¼Œä½ åšå¾—å¥½å¥½å–”...ã€å¥¹å¿ƒè£¡æœ‰ä»€éº¼æ±è¥¿é–‹å§‹è½‰è®Šã€‚"
    },
    mentor: {
        en: "Two years of mentoring new volunteers. Maya has watched many people grow, just as she once did. Sister Roxanne pulls her aside one day: 'Maya, we see your dedication. Would you consider the Commissioner certification training?' Maya's heart races...",
        zh: "å…©å¹´çš„å¸¶é ˜æ–°å¿—å·¥ã€‚ç‘ªé›…çœ‹è‘—è¨±å¤šäººæˆé•·ï¼Œå°±åƒç•¶åˆçš„å¥¹ä¸€æ¨£ã€‚æœ‰ä¸€å¤© Roxanne å¸«å§ŠæŠŠå¥¹æ‹‰åˆ°ä¸€æ—ï¼šã€Œç‘ªé›…ï¼Œæˆ‘å€‘çœ‹åˆ°ä½ çš„ä»˜å‡ºã€‚ä½ é¡˜æ„è€ƒæ…®å§”å“¡èªè­‰åŸ¹è¨“å—ï¼Ÿã€ç‘ªé›…çš„å¿ƒè·³åŠ é€Ÿ..."
    },
    leader: {
        en: "ğŸ‰ Maya did it! From a single mother seeking food assistance to the first local female Commissioner from Hunters Point. The same community center where she once hesitated to enter â€” she now leads with grace and compassion. Her journey has come full circle.",
        zh: "ğŸ‰ ç‘ªé›…åšåˆ°äº†ï¼å¾å°‹æ±‚é£Ÿç‰©æ´åŠ©çš„å–®è¦ªåª½åª½ï¼Œåˆ°çµäººè§’ç¬¬ä¸€ä½æœ¬åœŸå¥³å§”å“¡ã€‚ç•¶åˆå¥¹çŒ¶è±«è‘—ä¸æ•¢é€²å…¥çš„ç¤¾å€ä¸­å¿ƒâ€”â€”ç¾åœ¨å¥¹ä»¥å„ªé›…å’Œæ…ˆæ‚²åœ¨é€™è£¡å¸¶é ˜ã€‚å¥¹çš„æ—…ç¨‹ç•«äº†ä¸€å€‹å®Œæ•´çš„åœ“ã€‚"
    }
};

// Actions
const ACTIONS = {
    newcomer: [
        { id: 'observe', emoji: 'ğŸ‘€', en: 'Just watch', zh: 'åªæ˜¯çœ‹çœ‹', prob: { stay: 0.6, advance: 0.4 }, reward: 1 },
        { id: 'approach', emoji: 'ğŸ‘‹', en: 'Say hello', zh: 'æ‰“å€‹æ‹›å‘¼', prob: { stay: 0.3, advance: 0.7 }, reward: 3 },
        { id: 'leave', emoji: 'ğŸ ', en: 'Go home', zh: 'å›å®¶', prob: { stay: 1.0, advance: 0 }, reward: 0 }
    ],
    curious: [
        { id: 'decline', emoji: 'ğŸ™…', en: 'Not today', zh: 'ä»Šå¤©ä¸è¡Œ', prob: { stay: 0.7, advance: 0.3 }, reward: 1 },
        { id: 'help_once', emoji: 'ğŸ¤', en: 'Help today', zh: 'ä»Šå¤©å¹«å¿™', prob: { stay: 0.2, advance: 0.8 }, reward: 5 },
        { id: 'leave', emoji: 'ğŸ ', en: 'Just take food', zh: 'åªæ‹¿é£Ÿç‰©', prob: { stay: 0.9, advance: 0.1 }, reward: 0 }
    ],
    helper: [
        { id: 'occasional', emoji: 'ğŸ“…', en: 'Come sometimes', zh: 'å¶çˆ¾ä¾†', prob: { stay: 0.5, advance: 0.5 }, reward: 3 },
        { id: 'training', emoji: 'ğŸ“š', en: 'Join training', zh: 'åƒåŠ åŸ¹è¨“', prob: { stay: 0.1, advance: 0.9 }, reward: 8 },
        { id: 'pause', emoji: 'â¸ï¸', en: 'Take a break', zh: 'ä¼‘æ¯ä¸€ä¸‹', prob: { stay: 0.8, advance: 0.2 }, reward: 1 }
    ],
    regular: [
        { id: 'continue', emoji: 'ğŸ’ª', en: 'Keep helping', zh: 'ç¹¼çºŒå¹«å¿™', prob: { stay: 0.4, advance: 0.6 }, reward: 5 },
        { id: 'mentor', emoji: 'ğŸŒŸ', en: 'Mentor Marcus', zh: 'æŒ‡å° Marcus', prob: { stay: 0.1, advance: 0.9 }, reward: 12 },
        { id: 'reduce', emoji: 'ğŸ“‰', en: 'Reduce time', zh: 'æ¸›å°‘æ™‚é–“', prob: { stay: 0.7, advance: 0.3 }, reward: 2 }
    ],
    mentor: [
        { id: 'decline_cert', emoji: 'ğŸ™', en: 'Not ready yet', zh: 'é‚„æ²’æº–å‚™å¥½', prob: { stay: 0.6, advance: 0.4 }, reward: 5 },
        { id: 'accept_cert', emoji: 'ğŸ“', en: 'Accept training', zh: 'æ¥å—åŸ¹è¨“', prob: { stay: 0.05, advance: 0.95 }, reward: 20 },
        { id: 'think', emoji: 'ğŸ¤”', en: 'Think about it', zh: 'è€ƒæ…®ä¸€ä¸‹', prob: { stay: 0.4, advance: 0.6 }, reward: 3 }
    ]
};

const VALUES = { newcomer: 15.2, curious: 18.7, helper: 22.4, regular: 26.8, mentor: 28.5, leader: 30.0 };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MUSIC CONTROL - FIXED
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleMusic() {
    if (musicPlaying) {
        bgMusic.pause();
        meditationMusic.pause();
        musicPlaying = false;
    } else {
        const currentScreen = document.querySelector('.screen.active');
        if (currentScreen.id === 'meditation-screen') {
            meditationMusic.volume = 0.4;
            meditationMusic.play().catch(e => console.log('Audio error:', e));
        } else {
            bgMusic.volume = 0.3;
            bgMusic.play().catch(e => console.log('Audio error:', e));
        }
        musicPlaying = true;
    }
    updateMusicButtons();
}

function updateMusicButtons() {
    const btns = document.querySelectorAll('.music-btn');
    btns.forEach(btn => {
        btn.textContent = musicPlaying ? 'ğŸ”Š' : 'ğŸ”‡';
        btn.classList.toggle('playing', musicPlaying);
    });
}

function switchToMeditationMusic() {
    bgMusic.pause();
    if (musicPlaying) {
        meditationMusic.volume = 0.4;
        meditationMusic.play().catch(e => console.log('Audio error:', e));
    }
}

function playLevelUpSound() {
    // Create a simple level up sound
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
    oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
    oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
    
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.4);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LANGUAGE SYSTEM - FIXED
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setLanguage(lang) {
    currentLang = lang;
    
    // Update toggle buttons
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-lang') === lang);
    });
    
    // Update all text elements
    document.querySelectorAll('.lang-text').forEach(el => {
        const text = el.getAttribute(`data-${lang}`) || el.getAttribute('data-en');
        if (text) el.textContent = text;
    });
    
    // Re-render game elements if in game
    if (document.getElementById('game-screen').classList.contains('active')) {
        renderJourneyPath();
        renderSituation();
        renderActions();
        updateValueDisplay();
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREEN MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
}

function startGame() {
    currentStage = 0;
    gameStats = { week: 1, joy: 0, impact: 0, elo: 1200 };
    selectedAction = null;
    
    showScreen('game-screen');
    renderJourneyPath();
    renderSituation();
    renderActions();
    updateStats();
    updateValueDisplay();
    
    // Start music if not playing
    if (!musicPlaying) {
        toggleMusic();
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderJourneyPath() {
    const container = document.getElementById('journey-path');
    container.innerHTML = '';
    
    STAGES.forEach((stage, idx) => {
        const node = document.createElement('div');
        node.className = 'stage-node';
        if (idx < currentStage) node.classList.add('completed');
        else if (idx === currentStage) node.classList.add('current');
        else node.classList.add('locked');
        
        const label = currentLang === 'en' ? stage.en : stage.zh;
        node.innerHTML = `<span>${stage.emoji}</span>`;
        
        const labelDiv = document.createElement('div');
        labelDiv.className = 'stage-label';
        labelDiv.textContent = label;
        
        const wrapper = document.createElement('div');
        wrapper.className = 'flex flex-col items-center';
        wrapper.appendChild(node);
        wrapper.appendChild(labelDiv);
        container.appendChild(wrapper);
        
        if (idx < STAGES.length - 1) {
            const connector = document.createElement('div');
            connector.className = 'path-connector';
            if (idx < currentStage) connector.classList.add('active');
            container.appendChild(connector);
        }
    });
}

function renderSituation() {
    const stageId = STAGES[currentStage].id;
    const situation = SITUATIONS[stageId];
    const text = currentLang === 'en' ? situation.en : situation.zh;
    document.getElementById('situation-text').innerHTML = `<p class="leading-relaxed">${text}</p>`;
    document.getElementById('story-panel').style.display = 'none';
}

function renderActions() {
    const container = document.getElementById('action-cards');
    container.innerHTML = '';
    
    const stageId = STAGES[currentStage].id;
    
    if (stageId === 'leader') {
        const congratsText = currentLang === 'en' ? "Congratulations! You've completed the journey!" : "æ­å–œï¼ä½ å®Œæˆäº†æ—…ç¨‹ï¼";
        const btnText = currentLang === 'en' ? "Enter Gate of Serenity ğŸ™" : "é€²å…¥éœå¿ƒä¹‹é–€ ğŸ™";
        container.innerHTML = `
            <div class="text-center">
                <p class="text-2xl mb-4">ğŸ‰</p>
                <p class="text-yellow-300 text-lg mb-4">${congratsText}</p>
                <button onclick="openMeditationGate()" class="btn btn-primary">${btnText}</button>
            </div>
        `;
        document.getElementById('execute-btn').style.display = 'none';
        if (typeof confetti === 'function') confetti({ particleCount: 150, spread: 80 });
        return;
    }
    
    const actions = ACTIONS[stageId];
    if (!actions) return;
    
    actions.forEach(action => {
        const card = document.createElement('div');
        card.className = 'action-card';
        card.onclick = () => selectAction(action.id);
        card.id = `action-${action.id}`;
        
        const advanceProb = Math.round(action.prob.advance * 100);
        const actionName = currentLang === 'en' ? action.en : action.zh;
        const growthText = currentLang === 'en' ? 'Growth chance' : 'æˆé•·æ©Ÿç‡';
        const joyText = currentLang === 'en' ? 'joy' : 'å–œæ‚…';
        
        card.innerHTML = `
            <div class="action-icon">${action.emoji}</div>
            <div class="font-bold text-white mb-2">${actionName}</div>
            <div class="text-xs text-white/70 mb-2">${growthText}: ${advanceProb}%</div>
            <div class="prob-bar">
                <div class="prob-fill" style="width: ${advanceProb}%; background: linear-gradient(90deg, var(--soft-green), var(--warm-gold));"></div>
            </div>
            <div class="text-xs text-pink-300 mt-2">+${action.reward} ${joyText}</div>
        `;
        container.appendChild(card);
    });
    
    document.getElementById('execute-btn').style.display = 'inline-block';
    document.getElementById('execute-btn').disabled = true;
}

function selectAction(actionId) {
    selectedAction = actionId;
    document.querySelectorAll('.action-card').forEach(card => card.classList.remove('selected'));
    document.getElementById(`action-${actionId}`).classList.add('selected');
    document.getElementById('execute-btn').disabled = false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function executeAction() {
    if (!selectedAction) return;
    
    const stageId = STAGES[currentStage].id;
    const actions = ACTIONS[stageId];
    const action = actions.find(a => a.id === selectedAction);
    
    gameStats.joy += action.reward;
    gameStats.impact += Math.floor(action.reward / 2);
    gameStats.week++;
    
    const roll = Math.random();
    const advances = roll < action.prob.advance;
    
    showResult(action, advances);
    
    if (advances && currentStage < STAGES.length - 1) {
        currentStage++;
        gameStats.elo += 30;
        playLevelUpSound();
    } else {
        gameStats.elo += 5;
    }
    
    setTimeout(() => {
        renderJourneyPath();
        renderSituation();
        renderActions();
        updateStats();
        updateValueDisplay();
        selectedAction = null;
    }, 2000);
}

function showResult(action, advances) {
    const panel = document.getElementById('story-panel');
    const content = document.getElementById('story-content');
    
    let message;
    if (advances) {
        const nextStage = STAGES[currentStage + 1];
        const nextName = currentLang === 'en' ? nextStage.en : nextStage.zh;
        message = currentLang === 'en' 
            ? `âœ¨ Your choice led to growth! Moving to: ${nextStage.emoji} ${nextName}`
            : `âœ¨ ä½ çš„é¸æ“‡å¸¶ä¾†æˆé•·ï¼å‰é€²åˆ°ï¼š${nextStage.emoji} ${nextName}`;
    } else {
        message = currentLang === 'en'
            ? `ğŸŒ± Sometimes growth takes time. Every experience matters. +${action.reward} joy`
            : `ğŸŒ± æˆé•·æœ‰æ™‚éœ€è¦æ™‚é–“ã€‚æ¯å€‹ç¶“æ­·éƒ½å¾ˆé‡è¦ã€‚+${action.reward} å–œæ‚…`;
    }
    
    content.innerHTML = `<p class="text-lg ${advances ? 'text-green-300' : 'text-yellow-300'}">${message}</p>`;
    panel.style.display = 'block';
    panel.classList.add('fade-in');
}

function updateStats() {
    document.getElementById('week-display').textContent = gameStats.week;
    document.getElementById('stage-display').textContent = `${currentStage + 1}/${STAGES.length}`;
    document.getElementById('joy-display').textContent = gameStats.joy;
    document.getElementById('impact-display').textContent = gameStats.impact;
    document.getElementById('elo-display').textContent = gameStats.elo;
    
    // Update scene background
    const bgElement = document.getElementById('scene-background');
    if (bgElement && STAGES[currentStage]) {
        bgElement.style.backgroundImage = `url('${STAGES[currentStage].bg}')`;
    }
}

function updateValueDisplay() {
    const display = document.getElementById('value-display');
    let html = '<div class="space-y-1">';
    
    STAGES.forEach((stage, idx) => {
        const isCurrent = idx === currentStage;
        const color = isCurrent ? 'text-yellow-300' : (idx < currentStage ? 'text-green-300' : 'text-white/50');
        const marker = isCurrent ? 'â†’ ' : '  ';
        html += `<div class="${color}">${marker}V(${stage.id.substring(0,3)}) = ${VALUES[stage.id].toFixed(1)}</div>`;
    });
    
    html += '</div>';
    const policyText = currentLang === 'en' ? 'Optimal policy: Choose actions with highest expected value' : 'æœ€å„ªç­–ç•¥ï¼šé¸æ“‡æœŸæœ›åƒ¹å€¼æœ€é«˜çš„è¡Œå‹•';
    html += `<div class="mt-3 pt-3 border-t border-white/20 text-xs text-white/70">${policyText}</div>`;
    display.innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MEDITATION GATE - æ·±å‘¼å¸/åæ°£ å¾ªç’°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openMeditationGate() {
    showScreen('meditation-screen');
    switchToMeditationMusic();
    
    const counter = document.getElementById('breath-counter');
    const breathTexts = {
        inhale: { en: 'Inhale...', zh: 'æ·±å‘¼å¸...', es: 'Inhala...' },
        exhale: { en: 'Exhale...', zh: 'åæ°£...', es: 'Exhala...' },
        done: 'ğŸ™'
    };
    
    let cycle = 0;
    const totalCycles = 3;
    
    function breathCycle() {
        if (cycle >= totalCycles) {
            counter.textContent = breathTexts.done;
            return;
        }
        
        // æ·±å‘¼å¸ 4ç§’
        counter.textContent = breathTexts.inhale[currentLang] || breathTexts.inhale.en;
        counter.style.transform = 'scale(1.2)';
        
        setTimeout(() => {
            // åæ°£ 4ç§’
            counter.textContent = breathTexts.exhale[currentLang] || breathTexts.exhale.en;
            counter.style.transform = 'scale(0.9)';
            
            setTimeout(() => {
                cycle++;
                counter.style.transform = 'scale(1)';
                breathCycle();
            }, 4000);
        }, 4000);
    }
    
    // é–‹å§‹å‘¼å¸å¾ªç’°
    setTimeout(breathCycle, 1000);
}

function backToGame() {
    meditationMusic.pause();
    if (musicPlaying) {
        bgMusic.play().catch(e => console.log('Audio error:', e));
    }
    startGame();
}

function goToMainMenu() {
    meditationMusic.pause();
    bgMusic.pause();
    // è¿”å›ä¸»é é¢ï¼ˆindex.htmlï¼‰
    window.location.href = '../index.html';
}

function goToNextLevel() {
    meditationMusic.pause();
    bgMusic.pause();
    // å‰å¾€ç¬¬å››é—œ
    window.location.href = '../level4/index.html';
}

function goBack() {
    const msg = currentLang === 'en' ? 'Return to main menu?' : 'è¿”å›ä¸»é¸å–®ï¼Ÿ';
    if (confirm(msg)) {
        bgMusic.pause();
        meditationMusic.pause();
        window.location.href = '../index.html';
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', () => {
    setLanguage('en');
    if (bgMusic) bgMusic.volume = 0.3;
    if (meditationMusic) meditationMusic.volume = 0.4;
    updateMusicButtons();
    console.log('Level 3 MDP - Sister Maya\'s Journey loaded!');
});
</script>

</body>
</html>
