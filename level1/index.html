<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google" content="notranslate">
    <title>å–„çš„æ—…ç¨‹ Journey of Kindness | Level 1: A* Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Noto Sans TC', sans-serif; box-sizing: border-box; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        .screen { display: none; min-height: 100vh; position: relative; }
        .screen.active { display: flex; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulseGlow { 0%, 100% { box-shadow: 0 0 15px rgba(236, 72, 153, 0.5); } 50% { box-shadow: 0 0 30px rgba(236, 72, 153, 0.8); } }
        @keyframes playerMove { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
        @keyframes breatheRing { 0%, 100% { transform: scale(0.8); opacity: 0.6; } 50% { transform: scale(1.3); opacity: 1; } }
        @keyframes breatheCard { 0%, 100% { transform: scale(0.97); box-shadow: 0 8px 32px rgba(251, 191, 36, 0.2); } 50% { transform: scale(1.03); box-shadow: 0 12px 48px rgba(251, 191, 36, 0.5); } }
        
        .fade-in { animation: fadeIn 0.8s ease-out; }
        .pulse-glow { animation: pulseGlow 2s infinite; }
        
        .bg-hunters-point {
            background: url('../assets/images/hunters_point_map.png') center center/cover no-repeat;
            background-color: #2d4a3e;
        }
        
        .breath-ring {
            width: 150px; height: 150px; border-radius: 50%;
            border: 5px solid rgba(251, 191, 36, 0.8);
            animation: breatheRing 4s ease-in-out infinite;
            box-shadow: 0 0 40px rgba(251, 191, 36, 0.5), inset 0 0 40px rgba(251, 191, 36, 0.2);
        }
        
        .breath-ring-large {
            width: 180px; height: 180px; border-radius: 50%;
            border: 6px solid rgba(251, 191, 36, 0.9);
            animation: breatheRing 4s ease-in-out infinite;
            box-shadow: 0 0 60px rgba(251, 191, 36, 0.6), inset 0 0 50px rgba(251, 191, 36, 0.3);
            display: flex; align-items: center; justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
        }
        
        .jingsi-card {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.35), rgba(168, 85, 247, 0.3)); 
            backdrop-filter: blur(6px);
            border-radius: 20px; padding: 1.5rem 2.5rem; max-width: 480px;
            text-align: center; border: 2px solid rgba(251, 191, 36, 0.5);
        }
        .breathing-card {
            animation: breatheCard 4s ease-in-out infinite;
        }
        
        .astar-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; width: 100%; max-width: 580px; margin: 0 auto; padding: 0.75rem; background: rgba(0, 0, 0, 0.3); border-radius: 16px; }
        .astar-cell { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; transition: all 0.2s; position: relative; font-size: 1.6rem; min-height: 55px; border: 2px solid rgba(255, 255, 255, 0.2); background: rgba(255, 255, 255, 0.15); }
        .astar-cell:hover:not(.obstacle) { transform: scale(1.05); border-color: rgba(255, 255, 255, 0.5); }
        .astar-cell.player { background: linear-gradient(135deg, #3b82f6, #2563eb); border-color: #60a5fa; box-shadow: 0 0 15px rgba(59, 130, 246, 0.6); animation: playerMove 0.3s; }
        .astar-cell.goal { background: linear-gradient(135deg, #f97316, #ea580c); border-color: #fb923c; }
        .astar-cell.garcia { background: linear-gradient(135deg, #ec4899, #db2777); border-color: #f472b6; animation: pulseGlow 2s infinite; }
        .astar-cell.obstacle { background: rgba(100, 116, 139, 0.7); cursor: not-allowed; }
        .astar-cell.visited { background: rgba(168, 85, 247, 0.5); }
        .astar-cell.adjacent { background: rgba(34, 197, 94, 0.35); border-color: rgba(34, 197, 94, 0.7); }
        .astar-cell.ai-current { background: linear-gradient(135deg, #fbbf24, #f59e0b); border-color: #fcd34d; }
        .astar-cell.ai-path { background: rgba(251, 191, 36, 0.35); }
        .f-score { position: absolute; bottom: 1px; right: 2px; font-size: 0.5rem; color: rgba(255,255,255,0.7); background: rgba(0,0,0,0.4); padding: 0 2px; border-radius: 2px; }
        
        .side-panel { background: rgba(30, 58, 95, 0.95); backdrop-filter: blur(15px); border-radius: 16px; border: 1px solid rgba(255,255,255,0.2); width: 280px; }
        .formula-box { background: rgba(255,255,255,0.1); border-radius: 10px; padding: 0.75rem; border-left: 4px solid #fbbf24; }
        .stat-card { background: rgba(255,255,255,0.1); border-radius: 8px; padding: 0.4rem; text-align: center; }
        .stat-value { font-size: 1.2rem; font-weight: bold; }
        
        .controls-bar { background: rgba(30, 58, 95, 0.95); border-radius: 12px; padding: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.4rem; justify-content: center; }
        .ctrl-btn { padding: 0.4rem 0.7rem; border-radius: 8px; font-weight: 600; font-size: 0.75rem; cursor: pointer; border: 2px solid; display: flex; align-items: center; gap: 4px; transition: all 0.2s; }
        .ctrl-btn:hover:not(:disabled) { transform: translateY(-2px); }
        .ctrl-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .ctrl-btn.ai-auto { background: linear-gradient(135deg, #fbbf24, #f59e0b); border-color: #fcd34d; color: #1f2937; }
        .ctrl-btn.forward { background: rgba(34, 197, 94, 0.3); border-color: #22c55e; color: #22c55e; }
        .ctrl-btn.backward { background: rgba(239, 68, 68, 0.3); border-color: #ef4444; color: #ef4444; }
        .ctrl-btn.player-btn { background: rgba(59, 130, 246, 0.3); border-color: #3b82f6; color: #3b82f6; }
        .ctrl-btn.reset { background: rgba(100, 116, 139, 0.5); border-color: #64748b; color: white; }
        .ctrl-btn.complete { background: linear-gradient(135deg, #22c55e, #16a34a); border-color: #4ade80; color: white; }
        .ctrl-btn.sound { background: rgba(168, 85, 247, 0.3); border-color: #a855f7; color: #a855f7; }
        
        .story-box { background: rgba(30, 58, 95, 0.95); border-radius: 12px; border: 2px solid rgba(236, 72, 153, 0.5); padding: 1rem; max-width: 580px; margin: 0 auto; }
        .character-avatar { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; border: 2px solid white; }
        .decision-btn { padding: 0.6rem 1rem; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; font-size: 0.85rem; }
        .decision-btn:hover { transform: translateY(-2px); }
        .decision-btn.override { background: linear-gradient(135deg, #ec4899, #db2777); color: white; }
        .decision-btn.follow { background: rgba(100, 116, 139, 0.8); color: white; }
        
        .btn { padding: 0.6rem 1.2rem; border-radius: 9999px; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; }
        .btn:hover { transform: scale(1.03); }
        .btn-primary { background: linear-gradient(135deg, #ec4899, #8b5cf6); color: white; }
        .btn-secondary { background: rgba(100, 116, 139, 0.8); color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .lang-toggle { position: fixed; top: 10px; z-index: 1000; display: flex; background: rgba(0,0,0,0.6); border-radius: 9999px; padding: 3px; border: 2px solid rgba(255,255,255,0.3); }
        .lang-btn { padding: 0.3rem 0.7rem; border-radius: 9999px; font-weight: 600; font-size: 0.8rem; cursor: pointer; border: none; background: transparent; color: rgba(255,255,255,0.6); }
        .lang-btn.active { background: linear-gradient(135deg, #ec4899, #8b5cf6); color: white; }
        
        .instructions-box { background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(59, 130, 246, 0.15)); border: 2px solid rgba(34, 197, 94, 0.4); border-radius: 10px; padding: 0.5rem; }
        .instruction-item { display: flex; align-items: center; gap: 0.25rem; font-size: 0.65rem; }
        .instruction-icon { width: 20px; height: 20px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; }
        
        .game-header { display: flex; justify-content: space-between; align-items: center; padding: 0.4rem 0.8rem; background: rgba(0,0,0,0.5); border-radius: 10px; }
        .elo-badge { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #1f2937; padding: 0.3rem 0.8rem; border-radius: 9999px; font-weight: bold; font-size: 0.85rem; }
        
        .start-btn {
            width: 120px; height: 120px; border-radius: 50%;
            background: linear-gradient(135deg, #ec4899, #8b5cf6);
            border: 4px solid white; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 3rem; color: white;
            box-shadow: 0 0 40px rgba(236, 72, 153, 0.6);
            transition: all 0.3s;
        }
        .start-btn:hover { transform: scale(1.1); box-shadow: 0 0 60px rgba(236, 72, 153, 0.8); }
        
        /* éœå¿ƒä¹‹é–€èƒŒæ™¯ */
        .ataraxy-bg {
            background: url('../assets/images/éœå¿ƒä¹‹é–€.png') center top/auto 100% no-repeat,
                        linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
        }
        
        @media (max-width: 1100px) { .game-layout { flex-direction: column !important; } .side-panel { width: 100%; max-width: 520px; margin: 0 auto; } }
        @media (max-width: 640px) { .astar-cell { min-height: 38px; font-size: 1.1rem; } .f-score { display: none; } }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>
<body class="text-white min-h-screen" translate="no">

<!-- Language Toggle - Top Left with ES -->
<div class="lang-toggle" style="left: 10px; right: auto;">
    <button id="lang-en" class="lang-btn" onclick="setLang('en')">EN</button>
    <button id="lang-zh" class="lang-btn active" onclick="setLang('zh')">ä¸­</button>
    <button id="lang-es" class="lang-btn" onclick="setLang('es')">ES</button>
</div>

<!-- Audio elements - ä¿®æ­£è·¯å¾‘ -->
<audio id="bg-music" src="../assets/audio/welcome_mp3.mp3" loop></audio>
<audio id="meditation-music" src="../assets/audio/AnaCaptainslogue_-_Noir_Et_Blanc_Vie.mp3" loop></audio>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 1: VIDEO INTRO - 29ç§’å®Œæ•´ä»‹ç´¹å½±ç‰‡
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="video-screen" class="screen active flex-col items-center justify-center" style="background: #000;">
    <div style="position: relative; width: 100%; height: 100%;">
        <video id="intro-video" style="width: 100%; height: 100%; object-fit: cover;" playsinline autoplay muted>
            <source src="../assets/video/intro.mp4" type="video/mp4">
        </video>
        
        <div style="position: absolute; bottom: 20px; right: 20px; display: flex; gap: 10px;">
            <button onclick="toggleVideoMute()" id="video-mute-btn" class="btn btn-secondary text-sm">ğŸ”‡ <span data-en="Sound" data-zh="è²éŸ³" data-es="Sonido">è²éŸ³</span></button>
            <button onclick="goToGame()" class="btn btn-secondary text-sm">
                <span data-en="Skip" data-zh="è·³é" data-es="Saltar">è·³é</span> â­ï¸
            </button>
        </div>
        
        <div style="position: absolute; top: 20px; right: 20px; padding: 0.4rem 0.8rem; background: rgba(0,0,0,0.7); color: white; border-radius: 8px; font-size: 0.9rem;">
            <span id="time-remaining" class="mono">29</span>s
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 2: A* SEARCH GAME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="game-screen" class="screen bg-hunters-point flex-col p-2">
    <div class="max-w-6xl w-full mx-auto flex-1 flex flex-col gap-2">
        
        <div class="game-header">
            <button onclick="showMenu()" class="btn btn-secondary text-xs py-1 px-3">â† <span data-en="Menu" data-zh="é¸å–®" data-es="MenÃº">é¸å–®</span></button>
            <div class="text-center">
                <span class="font-bold text-sm">ğŸšš Level 1: A* Search</span>
                <span class="text-xs text-gray-300 ml-1" data-en="â€” Mrs. Garcia Mission" data-zh="â€” Mrs. Garcia é€é¤ä»»å‹™" data-es="â€” MisiÃ³n Mrs. Garcia">â€” Mrs. Garcia é€é¤ä»»å‹™</span>
            </div>
            <div class="elo-badge">â­ ELO: <span id="elo-display" class="mono">1200</span></div>
        </div>
        
        <div class="game-layout flex gap-2 flex-1">
            <div class="flex-1 flex flex-col gap-2">
                
                <div class="flex justify-center gap-3">
                    <div class="text-center px-4 py-2 bg-blue-500/30 rounded-xl border-2 border-blue-500">
                        <p class="text-sm text-gray-300" data-en="You" data-zh="ä½ " data-es="TÃº">ğŸ® ä½ </p>
                        <p id="player-steps" class="text-2xl font-bold mono text-blue-400">0</p>
                    </div>
                    <div class="text-center px-4 py-2 bg-yellow-500/30 rounded-xl border-2 border-yellow-500">
                        <p class="text-sm text-gray-300">ğŸ¤– AI</p>
                        <p id="ai-steps" class="text-2xl font-bold mono text-yellow-400">-</p>
                    </div>
                    <div class="text-center px-4 py-2 bg-green-500/30 rounded-xl border-2 border-green-500">
                        <p class="text-sm text-gray-300" data-en="Best" data-zh="æœ€å„ª" data-es="Ã“ptimo">âœ¨ æœ€å„ª</p>
                        <p class="text-2xl font-bold mono text-green-400">12</p>
                    </div>
                </div>
                
                <div class="flex-1 flex items-center justify-center">
                    <div id="astar-grid" class="astar-grid"></div>
                </div>
                
                <div id="story-area" class="story-box hidden"></div>
                
                <div class="controls-bar">
                    <button id="ai-auto-btn" onclick="aiAutoDemo()" class="ctrl-btn ai-auto">ğŸ¤– AI</button>
                    <button onclick="switchToPlayer()" class="ctrl-btn" style="background: linear-gradient(135deg, #22c55e, #10b981);">ğŸ®</button>
                    <button id="ai-back-btn" onclick="aiStepBack()" class="ctrl-btn backward">âª</button>
                    <button id="ai-forward-btn" onclick="aiStepForward()" class="ctrl-btn forward">â©</button>
                    <button onclick="resetLevel()" class="ctrl-btn reset">ğŸ”„</button>
                    <button id="complete-btn" onclick="completeLevel()" class="ctrl-btn complete hidden">âœ…</button>
                    <button id="sound-btn" onclick="toggleSound()" class="ctrl-btn sound">ğŸ”Š</button>
                    <button id="music-btn" onclick="toggleMusic()" class="ctrl-btn sound">ğŸµ</button>
                </div>
            </div>
            
            <div class="side-panel p-2 flex flex-col gap-2">
                <div class="instructions-box">
                    <p class="font-bold text-green-300 mb-1 text-center text-xs">ğŸ“– <span data-en="How to Play" data-zh="éŠæˆ²èªªæ˜" data-es="CÃ³mo jugar">éŠæˆ²èªªæ˜</span></p>
                    <div class="grid grid-cols-2 gap-1">
                        <div class="instruction-item"><span class="instruction-icon bg-blue-500">ğŸšš</span><span data-en="Click green" data-zh="é»ç¶ è‰²æ ¼" data-es="Clic verde">é»ç¶ è‰²æ ¼</span></div>
                        <div class="instruction-item"><span class="instruction-icon bg-pink-500">ğŸ‘µ</span><span data-en="Visit Garcia" data-zh="ç¶“éé˜¿å¬¤" data-es="Visitar GarcÃ­a">ç¶“éé˜¿å¬¤</span></div>
                        <div class="instruction-item"><span class="instruction-icon bg-orange-500">ğŸ </span><span data-en="Deliver" data-zh="é€åˆ°çµ‚é»" data-es="Entregar">é€åˆ°çµ‚é»</span></div>
                        <div class="instruction-item"><span class="instruction-icon bg-gray-500">ğŸ¢</span><span data-en="Avoid" data-zh="é¿é–‹éšœç¤™" data-es="Evitar">é¿é–‹éšœç¤™</span></div>
                    </div>
                </div>
                
                <h3 class="text-sm font-bold text-center border-b border-white/20 pb-1">ğŸ“ A* Algorithm</h3>
                <div class="formula-box">
                    <p class="text-xs text-yellow-400 font-bold mb-1">Russell & Norvig Ch. 3.5.2</p>
                    <p class="mono text-base text-center mb-1">f(n) = g(n) + h(n)</p>
                    <div class="text-xs text-gray-300 space-y-0.5">
                        <p>â€¢ <span class="text-blue-400">g(n)</span> = <span data-en="cost from start" data-zh="èµ·é»æˆæœ¬" data-es="costo desde inicio">èµ·é»æˆæœ¬</span></p>
                        <p>â€¢ <span class="text-green-400">h(n)</span> = <span data-en="heuristic" data-zh="å•Ÿç™¼ä¼°è¨ˆ" data-es="heurÃ­stica">å•Ÿç™¼ä¼°è¨ˆ</span></p>
                        <p>â€¢ <span class="text-yellow-400">f(n)</span> = <span data-en="total" data-zh="ç¸½æˆæœ¬" data-es="total">ç¸½æˆæœ¬</span></p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-1">
                    <div class="stat-card"><p class="text-xs text-gray-400">g(n)</p><p id="g-value" class="stat-value text-blue-400 mono">0</p></div>
                    <div class="stat-card"><p class="text-xs text-gray-400">h(n)</p><p id="h-value" class="stat-value text-green-400 mono">12</p></div>
                    <div class="stat-card"><p class="text-xs text-gray-400">f(n)</p><p id="f-value" class="stat-value text-yellow-400 mono">12</p></div>
                    <div class="stat-card"><p class="text-xs text-gray-400" data-en="Optimal" data-zh="æœ€å„ª" data-es="Ã“ptimo">æœ€å„ª</p><p class="stat-value text-purple-400 mono">12</p></div>
                </div>
                <div class="bg-purple-900/50 rounded-lg p-2">
                    <p class="text-xs font-bold text-purple-300 mb-1">ğŸ§  Heuristic</p>
                    <p class="mono text-xs">h(n) = |xâ‚-xâ‚‚| + |yâ‚-yâ‚‚|</p>
                    <p class="text-xs text-gray-300 mt-1">Manhattan Distance</p>
                    <p class="text-xs text-gray-400 mt-1">Admissible: h(n) â‰¤ h*(n)</p>
                </div>
                <div class="bg-slate-700/50 rounded-lg p-2">
                    <p class="text-xs font-bold text-gray-300 mb-1">ğŸ“‹ <span data-en="Explored" data-zh="æ¢ç´¢" data-es="Explorado">æ¢ç´¢</span></p>
                    <div id="explored-list" class="text-xs mono text-gray-400 max-h-12 overflow-y-auto">(0,0) â€¢ Start</div>
                </div>
                <!-- Mrs. Garcia Story Image - ä¿®æ­£è·¯å¾‘ -->
                <div class="rounded-xl overflow-hidden border-3 border-pink-400/60 relative" style="box-shadow: 0 6px 25px rgba(236, 72, 153, 0.4); margin: 0 -8px -8px -8px;">
                    <img src="../assets/images/clean_Mrs__Garcia.png" alt="Mrs. Garcia Story" class="w-full h-auto" style="max-height: 160px; object-fit: cover;">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 3: éœå¿ƒä¹‹é–€ / Gate of Serenity
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="ataraxy-screen" class="screen flex-col items-center py-2 px-4 ataraxy-bg">
    <div class="absolute inset-0 bg-purple-900/5"></div>
    
    <!-- Top section with title -->
    <div class="relative z-10 text-center">
        <h2 class="text-3xl font-bold text-white" style="text-shadow: 0 0 30px rgba(251, 191, 36, 0.8), 0 4px 20px rgba(0,0,0,0.7);" data-en="Gate of Serenity" data-zh="éœå¿ƒä¹‹é–€" data-es="Puerta de Serenidad">éœå¿ƒä¹‹é–€</h2>
    </div>
    
    <!-- Breath ring area with countdown -->
    <div class="relative z-10 flex flex-col items-center" style="margin-top: 10px;">
        <div class="breath-ring-large">
            <p id="breath-counter" class="text-6xl font-bold text-yellow-400 mono" style="text-shadow: 0 0 50px rgba(251, 191, 36, 0.9);">ğŸ™</p>
        </div>
        <p class="text-lg text-yellow-300 font-bold mt-3" style="text-shadow: 0 2px 15px rgba(0,0,0,0.8);"><span data-en="Take 3 deep breaths..." data-zh="æ·±å‘¼å¸ä¸‰æ¬¡..." data-es="Respira profundo 3 veces...">æ·±å‘¼å¸ä¸‰æ¬¡...</span></p>
    </div>
    
    <!-- Spacer -->
    <div style="flex: 1;"></div>
    
    <!-- Card positioned lower -->
    <div class="relative z-10 flex flex-col items-center" style="margin-bottom: 18%;">
        <div class="jingsi-card fade-in breathing-card">
            <p class="text-lg font-bold text-yellow-300 mb-1" data-en="ã€ŒGratitude is the most beautiful languageã€" data-zh="ã€Œæ„Ÿæ©ï¼Œæ˜¯ä¸–é–“æœ€ç¾çš„èªè¨€ã€" data-es="ã€ŒLa gratitud es el lenguaje mÃ¡s hermosoã€">ã€Œæ„Ÿæ©ï¼Œæ˜¯ä¸–é–“æœ€ç¾çš„èªè¨€ã€</p>
            <p class="text-sm text-white/90">Gratitude is the most beautiful language in the world.</p>
            <p class="text-xs text-purple-200 mt-2">â€” <span data-en="Master Cheng Yen" data-zh="è­‰åš´ä¸Šäºº" data-es="Maestra Cheng Yen">è­‰åš´ä¸Šäºº</span> Master Cheng Yen</p>
        </div>
    </div>
    
    <!-- Navigation buttons -->
    <div class="relative z-10 flex flex-wrap gap-4 justify-center" style="margin-bottom: 8%;">
        <button onclick="goToMainMenu()" class="btn btn-secondary text-base px-6 py-2">ğŸ  <span data-en="Home" data-zh="ä¸»é " data-es="Inicio">ä¸»é </span></button>
        <button onclick="goToPrevLevel()" class="btn btn-secondary text-base px-6 py-2">â¬…ï¸ <span data-en="Prev" data-zh="ä¸Šä¸€é—œ" data-es="Anterior">ä¸Šä¸€é—œ</span></button>
        <button onclick="replayLevel()" class="btn btn-secondary text-base px-6 py-2">ğŸ”„ <span data-en="Replay" data-zh="é‡ç©" data-es="Repetir">é‡ç©</span></button>
        <button id="continue-btn" onclick="continueJourney()" class="btn btn-primary text-base px-6 py-2" style="box-shadow: 0 0 30px rgba(236, 72, 153, 0.6);"><span data-en="Next" data-zh="ä¸‹ä¸€é—œ" data-es="Siguiente">ä¸‹ä¸€é—œ</span> â†’</button>
    </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LANGUAGE - æ”¯æ´ä¸­è‹±è¥¿ä¸‰èª
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentLang = 'zh';
function setLang(lang) {
    currentLang = lang;
    document.getElementById('lang-en').classList.toggle('active', lang === 'en');
    document.getElementById('lang-zh').classList.toggle('active', lang === 'zh');
    document.getElementById('lang-es').classList.toggle('active', lang === 'es');
    document.querySelectorAll('[data-en][data-zh]').forEach(el => {
        const text = el.getAttribute('data-' + lang);
        if (text) el.textContent = text;
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUDIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let audioCtx = null, soundEnabled = true, musicPlaying = false;

function initAudio() { 
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); 
    return audioCtx; 
}

function playFootstep() {
    if (!soundEnabled) return;
    try {
        const ctx = initAudio(), osc = ctx.createOscillator(), gain = ctx.createGain();
        osc.connect(gain); gain.connect(ctx.destination);
        osc.frequency.setValueAtTime(150, ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(80, ctx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.3, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
        osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.1);
    } catch (e) { console.log('Audio error:', e); }
}

function playRescueSound() {
    if (!soundEnabled) return;
    try {
        const ctx = initAudio();
        [261.63, 329.63, 392.00, 523.25].forEach((freq, i) => {
            const osc = ctx.createOscillator(), gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            osc.type = 'sine'; osc.frequency.setValueAtTime(freq, ctx.currentTime);
            gain.gain.setValueAtTime(0, ctx.currentTime + i * 0.1);
            gain.gain.linearRampToValueAtTime(0.2, ctx.currentTime + i * 0.1 + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i * 0.1 + 0.8);
            osc.start(ctx.currentTime + i * 0.1); osc.stop(ctx.currentTime + i * 0.1 + 0.8);
        });
    } catch (e) { console.log('Audio error:', e); }
}

function playVictorySound() {
    if (!soundEnabled) return;
    try {
        const ctx = initAudio();
        [{freq: 523.25, time: 0}, {freq: 659.25, time: 0.15}, {freq: 783.99, time: 0.3}, {freq: 1046.50, time: 0.45}].forEach(note => {
            const osc = ctx.createOscillator(), gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            osc.type = 'sine'; osc.frequency.setValueAtTime(note.freq, ctx.currentTime + note.time);
            gain.gain.setValueAtTime(0, ctx.currentTime + note.time);
            gain.gain.linearRampToValueAtTime(0.3, ctx.currentTime + note.time + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + note.time + 0.4);
            osc.start(ctx.currentTime + note.time); osc.stop(ctx.currentTime + note.time + 0.4);
        });
    } catch (e) { console.log('Audio error:', e); }
}

function toggleSound() { 
    soundEnabled = !soundEnabled; 
    document.getElementById('sound-btn').textContent = soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡'; 
}

function toggleMusic() {
    const music = document.getElementById('bg-music');
    if (musicPlaying) { 
        music.pause(); 
        document.getElementById('music-btn').textContent = 'ğŸµ'; 
        musicPlaying = false; 
    } else { 
        music.volume = 0.4;
        music.play().then(() => { 
            document.getElementById('music-btn').textContent = 'ğŸ¶'; 
            musicPlaying = true; 
        }).catch(e => console.log('Music error:', e)); 
    }
}

function toggleVideoMute() {
    const video = document.getElementById('intro-video');
    const btn = document.getElementById('video-mute-btn');
    if (video.muted) {
        video.muted = false;
        btn.innerHTML = 'ğŸ”Š <span data-en="Sound" data-zh="è²éŸ³" data-es="Sonido">' + (currentLang === 'en' ? 'Sound' : currentLang === 'es' ? 'Sonido' : 'è²éŸ³') + '</span>';
    } else {
        video.muted = true;
        btn.innerHTML = 'ğŸ”‡ <span data-en="Sound" data-zh="è²éŸ³" data-es="Sonido">' + (currentLang === 'en' ? 'Sound' : currentLang === 'es' ? 'Sonido' : 'è²éŸ³') + '</span>';
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREENS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// START & VIDEO INTRO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let videoTimer = 29, videoInterval = null;

function goToGame() {
    console.log('Going to game...');
    if (videoInterval) { clearInterval(videoInterval); videoInterval = null; }
    const video = document.getElementById('intro-video');
    video.pause();
    showScreen('game-screen');
    resetLevel();
    setTimeout(() => {
        const bgMusic = document.getElementById('bg-music');
        bgMusic.volume = 0.4;
        bgMusic.play().then(() => { 
            document.getElementById('music-btn').textContent = 'ğŸ¶'; 
            musicPlaying = true; 
        }).catch(e => console.log('BG music error:', e));
    }, 500);
}

function showMenu() { 
    const bgMusic = document.getElementById('bg-music');
    bgMusic.pause(); bgMusic.currentTime = 0;
    musicPlaying = false;
    document.getElementById('music-btn').textContent = 'ğŸµ';
    resetLevel();
    showScreen('video-screen');
    const video = document.getElementById('intro-video');
    video.currentTime = 0;
    video.play().catch(e => console.log('Video play error:', e));
    videoTimer = 29;
    document.getElementById('time-remaining').textContent = '29';
    if (videoInterval) clearInterval(videoInterval);
    videoInterval = setInterval(() => {
        videoTimer--;
        document.getElementById('time-remaining').textContent = videoTimer;
        if (videoTimer <= 0) goToGame();
    }, 1000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const gameState = {
    elo: 1200, gridWidth: 8, gridHeight: 6,
    player: { x: 0, y: 0 }, goal: { x: 7, y: 5 }, garcia: { x: 5, y: 3 },
    obstacles: [{x:2,y:1},{x:2,y:2},{x:2,y:3},{x:4,y:4},{x:4,y:5},{x:6,y:2},{x:6,y:3}],
    visited: [], steps: 0, aiPath: [], aiPathIndex: 0, aiAutoRunning: false, mode: 'player',
    nearGarcia: false, madeChoice: null, reachedGoal: false
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// A* ALGORITHM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function manhattan(p1, p2) { return Math.abs(p1.x - p2.x) + Math.abs(p1.y - p2.y); }
function getH(x, y) { return manhattan({x, y}, gameState.goal); }
function getF(x, y) { return gameState.steps + manhattan(gameState.player, {x, y}) + getH(x, y); }
function isObstacle(x, y) { return gameState.obstacles.some(o => o.x === x && o.y === y); }
function isValidMove(x, y) { return x >= 0 && x < gameState.gridWidth && y >= 0 && y < gameState.gridHeight && !isObstacle(x, y); }
function isAdjacent(x, y) { const dx = Math.abs(x - gameState.player.x), dy = Math.abs(y - gameState.player.y); return (dx === 1 && dy === 0) || (dx === 0 && dy === 1); }

function computeAStarPath() {
    const start = {x: 0, y: 0}, goal = gameState.goal;
    const openSet = [start], cameFrom = {}, gScore = {}, fScore = {};
    const key = (p) => p.x + ',' + p.y;
    gScore[key(start)] = 0; fScore[key(start)] = manhattan(start, goal);
    while (openSet.length > 0) {
        openSet.sort((a, b) => fScore[key(a)] - fScore[key(b)]);
        const current = openSet.shift();
        if (current.x === goal.x && current.y === goal.y) {
            const path = [current]; let c = current;
            while (cameFrom[key(c)]) { c = cameFrom[key(c)]; path.unshift(c); }
            return path;
        }
        [{x: current.x+1, y: current.y}, {x: current.x-1, y: current.y}, {x: current.x, y: current.y+1}, {x: current.x, y: current.y-1}]
            .filter(n => isValidMove(n.x, n.y)).forEach(neighbor => {
                const tentativeG = gScore[key(current)] + 1;
                if (gScore[key(neighbor)] === undefined || tentativeG < gScore[key(neighbor)]) {
                    cameFrom[key(neighbor)] = current;
                    gScore[key(neighbor)] = tentativeG;
                    fScore[key(neighbor)] = tentativeG + manhattan(neighbor, goal);
                    if (!openSet.some(n => n.x === neighbor.x && n.y === neighbor.y)) openSet.push(neighbor);
                }
            });
    }
    return [];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI DEMO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function aiAutoDemo() {
    if (gameState.aiAutoRunning) { 
        gameState.aiAutoRunning = false; 
        document.getElementById('ai-auto-btn').innerHTML = 'ğŸ¤– AI'; 
        return; 
    }
    gameState.mode = 'ai'; 
    gameState.aiPath = computeAStarPath(); 
    gameState.aiPathIndex = 0; 
    gameState.aiAutoRunning = true;
    document.getElementById('ai-auto-btn').innerHTML = 'â¹ï¸'; 
    runAiStep();
}

function runAiStep() {
    if (!gameState.aiAutoRunning) return;
    if (gameState.aiPathIndex >= gameState.aiPath.length - 1) {
        gameState.aiAutoRunning = false; 
        document.getElementById('ai-auto-btn').innerHTML = 'ğŸ¤– AI';
        document.getElementById('complete-btn').classList.remove('hidden'); 
        playVictorySound(); 
        return;
    }
    gameState.aiPathIndex++; 
    const pos = gameState.aiPath[gameState.aiPathIndex];
    gameState.player = {x: pos.x, y: pos.y}; 
    gameState.steps = gameState.aiPathIndex;
    playFootstep(); 
    updateDisplay(); 
    renderGrid(); 
    setTimeout(runAiStep, 400);
}

function aiStepForward() {
    if (gameState.aiPath.length === 0) gameState.aiPath = computeAStarPath();
    gameState.mode = 'ai';
    if (gameState.aiPathIndex < gameState.aiPath.length - 1) {
        gameState.aiPathIndex++; 
        const pos = gameState.aiPath[gameState.aiPathIndex];
        gameState.player = {x: pos.x, y: pos.y}; 
        gameState.steps = gameState.aiPathIndex;
        playFootstep(); 
        updateDisplay(); 
        renderGrid();
        if (gameState.aiPathIndex >= gameState.aiPath.length - 1) { 
            document.getElementById('complete-btn').classList.remove('hidden'); 
            playVictorySound(); 
        }
    }
    updateButtonStates();
}

function aiStepBack() {
    if (gameState.aiPathIndex > 0) {
        gameState.aiPathIndex--; 
        const pos = gameState.aiPath[gameState.aiPathIndex];
        gameState.player = {x: pos.x, y: pos.y}; 
        gameState.steps = gameState.aiPathIndex;
        playFootstep(); 
        updateDisplay(); 
        renderGrid();
    }
    updateButtonStates();
}

function switchToPlayer() { 
    gameState.mode = 'player'; 
    gameState.aiAutoRunning = false; 
    document.getElementById('ai-auto-btn').innerHTML = 'ğŸ¤– AI'; 
    renderGrid(); 
}

function updateButtonStates() {
    const backBtn = document.getElementById('ai-back-btn');
    const fwdBtn = document.getElementById('ai-forward-btn');
    if (backBtn) backBtn.disabled = gameState.aiPathIndex <= 0;
    if (fwdBtn) fwdBtn.disabled = gameState.aiPath.length > 0 && gameState.aiPathIndex >= gameState.aiPath.length - 1;
}

function updateDisplay() {
    document.getElementById('ai-steps').textContent = gameState.aiPathIndex;
    document.getElementById('player-steps').textContent = gameState.mode === 'player' ? gameState.steps : '-';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderGrid() {
    const grid = document.getElementById('astar-grid');
    const aiPathSet = new Set(gameState.aiPath.map(p => p.x + ',' + p.y));
    let html = '';
    for (let y = 0; y < gameState.gridHeight; y++) {
        for (let x = 0; x < gameState.gridWidth; x++) {
            const isPlayer = gameState.player.x === x && gameState.player.y === y;
            const isGoal = gameState.goal.x === x && gameState.goal.y === y;
            const isGarcia = gameState.garcia.x === x && gameState.garcia.y === y;
            const isObs = isObstacle(x, y);
            const isVisited = gameState.visited.some(v => v.x === x && v.y === y);
            const isAdj = isAdjacent(x, y) && !isObs && gameState.mode === 'player';
            const isOnAiPath = aiPathSet.has(x + ',' + y) && gameState.mode === 'ai';
            const f = getF(x, y);
            let cellClass = 'astar-cell', content = '';
            if (isPlayer) { cellClass += gameState.mode === 'ai' ? ' ai-current' : ' player'; content = gameState.mode === 'ai' ? 'ğŸ¤–' : 'ğŸšš'; }
            else if (isGoal) { cellClass += ' goal'; content = 'ğŸ '; }
            else if (isGarcia) { cellClass += ' garcia'; content = 'ğŸ‘µ'; }
            else if (isObs) { cellClass += ' obstacle'; content = 'ğŸ¢'; }
            else if (isOnAiPath) { cellClass += ' ai-path'; }
            else if (isVisited) { cellClass += ' visited'; content = 'Â·'; }
            else if (isAdj) { cellClass += ' adjacent'; }
            html += '<div class="' + cellClass + '" onclick="movePlayer(' + x + ',' + y + ')"><span>' + content + '</span>' + (!isPlayer&&!isGoal&&!isGarcia&&!isObs ? '<span class="f-score mono">' + f + '</span>' : '') + '</div>';
        }
    }
    grid.innerHTML = html;
    updateStats();
}

function updateStats() {
    const g = gameState.steps, h = getH(gameState.player.x, gameState.player.y), f = g + h;
    document.getElementById('g-value').textContent = g;
    document.getElementById('h-value').textContent = h;
    document.getElementById('f-value').textContent = f;
    document.getElementById('player-steps').textContent = gameState.mode === 'player' ? g : '-';
    document.getElementById('ai-steps').textContent = gameState.mode === 'ai' ? gameState.aiPathIndex : '-';
    document.getElementById('explored-list').innerHTML = gameState.visited.map((v, i) => '(' + v.x + ',' + v.y + ')').join(' ') || '(0,0) â€¢ Start';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLAYER MOVEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function movePlayer(x, y) {
    if (gameState.mode !== 'player' || !isAdjacent(x, y) || !isValidMove(x, y)) return;
    if (gameState.madeChoice === 'follow' && x === gameState.garcia.x && y === gameState.garcia.y) return;
    gameState.visited.push({x: gameState.player.x, y: gameState.player.y}); 
    gameState.player = {x: x, y: y}; 
    gameState.steps++;
    playFootstep();
    if (x === gameState.garcia.x && y === gameState.garcia.y) playRescueSound();
    if (x === gameState.goal.x && y === gameState.goal.y) {
        gameState.reachedGoal = true; 
        document.getElementById('complete-btn').classList.remove('hidden');
        playVictorySound(); 
        showStory('goal');
    }
    renderGrid(); 
    checkGarciaProximity();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkGarciaProximity() {
    if (manhattan(gameState.player, gameState.garcia) === 1 && !gameState.nearGarcia && !gameState.madeChoice) {
        gameState.nearGarcia = true; 
        showStory('choice');
    }
}

function showStory(type) {
    const storyArea = document.getElementById('story-area');
    storyArea.classList.remove('hidden');
    if (type === 'choice') {
        const t = currentLang === 'zh' ? {
            aiTitle: 'AI å»ºè­°ï¼š', aiMsg: '"è·³é Mrs. Garciaï¼Œæ•ˆç‡ +15%"',
            noticeTitle: 'ä½†ä½ æ³¨æ„åˆ°...', noticeMsg: 'å¥¹å®¶çª—ç°¾ä»Šå¤©æ²’é–‹...',
            override: 'ğŸ›‘ åœä¸‹æŸ¥çœ‹', follow: 'â–¶ï¸ è·Ÿéš¨ AI'
        } : currentLang === 'es' ? {
            aiTitle: 'IA sugiere:', aiMsg: '"Saltar GarcÃ­a, +15% eficiencia"',
            noticeTitle: 'Pero notas...', noticeMsg: 'Sus cortinas no estÃ¡n abiertas...',
            override: 'ğŸ›‘ Detenerse', follow: 'â–¶ï¸ Seguir IA'
        } : {
            aiTitle: 'AI suggests:', aiMsg: '"Skip Garcia, +15% efficiency"',
            noticeTitle: 'But you notice...', noticeMsg: "Her curtains aren't open...",
            override: 'ğŸ›‘ Stop to check', follow: 'â–¶ï¸ Follow AI'
        };
        storyArea.innerHTML = '<div class="flex items-start gap-2"><div class="character-avatar" style="background:linear-gradient(135deg,#fbbf24,#f59e0b);">ğŸ¤–</div><div><p class="font-bold text-yellow-400 text-xs">' + t.aiTitle + '</p><p class="text-gray-300 text-xs">' + t.aiMsg + '</p></div></div><div class="flex items-start gap-2 mt-2 pt-2 border-t border-white/20"><div class="character-avatar" style="background:linear-gradient(135deg,#ec4899,#db2777);">ğŸ’­</div><div><p class="font-bold text-pink-400 text-xs">' + t.noticeTitle + '</p><p class="text-gray-300 text-xs">' + t.noticeMsg + '</p></div></div><div class="flex gap-2 mt-3 justify-center"><button onclick="makeChoice(\'override\')" class="decision-btn override">' + t.override + '</button><button onclick="makeChoice(\'follow\')" class="decision-btn follow">' + t.follow + '</button></div>';
    } else if (type === 'override-result') {
        const t = currentLang === 'zh' ? { title: 'ä½ æ•‘äº†å¥¹ï¼', desc: 'Mrs. Garcia å…©å¤©å‰è·Œå€’äº†ã€‚ä½ çš„æ±ºå®š<span class="text-green-400 font-bold">æ•‘äº†å¥¹ä¸€å‘½</span>ã€‚' }
            : currentLang === 'es' ? { title: 'Â¡La salvaste!', desc: 'Mrs. Garcia se cayÃ³ hace 2 dÃ­as. Tu decisiÃ³n <span class="text-green-400 font-bold">le salvÃ³ la vida</span>.' }
            : { title: 'You saved her!', desc: 'Mrs. Garcia fell 2 days ago. Your choice <span class="text-green-400 font-bold">saved her life</span>.' };
        storyArea.innerHTML = '<div class="text-center"><p class="text-3xl mb-1">ğŸ’–</p><p class="text-base text-green-400 font-bold mb-1">' + t.title + '</p><p class="text-gray-300 text-xs">' + t.desc + '</p><p class="text-green-400 font-bold mt-2">+50 ELO âœ¨</p></div>';
    } else if (type === 'follow-result') {
        const t = currentLang === 'zh' ? { title: 'ä½ è·Ÿéš¨äº† AI', desc: 'æ•ˆç‡ +15%ã€‚ä½† Mrs. Garcia è¢«ç™¼ç¾æ™‚å·²èººäº†ä¸‰å¤©...' }
            : currentLang === 'es' ? { title: 'Seguiste a la IA', desc: 'Eficiencia +15%. Pero Mrs. Garcia fue encontrada despuÃ©s de 3 dÃ­as...' }
            : { title: 'You followed AI', desc: 'Efficiency +15%. But Mrs. Garcia was found after 3 days...' };
        storyArea.innerHTML = '<div class="text-center"><p class="text-3xl mb-1">ğŸ˜¢</p><p class="text-base text-gray-400 font-bold mb-1">' + t.title + '</p><p class="text-gray-300 text-xs">' + t.desc + '</p><p class="text-gray-400 mt-2">+20 ELO</p></div>';
    } else if (type === 'goal') {
        const t = currentLang === 'zh' ? { title: 'é…é€å®Œæˆï¼ğŸ‰' } : currentLang === 'es' ? { title: 'Â¡Entrega completada! ğŸ‰' } : { title: 'Delivery Complete! ğŸ‰' };
        storyArea.innerHTML = '<div class="text-center"><p class="text-3xl mb-1">ğŸ‰</p><p class="text-base text-green-400 font-bold">' + t.title + '</p></div>';
    }
}

function makeChoice(choice) {
    gameState.madeChoice = choice;
    if (choice === 'override') {
        gameState.visited.push({x: gameState.player.x, y: gameState.player.y}); 
        gameState.player = {x: gameState.garcia.x, y: gameState.garcia.y}; 
        gameState.steps++;
        gameState.elo += 50; 
        playRescueSound(); 
        showStory('override-result');
    } else { 
        gameState.elo += 20; 
        showStory('follow-result'); 
    }
    document.getElementById('elo-display').textContent = gameState.elo; 
    renderGrid();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LEVEL COMPLETION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function resetLevel() {
    gameState.player = {x:0, y:0};
    gameState.visited = [{x:0, y:0}];
    gameState.steps = 0;
    gameState.nearGarcia = false;
    gameState.madeChoice = null;
    gameState.reachedGoal = false;
    gameState.aiPath = [];
    gameState.aiPathIndex = 0;
    gameState.aiAutoRunning = false;
    gameState.mode = 'player';
    document.getElementById('story-area').classList.add('hidden');
    document.getElementById('complete-btn').classList.add('hidden');
    document.getElementById('ai-auto-btn').innerHTML = 'ğŸ¤– AI';
    gameState.aiPath = computeAStarPath();
    updateButtonStates(); 
    renderGrid();
}

function completeLevel() {
    const bgMusic = document.getElementById('bg-music');
    bgMusic.pause(); bgMusic.currentTime = 0;
    musicPlaying = false;
    document.getElementById('music-btn').textContent = 'ğŸµ';
    const meditationMusic = document.getElementById('meditation-music');
    meditationMusic.volume = 0.5;
    meditationMusic.play().catch(e => console.log('Meditation music error:', e));
    playVictorySound();
    showScreen('ataraxy-screen');
    startBreathingAnimation();
}

function startBreathingAnimation() {
    let count = 3;
    const counter = document.getElementById('breath-counter');
    counter.textContent = '3';
    const timer = setInterval(() => {
        count--;
        if (count > 0) {
            counter.textContent = count;
        } else {
            clearInterval(timer); 
            counter.textContent = 'ğŸ™';
            if (typeof confetti === 'function') {
                confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
            }
            playVictorySound();
        }
    }, 2000);
}

function goToMainMenu() {
    const meditationMusic = document.getElementById('meditation-music');
    meditationMusic.pause(); meditationMusic.currentTime = 0;
    window.location.href = '../index.html';
}

function goToPrevLevel() {
    const meditationMusic = document.getElementById('meditation-music');
    meditationMusic.pause(); meditationMusic.currentTime = 0;
    window.location.href = '../index.html';
}

function replayLevel() {
    const meditationMusic = document.getElementById('meditation-music');
    meditationMusic.pause(); meditationMusic.currentTime = 0;
    showScreen('game-screen');
    resetLevel();
    const bgMusic = document.getElementById('bg-music');
    bgMusic.volume = 0.4;
    bgMusic.play().then(() => { 
        document.getElementById('music-btn').textContent = 'ğŸ¶'; 
        musicPlaying = true; 
    }).catch(e => console.log('BG music error:', e));
}

function continueJourney() {
    const meditationMusic = document.getElementById('meditation-music');
    meditationMusic.pause(); meditationMusic.currentTime = 0;
    window.location.href = '../level2/index.html';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', function() {
    console.log('Game initialized');
    gameState.aiPath = computeAStarPath();
    const video = document.getElementById('intro-video');
    video.play().catch(e => console.log('Video autoplay blocked:', e));
    videoTimer = 29;
    document.getElementById('time-remaining').textContent = '29';
    if (videoInterval) clearInterval(videoInterval);
    videoInterval = setInterval(() => {
        videoTimer--;
        document.getElementById('time-remaining').textContent = videoTimer;
        if (videoTimer <= 0) goToGame();
    }, 1000);
    video.onended = goToGame;
    document.addEventListener('keydown', function(e) {
        if (!document.getElementById('game-screen').classList.contains('active')) return;
        switch(e.key) {
            case 'ArrowUp': e.preventDefault(); movePlayer(gameState.player.x, gameState.player.y - 1); break;
            case 'ArrowDown': e.preventDefault(); movePlayer(gameState.player.x, gameState.player.y + 1); break;
            case 'ArrowLeft': e.preventDefault(); movePlayer(gameState.player.x - 1, gameState.player.y); break;
            case 'ArrowRight': e.preventDefault(); movePlayer(gameState.player.x + 1, gameState.player.y); break;
        }
    });
});
</script>

</body>
</html>
