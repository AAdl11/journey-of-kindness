<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Journey of Kindness | æ…ˆæ‚²ä¹‹æ—…</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');
        * { font-family: 'Nunito', sans-serif; }
        
        /* Disney-style animations */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 20px rgba(255,215,0,0.5); } 50% { box-shadow: 0 0 40px rgba(255,215,0,0.8); } }
        @keyframes sparkle { 0%, 100% { opacity: 0; } 50% { opacity: 1; } }
        @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.2); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes mapPan { 0% { transform: scale(1.1) translateY(-20px); } 100% { transform: scale(1) translateY(0); } }
        @keyframes starBurst { 0% { transform: scale(0) rotate(0deg); } 50% { transform: scale(1.2) rotate(180deg); } 100% { transform: scale(1) rotate(360deg); } }
        @keyframes confetti { 0% { transform: translateY(-100vh) rotate(0deg); } 100% { transform: translateY(100vh) rotate(720deg); } }
        
        .float { animation: float 3s ease-in-out infinite; }
        .pulse { animation: pulse 2s ease-in-out infinite; }
        .glow { animation: glow 2s ease-in-out infinite; }
        .breathe { animation: breathe 4s ease-in-out infinite; }
        .slide-up { animation: slideUp 0.5s ease-out; }
        .map-pan { animation: mapPan 1.5s ease-out; }
        .star-burst { animation: starBurst 0.6s ease-out; }
        
        /* Map location markers */
        .map-marker { 
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .map-marker:hover { 
            transform: scale(1.2);
            filter: brightness(1.2);
        }
        .map-marker.completed {
            filter: drop-shadow(0 0 10px gold);
        }
        .map-marker.locked {
            filter: grayscale(0.5);
            opacity: 0.7;
        }
        
        /* Confetti */
        .confetti-piece {
            position: fixed;
            width: 10px;
            height: 10px;
            animation: confetti 3s ease-in-out forwards;
        }
    </style>
</head>
<body class="bg-gray-900 overflow-hidden">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ============================================================
        // GAME DATA - Sid Meier Style "Interesting Decisions"
        // ============================================================
        const LEVELS = [
            {
                id: 1,
                name: "Mrs. Garcia's House",
                nameZh: "ä¹˜æ„›è€Œä¾†",
                algorithm: "A* Search",
                location: { x: 25, y: 60 },
                icon: "ğŸ ",
                photo: "media/clean_Mrs__Garcia.png",
                story: "A little girl eating raw rice sparked 16 years of service...",
                storyZh: "ä¸€å€‹å°å¥³å­©åƒç”Ÿç±³çš„æ•…äº‹ï¼Œé–‹å•Ÿäº†16å¹´çš„æœå‹™...",
                aphorism: "æ„Ÿæ©ï¼Œæ˜¯ä¸–é–“æœ€ç¾çš„èªè¨€",
                aphorismEn: "Gratitude is the most beautiful language",
                music: "gentle",
                color: "from-blue-600 to-blue-800"
            },
            {
                id: 2,
                name: "Bret Harte Elementary",
                nameZh: "å¹¸ç¦æ ¡åœ’",
                algorithm: "Propositional Logic",
                location: { x: 45, y: 35 },
                icon: "ğŸ«",
                photo: "media/å…¨å‹¤ç1_é¦¬è³½å…‹.png",
                story: "Sister Roxanne presents attendance awards to dedicated students...",
                storyZh: "é»ƒæ·‘é›²å¸«å§Šé ’ç™¼å…¨å‹¤ççµ¦åŠªåŠ›çš„å­¸ç”Ÿ...",
                aphorism: "å¿ƒèƒ½è½‰å¢ƒï¼Œå¢ƒéš¨å¿ƒè½‰",
                aphorismEn: "Master your mind, transform your circumstances",
                music: "hopeful",
                color: "from-green-600 to-green-800"
            },
            {
                id: 3,
                name: "RV Park",
                nameZh: "éœ²å®¿è€…é—œæ‡·",
                algorithm: "MDP",
                location: { x: 70, y: 70 },
                icon: "ğŸš",
                photo: "media/RV_Park_éŠæ°‘_å®Œæˆ__1_.jpg",
                story: "Reaching out to those living in vehicles, bringing warmth and hope...",
                storyZh: "é—œæ‡·ä½åœ¨è»Šä¸Šçš„éœ²å®¿è€…ï¼Œå¸¶å»æº«æš–èˆ‡å¸Œæœ›...",
                aphorism: "ç”˜é¡˜åšï¼Œæ­¡å–œå—",
                aphorismEn: "Willing to do, happy to receive",
                music: "compassion",
                color: "from-orange-600 to-orange-800"
            },
            {
                id: 4,
                name: "Community Center",
                nameZh: "å†¬å­£æ¯›æ¯¯",
                algorithm: "KB-Agent",
                location: { x: 55, y: 50 },
                icon: "ğŸ§¥",
                photo: "media/clean_L4å å¥½çš„ç°è‰²è—è‰²æ¯›æ¯¯.png",
                story: "Knowledge-based decisions: Which families need blankets most?",
                storyZh: "çŸ¥è­˜æ¨ç†ï¼šå“ªäº›å®¶åº­æœ€éœ€è¦æ¯›æ¯¯ï¼Ÿ",
                aphorism: "åœ¨æœªçŸ¥ä¸­å‰è¡Œï¼Œç”¨æ™ºæ…§ç…§äº®é“è·¯",
                aphorismEn: "Move forward in the unknown, let wisdom light the way",
                music: "mystery",
                color: "from-purple-600 to-purple-800"
            },
            {
                id: 5,
                name: "Volunteer Hub",
                nameZh: "å¿—å·¥é—œæ‡·",
                algorithm: "Bayesian Network",
                location: { x: 35, y: 45 },
                icon: "ğŸ‘¥",
                photo: "media/å¿—å·¥é—œæ‡·_å®Œæˆv2.png",
                story: "Predicting volunteer burnout with probability and compassion...",
                storyZh: "ç”¨æ©Ÿç‡é æ¸¬å¿—å·¥å€¦æ€ ï¼Œç”¨æ„›å¿ƒé—œæ‡·å½¼æ­¤...",
                aphorism: "éœæ€å‹¤è¡Œé“ï¼Œæ…ˆæ¿Ÿäººé–“è·¯",
                aphorismEn: "Reflect quietly, walk the Tzu Chi path",
                music: "peaceful",
                color: "from-teal-600 to-teal-800"
            },
            {
                id: 6,
                name: "Community Garden",
                nameZh: "èŠ±åœ’å‚³æ‰¿",
                algorithm: "First-Order Logic",
                location: { x: 80, y: 40 },
                icon: "ğŸŒ³",
                photo: "media/clean_L7___Grandma___Marcus_èŠ±åœ’å‚³æ‰¿ç‰ˆ.png",
                story: "Marcus learns from Grandma: passing wisdom across generations...",
                storyZh: "Marcus å‘å¥¶å¥¶å­¸ç¿’ï¼šæ™ºæ…§çš„ä»£ä»£ç›¸å‚³...",
                aphorism: "æŠŠæ¡æ™‚é–“ï¼Œçæƒœç©ºé–“",
                aphorismEn: "Seize time, cherish space",
                music: "heritage",
                color: "from-emerald-600 to-emerald-800"
            },
            {
                id: 7,
                name: "Tzu Chi Hall",
                nameZh: "èè‹±å¿—å·¥",
                algorithm: "Adversarial Search",
                location: { x: 50, y: 25 },
                icon: "ğŸŒ",
                photo: "media/clean_L6_èè‹±å¿—å·¥.png",
                story: "The final challenge: competing against doubt with compassion...",
                storyZh: "æœ€çµ‚æŒ‘æˆ°ï¼šç”¨æ…ˆæ‚²æˆ°å‹æ‡·ç–‘...",
                aphorism: "å¿«æ¨‚ä¸åœ¨æ“æœ‰å¤š",
                aphorismEn: "Happiness is not in having more",
                music: "triumph",
                color: "from-indigo-600 to-indigo-800"
            },
            {
                id: 8,
                name: "Cleanup Zone",
                nameZh: "ç’°ä¿å°å°–å…µ",
                algorithm: "Bonus Level",
                location: { x: 15, y: 35 },
                icon: "ğŸŒ±",
                photo: "media/EnvironmentVangguard_.png",
                story: "Young environmental guardians cleaning up the community!",
                storyZh: "ç’°ä¿å°å°–å…µå€‘ä¸€èµ·æ¸…æ½”ç¤¾å€ï¼",
                aphorism: "æ¸…æ·¨åœ¨æºé ­ï¼Œç’°ä¿åœ¨è¡Œå‹•",
                aphorismEn: "Purity at the source, action for the environment",
                music: "energetic",
                color: "from-lime-600 to-lime-800",
                isBonus: true
            }
        ];

        const ETHICS_QUOTE = {
            zh: "ã€ŒçœŸæ­£çš„æ…ˆæ‚²ï¼Œæ˜¯ç•¶æ¼”ç®—æ³•èªªä¸è¡Œï¼Œæˆ‘å€‘èªªï¼šæˆ‘é¡˜æ„ã€‚ã€",
            en: '"True compassion is when the algorithm says no, and we say: I\'m willing."'
        };

        // ============================================================
        // AUDIO SYSTEM
        // ============================================================
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;

        const playSound = (type) => {
            if (!audioCtx) audioCtx = new AudioContext();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            const sounds = {
                click: { freq: 600, duration: 0.1, type: 'sine' },
                success: { freq: 523, duration: 0.3, type: 'sine' },
                complete: { freq: 784, duration: 0.5, type: 'sine' },
                error: { freq: 200, duration: 0.2, type: 'square' },
                bell: { freq: 528, duration: 2, type: 'sine' },
                magic: { freq: 880, duration: 0.4, type: 'triangle' }
            };
            
            const s = sounds[type] || sounds.click;
            osc.type = s.type;
            osc.frequency.setValueAtTime(s.freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + s.duration);
            osc.start();
            osc.stop(audioCtx.currentTime + s.duration);
        };

        const playMelody = (notes) => {
            if (!audioCtx) audioCtx = new AudioContext();
            notes.forEach((note, i) => {
                setTimeout(() => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(note, audioCtx.currentTime);
                    gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.3);
                }, i * 200);
            });
        };

        // ============================================================
        // MAIN APP COMPONENT
        // ============================================================
        function App() {
            const [screen, setScreen] = useState('video'); // video, intro, map, level, story, game, portico, complete
            const [lang, setLang] = useState('zh');
            const [currentLevel, setCurrentLevel] = useState(null);
            const [completedLevels, setCompletedLevels] = useState([]);
            const [scores, setScores] = useState({});
            const [totalScore, setTotalScore] = useState(0);
            const [showSkip, setShowSkip] = useState(false);
            const [canContinue, setCanContinue] = useState(false);
            const [breathPhase, setBreathPhase] = useState('inhale');
            const videoRef = useRef(null);

            // Video skip button appears after 3 seconds
            useEffect(() => {
                if (screen === 'video') {
                    const timer = setTimeout(() => setShowSkip(true), 3000);
                    return () => clearTimeout(timer);
                }
            }, [screen]);

            // Breathing animation for portico
            useEffect(() => {
                if (screen === 'portico') {
                    setCanContinue(false);
                    const breathTimer = setInterval(() => {
                        setBreathPhase(p => p === 'inhale' ? 'exhale' : 'inhale');
                    }, 2500);
                    const continueTimer = setTimeout(() => {
                        setCanContinue(true);
                        playSound('bell');
                    }, 3000);
                    return () => {
                        clearInterval(breathTimer);
                        clearTimeout(continueTimer);
                    };
                }
            }, [screen]);

            const handleVideoEnd = () => setScreen('intro');
            const skipVideo = () => setScreen('intro');
            
            const startGame = () => {
                playSound('magic');
                setScreen('map');
            };

            const selectLevel = (level) => {
                if (level.isBonus && completedLevels.length < 7) return; // Bonus unlocks after all others
                playSound('click');
                setCurrentLevel(level);
                setScreen('story');
            };

            const startLevelGame = () => {
                playSound('click');
                setScreen('game');
            };

            const completeLevel = (score) => {
                playSound('success');
                setScores(prev => ({ ...prev, [currentLevel.id]: score }));
                setTotalScore(prev => prev + score);
                if (!completedLevels.includes(currentLevel.id)) {
                    setCompletedLevels(prev => [...prev, currentLevel.id]);
                }
                setScreen('portico');
            };

            const afterPortico = () => {
                if (completedLevels.length >= 7 && !completedLevels.includes(8)) {
                    // Show ethics quote after level 7
                    if (currentLevel.id === 7) {
                        playMelody([523, 659, 784, 1047]);
                    }
                }
                
                if (completedLevels.length >= 8) {
                    setScreen('complete');
                } else {
                    setScreen('map');
                }
            };

            const returnToMap = () => {
                playSound('click');
                setScreen('map');
            };

            // ============================================================
            // RENDER SCREENS
            // ============================================================
            
            // VIDEO SCREEN
            if (screen === 'video') {
                return (
                    <div className="fixed inset-0 bg-black flex items-center justify-center">
                        <video 
                            ref={videoRef}
                            className="w-full h-full object-cover"
                            autoPlay 
                            playsInline
                            onEnded={handleVideoEnd}
                            onError={handleVideoEnd}
                        >
                            <source src="media/intro.mp4" type="video/mp4" />
                        </video>
                        {showSkip && (
                            <button 
                                onClick={skipVideo}
                                className="absolute bottom-8 right-8 px-6 py-3 bg-white/20 hover:bg-white/40 text-white rounded-full backdrop-blur transition"
                            >
                                Skip â­ï¸
                            </button>
                        )}
                    </div>
                );
            }

            // INTRO SCREEN
            if (screen === 'intro') {
                return (
                    <div className="fixed inset-0 bg-gradient-to-b from-indigo-900 via-purple-900 to-black flex flex-col items-center justify-center p-8">
                        <div className="text-center slide-up">
                            <div className="text-8xl mb-6 float">ğŸª·</div>
                            <h1 className="text-5xl font-bold text-white mb-4">
                                Journey of Kindness
                            </h1>
                            <h2 className="text-3xl text-purple-300 mb-8">æ…ˆæ‚²ä¹‹æ—…</h2>
                            <p className="text-xl text-gray-300 mb-4 max-w-2xl">
                                {lang === 'zh' 
                                    ? 'æ¢ç´¢çµäººè§’ç¤¾å€ï¼Œé«”é©—7ç¨®AIæ¼”ç®—æ³•ï¼Œæ„Ÿå—16å¹´æ…ˆæ¿Ÿæœå‹™çš„æ•…äº‹'
                                    : 'Explore Hunters Point, experience 7 AI algorithms, feel 16 years of Tzu Chi service'}
                            </p>
                            <p className="text-lg text-purple-400 italic mb-8">
                                "A game is a series of interesting decisions." â€” Sid Meier
                            </p>
                            
                            <button 
                                onClick={startGame}
                                className="px-12 py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white text-2xl font-bold rounded-full hover:scale-105 transition transform glow"
                            >
                                {lang === 'zh' ? 'ğŸ—ºï¸ é–‹å§‹æ¢ç´¢' : 'ğŸ—ºï¸ Start Exploring'}
                            </button>
                            
                            <div className="mt-8 flex gap-4 justify-center">
                                <button 
                                    onClick={() => setLang('en')}
                                    className={`px-4 py-2 rounded-full ${lang === 'en' ? 'bg-white text-purple-900' : 'bg-white/20 text-white'}`}
                                >
                                    English
                                </button>
                                <button 
                                    onClick={() => setLang('zh')}
                                    className={`px-4 py-2 rounded-full ${lang === 'zh' ? 'bg-white text-purple-900' : 'bg-white/20 text-white'}`}
                                >
                                    ä¸­æ–‡
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // MAP SCREEN - Sid Meier Style!
            if (screen === 'map') {
                return (
                    <div className="fixed inset-0 bg-gradient-to-b from-sky-400 to-sky-600">
                        {/* Map Background */}
                        <div className="absolute inset-0 map-pan">
                            <img 
                                src="media/hunters_point_map.png" 
                                alt="Hunters Point Map"
                                className="w-full h-full object-cover"
                            />
                            <div className="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent" />
                        </div>
                        
                        {/* Header */}
                        <div className="absolute top-0 left-0 right-0 p-4 flex justify-between items-center bg-gradient-to-b from-black/60 to-transparent">
                            <div className="flex items-center gap-4">
                                <span className="text-3xl">ğŸ—ºï¸</span>
                                <div>
                                    <h2 className="text-xl font-bold text-white">Hunters Point Â· Bayview</h2>
                                    <p className="text-sm text-gray-300">
                                        {completedLevels.length}/8 {lang === 'zh' ? 'ä»»å‹™å®Œæˆ' : 'Missions Complete'}
                                    </p>
                                </div>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="bg-black/40 px-4 py-2 rounded-full">
                                    <span className="text-yellow-400">â­ {totalScore}</span>
                                </div>
                                <button 
                                    onClick={() => setLang(l => l === 'zh' ? 'en' : 'zh')}
                                    className="bg-white/20 px-3 py-1 rounded-full text-white text-sm"
                                >
                                    {lang === 'zh' ? 'EN' : 'ä¸­æ–‡'}
                                </button>
                            </div>
                        </div>
                        
                        {/* Map Markers */}
                        {LEVELS.map(level => {
                            const isCompleted = completedLevels.includes(level.id);
                            const isLocked = level.isBonus && completedLevels.length < 7;
                            
                            return (
                                <div
                                    key={level.id}
                                    className={`absolute map-marker ${isCompleted ? 'completed' : ''} ${isLocked ? 'locked' : ''}`}
                                    style={{ 
                                        left: `${level.location.x}%`, 
                                        top: `${level.location.y}%`,
                                        transform: 'translate(-50%, -50%)'
                                    }}
                                    onClick={() => !isLocked && selectLevel(level)}
                                >
                                    <div className={`relative group`}>
                                        {/* Marker */}
                                        <div className={`w-16 h-16 rounded-full bg-gradient-to-br ${level.color} flex items-center justify-center text-3xl shadow-lg border-4 border-white ${isCompleted ? 'ring-4 ring-yellow-400' : ''}`}>
                                            {isCompleted ? 'â­' : level.icon}
                                        </div>
                                        
                                        {/* Tooltip */}
                                        <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 opacity-0 group-hover:opacity-100 transition pointer-events-none">
                                            <div className="bg-black/90 text-white px-4 py-2 rounded-lg whitespace-nowrap text-center">
                                                <div className="font-bold">{lang === 'zh' ? level.nameZh : level.name}</div>
                                                <div className="text-xs text-gray-400">{level.algorithm}</div>
                                                {isLocked && <div className="text-xs text-yellow-400 mt-1">ğŸ”’ Complete all levels first</div>}
                                            </div>
                                        </div>
                                        
                                        {/* Pulse effect for available levels */}
                                        {!isCompleted && !isLocked && (
                                            <div className="absolute inset-0 rounded-full bg-white/30 pulse" />
                                        )}
                                    </div>
                                </div>
                            );
                        })}
                        
                        {/* Legend */}
                        <div className="absolute bottom-4 left-4 bg-black/60 p-4 rounded-xl backdrop-blur">
                            <h3 className="text-white font-bold mb-2">ğŸ¯ {lang === 'zh' ? 'ä¸‰ç¦è¨ˆåŠƒ' : 'Three Happinesses'}</h3>
                            <div className="text-sm text-gray-300 space-y-1">
                                <div>ğŸ« {lang === 'zh' ? 'å¹¸ç¦æ ¡åœ’' : 'Happy Campus'}</div>
                                <div>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ {lang === 'zh' ? 'å¹¸ç¦å®¶åº­' : 'Happy Family'}</div>
                                <div>ğŸ˜ï¸ {lang === 'zh' ? 'å¹¸ç¦ç¤¾å€' : 'Happy Community'}</div>
                            </div>
                        </div>
                        
                        {/* Progress Bar */}
                        <div className="absolute bottom-4 right-4 bg-black/60 p-4 rounded-xl backdrop-blur w-64">
                            <div className="flex justify-between text-white text-sm mb-2">
                                <span>{lang === 'zh' ? 'æ¢ç´¢é€²åº¦' : 'Progress'}</span>
                                <span>{Math.round(completedLevels.length / 8 * 100)}%</span>
                            </div>
                            <div className="h-3 bg-gray-700 rounded-full overflow-hidden">
                                <div 
                                    className="h-full bg-gradient-to-r from-green-400 to-emerald-500 transition-all duration-500"
                                    style={{ width: `${completedLevels.length / 8 * 100}%` }}
                                />
                            </div>
                        </div>
                    </div>
                );
            }

            // STORY SCREEN - Before each level
            if (screen === 'story' && currentLevel) {
                return (
                    <div className={`fixed inset-0 bg-gradient-to-b ${currentLevel.color} flex flex-col`}>
                        {/* Photo */}
                        <div className="flex-1 relative">
                            <img 
                                src={currentLevel.photo}
                                alt={currentLevel.name}
                                className="w-full h-full object-cover"
                            />
                            <div className="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent" />
                        </div>
                        
                        {/* Story */}
                        <div className="bg-black/80 p-8 slide-up">
                            <div className="max-w-2xl mx-auto text-center">
                                <div className="text-5xl mb-4">{currentLevel.icon}</div>
                                <h2 className="text-3xl font-bold text-white mb-2">
                                    {lang === 'zh' ? currentLevel.nameZh : currentLevel.name}
                                </h2>
                                <p className="text-purple-400 mb-4">{currentLevel.algorithm}</p>
                                <p className="text-xl text-gray-300 mb-6">
                                    {lang === 'zh' ? currentLevel.storyZh : currentLevel.story}
                                </p>
                                
                                <button 
                                    onClick={startLevelGame}
                                    className="px-8 py-4 bg-white text-gray-900 text-xl font-bold rounded-full hover:scale-105 transition"
                                >
                                    ğŸ® {lang === 'zh' ? 'é–‹å§‹æŒ‘æˆ°' : 'Start Challenge'}
                                </button>
                                
                                <button 
                                    onClick={returnToMap}
                                    className="block mx-auto mt-4 text-gray-400 hover:text-white"
                                >
                                    â† {lang === 'zh' ? 'è¿”å›åœ°åœ–' : 'Back to Map'}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // GAME SCREEN - Level-specific games
            if (screen === 'game' && currentLevel) {
                return (
                    <GameLevel 
                        level={currentLevel}
                        lang={lang}
                        onComplete={completeLevel}
                        onBack={returnToMap}
                    />
                );
            }

            // PORTICO SCREEN - Breathing pause
            if (screen === 'portico' && currentLevel) {
                const showEthics = currentLevel.id === 7;
                
                return (
                    <div className="fixed inset-0 bg-gradient-to-b from-purple-900 via-indigo-900 to-black flex flex-col items-center justify-center p-8">
                        {/* Gate Image */}
                        <div className="relative mb-8">
                            <img 
                                src="media/éœå¿ƒä¹‹é–€.png"
                                alt="Ataraxy Portico"
                                className="w-64 h-64 object-contain breathe"
                            />
                            <div className="absolute inset-0 flex items-center justify-center">
                                <span className="text-6xl float">ğŸª·</span>
                            </div>
                        </div>
                        
                        {/* Breathing Guide */}
                        <div className="text-center mb-8">
                            <p className="text-3xl text-purple-300 mb-4">
                                {breathPhase === 'inhale' 
                                    ? (lang === 'zh' ? 'å¸æ°£...' : 'Breathe in...') 
                                    : (lang === 'zh' ? 'å‘¼æ°£...' : 'Breathe out...')}
                            </p>
                            <div className={`w-32 h-32 mx-auto rounded-full border-4 border-purple-400 ${breathPhase === 'inhale' ? 'scale-100' : 'scale-75'} transition-transform duration-2500`} />
                        </div>
                        
                        {/* Jing Si Aphorism */}
                        <div className="text-center max-w-xl">
                            <p className="text-2xl text-white mb-2">ã€Œ{currentLevel.aphorism}ã€</p>
                            <p className="text-lg text-purple-300 italic">"{currentLevel.aphorismEn}"</p>
                            <p className="text-sm text-purple-500 mt-2">â€” Master Cheng Yen è­‰åš´æ³•å¸«</p>
                        </div>
                        
                        {/* Ethics Quote (after Level 7) */}
                        {showEthics && (
                            <div className="mt-8 p-6 bg-yellow-500/20 rounded-xl border border-yellow-500/50 max-w-lg slide-up">
                                <p className="text-xl text-yellow-300 mb-2">{ETHICS_QUOTE.zh}</p>
                                <p className="text-lg text-yellow-200 italic">{ETHICS_QUOTE.en}</p>
                            </div>
                        )}
                        
                        {/* Continue Button */}
                        <button 
                            onClick={afterPortico}
                            disabled={!canContinue}
                            className={`mt-8 px-8 py-3 rounded-full text-lg font-bold transition ${
                                canContinue 
                                    ? 'bg-purple-500 text-white hover:bg-purple-400' 
                                    : 'bg-gray-700 text-gray-500 cursor-not-allowed'
                            }`}
                        >
                            {canContinue 
                                ? (lang === 'zh' ? 'ğŸ—ºï¸ ç¹¼çºŒæ¢ç´¢' : 'ğŸ—ºï¸ Continue') 
                                : (lang === 'zh' ? 'è«‹éœå¿ƒå‘¼å¸...' : 'Please breathe...')}
                        </button>
                    </div>
                );
            }

            // COMPLETE SCREEN
            if (screen === 'complete') {
                return <CompleteScreen lang={lang} totalScore={totalScore} completedLevels={completedLevels} onRestart={() => {
                    setScreen('intro');
                    setCompletedLevels([]);
                    setScores({});
                    setTotalScore(0);
                }} />;
            }

            return null;
        }

        // ============================================================
        // GAME LEVEL COMPONENT - Contains all 8 mini-games
        // ============================================================
        function GameLevel({ level, lang, onComplete, onBack }) {
            const [gameState, setGameState] = useState('playing');
            const [score, setScore] = useState(0);

            const handleWin = (points) => {
                setScore(points);
                setGameState('won');
                playSound('complete');
                setTimeout(() => onComplete(points), 1500);
            };

            // Level 1: A* Frogger
            if (level.id === 1) {
                return <FroggerGame lang={lang} onWin={handleWin} onBack={onBack} />;
            }

            // Level 2: Logic Matching
            if (level.id === 2) {
                return <MatchingGame lang={lang} onWin={handleWin} onBack={onBack} />;
            }

            // Level 3: MDP Choice
            if (level.id === 3) {
                return <MDPGame lang={lang} onWin={handleWin} onBack={onBack} />;
            }

            // Level 4: KB Explorer
            if (level.id === 4) {
                return <ExplorerGame lang={lang} onWin={handleWin} onBack={onBack} />;
            }

            // Level 5: Bayesian
            if (level.id === 5) {
                return <BayesianGame lang={lang} onWin={handleWin} onBack={onBack} />;
            }

            // Level 6: Hanoi
            if (level.id === 6) {
                return <HanoiGame lang={lang} onWin={handleWin} onBack={onBack} />;
            }

            // Level 7: Tic-Tac-Toe
            if (level.id === 7) {
                return <TicTacToeGame lang={lang} onWin={handleWin} onBack={onBack} />;
            }

            // Level 8: Bonus Cleanup
            if (level.id === 8) {
                return <CleanupGame lang={lang} onWin={handleWin} onBack={onBack} />;
            }

            return null;
        }

        // ============================================================
        // MINI-GAMES
        // ============================================================
        
        // Level 1: A* Frogger
        function FroggerGame({ lang, onWin, onBack }) {
            const [playerPos, setPlayerPos] = useState({ x: 2, y: 4 });
            const [cars, setCars] = useState([
                { x: 0, y: 1, dx: 1, emoji: 'ğŸš—' },
                { x: 3, y: 2, dx: -1, emoji: 'ğŸš™' },
                { x: 1, y: 3, dx: 1, emoji: 'ğŸš•' },
            ]);

            useEffect(() => {
                const handleKey = (e) => {
                    setPlayerPos(prev => {
                        let { x, y } = prev;
                        if ((e.key === 'ArrowUp' || e.key === 'w') && y > 0) y--;
                        if ((e.key === 'ArrowDown' || e.key === 's') && y < 4) y++;
                        if ((e.key === 'ArrowLeft' || e.key === 'a') && x > 0) x--;
                        if ((e.key === 'ArrowRight' || e.key === 'd') && x < 4) x++;
                        return { x, y };
                    });
                };
                window.addEventListener('keydown', handleKey);
                return () => window.removeEventListener('keydown', handleKey);
            }, []);

            useEffect(() => {
                const interval = setInterval(() => {
                    setCars(prev => prev.map(car => ({
                        ...car,
                        x: (car.x + car.dx + 5) % 5
                    })));
                }, 800);
                return () => clearInterval(interval);
            }, []);

            useEffect(() => {
                if (playerPos.y === 0) {
                    onWin(100);
                }
                // Check collision
                const hit = cars.some(car => car.x === playerPos.x && car.y === playerPos.y);
                if (hit) {
                    playSound('error');
                    setPlayerPos({ x: 2, y: 4 });
                }
            }, [playerPos, cars]);

            return (
                <div className="fixed inset-0 bg-gradient-to-b from-blue-900 to-blue-700 flex flex-col items-center justify-center p-4">
                    <h2 className="text-2xl font-bold text-white mb-4">
                        ğŸ  {lang === 'zh' ? 'é€é¤åˆ° Mrs. Garcia å®¶' : 'Deliver to Mrs. Garcia'}
                    </h2>
                    <p className="text-gray-300 mb-4">{lang === 'zh' ? 'ç”¨æ–¹å‘éµæˆ–WASDç§»å‹•ï¼Œé¿é–‹è»Šè¼›ï¼' : 'Use arrows or WASD to move, avoid cars!'}</p>
                    
                    <div className="grid grid-cols-5 gap-1 bg-gray-800 p-2 rounded-lg">
                        {Array(5).fill(0).map((_, y) => (
                            Array(5).fill(0).map((_, x) => {
                                const isPlayer = playerPos.x === x && playerPos.y === y;
                                const car = cars.find(c => c.x === x && c.y === y);
                                const isGoal = y === 0 && x === 2;
                                
                                return (
                                    <div 
                                        key={`${x}-${y}`}
                                        className={`w-16 h-16 flex items-center justify-center text-3xl rounded ${
                                            y === 0 ? 'bg-green-600' : 
                                            y === 4 ? 'bg-blue-600' : 'bg-gray-600'
                                        }`}
                                    >
                                        {isPlayer ? 'ğŸ’™' : car ? car.emoji : isGoal ? 'ğŸ ' : ''}
                                    </div>
                                );
                            })
                        ))}
                    </div>
                    
                    {/* Mobile controls */}
                    <div className="mt-6 grid grid-cols-3 gap-2">
                        <div />
                        <button onClick={() => setPlayerPos(p => ({ ...p, y: Math.max(0, p.y - 1) }))} className="p-4 bg-white/20 rounded-lg text-2xl">â¬†ï¸</button>
                        <div />
                        <button onClick={() => setPlayerPos(p => ({ ...p, x: Math.max(0, p.x - 1) }))} className="p-4 bg-white/20 rounded-lg text-2xl">â¬…ï¸</button>
                        <button onClick={() => setPlayerPos(p => ({ ...p, y: Math.min(4, p.y + 1) }))} className="p-4 bg-white/20 rounded-lg text-2xl">â¬‡ï¸</button>
                        <button onClick={() => setPlayerPos(p => ({ ...p, x: Math.min(4, p.x + 1) }))} className="p-4 bg-white/20 rounded-lg text-2xl">â¡ï¸</button>
                    </div>
                    
                    <button onClick={onBack} className="mt-4 text-gray-400 hover:text-white">
                        â† {lang === 'zh' ? 'è¿”å›' : 'Back'}
                    </button>
                </div>
            );
        }

        // Level 2: Logic Matching Game
        function MatchingGame({ lang, onWin, onBack }) {
            const items = ['ğŸš', 'ğŸ¥«', 'ğŸ§¥', 'ğŸ“š', 'ğŸš', 'ğŸ¥«', 'ğŸ§¥', 'ğŸ“š'];
            const [cards, setCards] = useState(() => 
                items.sort(() => Math.random() - 0.5).map((emoji, i) => ({ id: i, emoji, flipped: false, matched: false }))
            );
            const [selected, setSelected] = useState([]);
            const [moves, setMoves] = useState(0);

            const flipCard = (id) => {
                if (selected.length === 2) return;
                const card = cards.find(c => c.id === id);
                if (card.flipped || card.matched) return;
                
                playSound('click');
                setCards(prev => prev.map(c => c.id === id ? { ...c, flipped: true } : c));
                setSelected(prev => [...prev, id]);
            };

            useEffect(() => {
                if (selected.length === 2) {
                    setMoves(m => m + 1);
                    const [a, b] = selected.map(id => cards.find(c => c.id === id));
                    
                    if (a.emoji === b.emoji) {
                        playSound('success');
                        setCards(prev => prev.map(c => 
                            c.id === a.id || c.id === b.id ? { ...c, matched: true } : c
                        ));
                        setSelected([]);
                    } else {
                        setTimeout(() => {
                            setCards(prev => prev.map(c => 
                                c.id === a.id || c.id === b.id ? { ...c, flipped: false } : c
                            ));
                            setSelected([]);
                        }, 800);
                    }
                }
            }, [selected]);

            useEffect(() => {
                if (cards.every(c => c.matched)) {
                    onWin(Math.max(50, 100 - moves * 5));
                }
            }, [cards]);

            return (
                <div className="fixed inset-0 bg-gradient-to-b from-green-900 to-green-700 flex flex-col items-center justify-center p-4">
                    <h2 className="text-2xl font-bold text-white mb-4">
                        ğŸ« {lang === 'zh' ? 'é…å°ç‰©è³‡' : 'Match Supplies'}
                    </h2>
                    <p className="text-gray-300 mb-4">{lang === 'zh' ? `æ­¥æ•¸: ${moves}` : `Moves: ${moves}`}</p>
                    
                    <div className="grid grid-cols-4 gap-3">
                        {cards.map(card => (
                            <div
                                key={card.id}
                                onClick={() => flipCard(card.id)}
                                className={`w-20 h-20 flex items-center justify-center text-4xl rounded-xl cursor-pointer transition-all transform ${
                                    card.flipped || card.matched 
                                        ? 'bg-white rotate-0' 
                                        : 'bg-green-600 hover:bg-green-500'
                                } ${card.matched ? 'ring-4 ring-yellow-400' : ''}`}
                            >
                                {(card.flipped || card.matched) ? card.emoji : 'â“'}
                            </div>
                        ))}
                    </div>
                    
                    <button onClick={onBack} className="mt-6 text-gray-400 hover:text-white">
                        â† {lang === 'zh' ? 'è¿”å›' : 'Back'}
                    </button>
                </div>
            );
        }

        // Level 3: MDP Choice Adventure
        function MDPGame({ lang, onWin, onBack }) {
            const [step, setStep] = useState(0);
            const [totalPoints, setTotalPoints] = useState(0);
            
            const scenarios = [
                {
                    text: lang === 'zh' ? 'ä½ åœ¨RV Parké‡åˆ°ä¸€ä½éœ²å®¿è€…ï¼Œä»–çœ‹èµ·ä¾†å¾ˆé¤“ã€‚ä½ æœƒ...' : 'You meet a homeless person at RV Park who looks hungry...',
                    choices: [
                        { text: lang === 'zh' ? 'ç«‹å³åˆ†äº«ä½ çš„é£Ÿç‰©' : 'Share your food immediately', points: 40 },
                        { text: lang === 'zh' ? 'å‘Šè¨´ä»–é£Ÿç‰©ç™¼æ”¾çš„æ™‚é–“' : 'Tell them about food distribution time', points: 25 }
                    ]
                },
                {
                    text: lang === 'zh' ? 'ä¸€ä½è€äººéœ€è¦æ¯›æ¯¯ï¼Œä½†ä½ åªå‰©ä¸€æ¢äº†...' : 'An elder needs a blanket, but you only have one left...',
                    choices: [
                        { text: lang === 'zh' ? 'æŠŠæ¯›æ¯¯çµ¦ä»–ï¼Œå†å»æ‹¿æ›´å¤š' : 'Give the blanket, get more later', points: 35 },
                        { text: lang === 'zh' ? 'è¨˜ä¸‹ä»–çš„åœ°å€ï¼Œæ˜å¤©é€å»' : 'Note address, deliver tomorrow', points: 30 }
                    ]
                },
                {
                    text: lang === 'zh' ? 'æ´»å‹•çµæŸäº†ï¼Œé‚„æœ‰å‰©é¤˜ç‰©è³‡...' : 'Event ended, supplies remain...',
                    choices: [
                        { text: lang === 'zh' ? 'æŒ¨å®¶æŒ¨æˆ¶é€çµ¦éœ€è¦çš„äºº' : 'Go door-to-door to distribute', points: 40 },
                        { text: lang === 'zh' ? 'ä¿å­˜èµ·ä¾†ä¸‹æ¬¡ä½¿ç”¨' : 'Save for next time', points: 20 }
                    ]
                }
            ];

            const choose = (points) => {
                playSound('click');
                setTotalPoints(prev => prev + points);
                if (step < scenarios.length - 1) {
                    setStep(s => s + 1);
                } else {
                    onWin(totalPoints + points);
                }
            };

            return (
                <div className="fixed inset-0 bg-gradient-to-b from-orange-900 to-orange-700 flex flex-col items-center justify-center p-8">
                    <h2 className="text-2xl font-bold text-white mb-2">
                        ğŸš {lang === 'zh' ? 'RV Park æŠ‰æ“‡' : 'RV Park Decisions'}
                    </h2>
                    <p className="text-orange-300 mb-6">{lang === 'zh' ? `ç´¯ç©å–„å¿ƒ: ${totalPoints}` : `Kindness: ${totalPoints}`}</p>
                    
                    <div className="bg-black/40 p-8 rounded-2xl max-w-lg">
                        <p className="text-xl text-white mb-6">{scenarios[step].text}</p>
                        
                        <div className="space-y-4">
                            {scenarios[step].choices.map((choice, i) => (
                                <button
                                    key={i}
                                    onClick={() => choose(choice.points)}
                                    className="w-full p-4 bg-orange-600 hover:bg-orange-500 text-white rounded-xl text-left transition"
                                >
                                    {choice.text}
                                </button>
                            ))}
                        </div>
                    </div>
                    
                    <div className="mt-6 flex gap-2">
                        {scenarios.map((_, i) => (
                            <div key={i} className={`w-3 h-3 rounded-full ${i <= step ? 'bg-white' : 'bg-white/30'}`} />
                        ))}
                    </div>
                    
                    <button onClick={onBack} className="mt-4 text-gray-400 hover:text-white">
                        â† {lang === 'zh' ? 'è¿”å›' : 'Back'}
                    </button>
                </div>
            );
        }

        // Level 4: KB Explorer (Wumpus-style)
        function ExplorerGame({ lang, onWin, onBack }) {
            const targets = ['ğŸ‘¨â€ğŸ‘©â€ğŸ‘§', 'ğŸ‘´', 'ğŸ‘µ', 'ğŸ§’'];
            const distractors = ['ğŸ', 'ğŸ’•', 'ğŸŒŸ', 'âœ¨', 'ğŸ’–'];
            const [grid, setGrid] = useState(() => {
                const all = [...targets, ...distractors.slice(0, 5)];
                return all.sort(() => Math.random() - 0.5).map((emoji, i) => ({
                    id: i,
                    emoji,
                    revealed: false,
                    isTarget: targets.includes(emoji)
                }));
            });
            const [found, setFound] = useState(0);

            const reveal = (id) => {
                const cell = grid.find(c => c.id === id);
                if (cell.revealed) return;
                
                playSound(cell.isTarget ? 'success' : 'click');
                setGrid(prev => prev.map(c => c.id === id ? { ...c, revealed: true } : c));
                
                if (cell.isTarget) {
                    setFound(f => f + 1);
                }
            };

            useEffect(() => {
                if (found === 4) {
                    onWin(100);
                }
            }, [found]);

            return (
                <div className="fixed inset-0 bg-gradient-to-b from-purple-900 to-purple-700 flex flex-col items-center justify-center p-4">
                    <h2 className="text-2xl font-bold text-white mb-4">
                        ğŸ§¥ {lang === 'zh' ? 'æ‰¾åˆ°éœ€è¦å¹«åŠ©çš„å®¶åº­' : 'Find Families in Need'}
                    </h2>
                    <p className="text-purple-300 mb-4">{lang === 'zh' ? `å·²æ‰¾åˆ°: ${found}/4` : `Found: ${found}/4`}</p>
                    
                    <div className="grid grid-cols-3 gap-3">
                        {grid.map(cell => (
                            <div
                                key={cell.id}
                                onClick={() => reveal(cell.id)}
                                className={`w-20 h-20 flex items-center justify-center text-4xl rounded-xl cursor-pointer transition ${
                                    cell.revealed 
                                        ? (cell.isTarget ? 'bg-green-500' : 'bg-gray-600') 
                                        : 'bg-purple-600 hover:bg-purple-500'
                                }`}
                            >
                                {cell.revealed ? cell.emoji : 'â“'}
                            </div>
                        ))}
                    </div>
                    
                    <button onClick={onBack} className="mt-6 text-gray-400 hover:text-white">
                        â† {lang === 'zh' ? 'è¿”å›' : 'Back'}
                    </button>
                </div>
            );
        }

        // Level 5: Bayesian Prediction
        function BayesianGame({ lang, onWin, onBack }) {
            const [answers, setAnswers] = useState({});
            const questions = [
                { id: 'attendance', text: lang === 'zh' ? 'é€™ä½å¿—å·¥æœ€è¿‘å‡ºå¸­ç‡é«˜å—ï¼Ÿ' : 'High attendance recently?', weight: 0.35 },
                { id: 'tired', text: lang === 'zh' ? 'ä»–çœ‹èµ·ä¾†ç–²æ†Šå—ï¼Ÿ' : 'Looks tired?', weight: 0.25 },
                { id: 'connected', text: lang === 'zh' ? 'ä»–èˆ‡ç¤¾å€é€£çµç·Šå¯†å—ï¼Ÿ' : 'Well connected to community?', weight: 0.30 }
            ];

            const answer = (qId, value) => {
                playSound('click');
                setAnswers(prev => ({ ...prev, [qId]: value }));
            };

            const calculate = () => {
                let risk = 0.1; // base
                if (answers.attendance === 'no') risk += 0.35;
                if (answers.tired === 'yes') risk += 0.25;
                if (answers.connected === 'no') risk += 0.30;
                return Math.min(1, risk);
            };

            const allAnswered = Object.keys(answers).length === 3;

            return (
                <div className="fixed inset-0 bg-gradient-to-b from-teal-900 to-teal-700 flex flex-col items-center justify-center p-8">
                    <h2 className="text-2xl font-bold text-white mb-4">
                        ğŸ‘¥ {lang === 'zh' ? 'å¿—å·¥å€¦æ€ é¢¨éšªè©•ä¼°' : 'Volunteer Burnout Assessment'}
                    </h2>
                    
                    <div className="bg-black/40 p-6 rounded-2xl max-w-lg w-full space-y-6">
                        {questions.map(q => (
                            <div key={q.id}>
                                <p className="text-white mb-2">{q.text}</p>
                                <div className="flex gap-4">
                                    <button
                                        onClick={() => answer(q.id, 'yes')}
                                        className={`flex-1 p-3 rounded-lg transition ${
                                            answers[q.id] === 'yes' ? 'bg-green-500 text-white' : 'bg-white/20 text-white hover:bg-white/30'
                                        }`}
                                    >
                                        {lang === 'zh' ? 'æ˜¯' : 'Yes'}
                                    </button>
                                    <button
                                        onClick={() => answer(q.id, 'no')}
                                        className={`flex-1 p-3 rounded-lg transition ${
                                            answers[q.id] === 'no' ? 'bg-red-500 text-white' : 'bg-white/20 text-white hover:bg-white/30'
                                        }`}
                                    >
                                        {lang === 'zh' ? 'å¦' : 'No'}
                                    </button>
                                </div>
                            </div>
                        ))}
                        
                        {allAnswered && (
                            <div className="text-center pt-4 border-t border-white/20">
                                <p className="text-xl text-white mb-2">
                                    {lang === 'zh' ? 'å€¦æ€ é¢¨éšª' : 'Burnout Risk'}: 
                                    <span className="text-yellow-400 font-bold ml-2">
                                        {Math.round(calculate() * 100)}%
                                    </span>
                                </p>
                                <button
                                    onClick={() => onWin(Math.round((1 - calculate()) * 100))}
                                    className="mt-4 px-6 py-3 bg-teal-500 hover:bg-teal-400 text-white rounded-full font-bold"
                                >
                                    {lang === 'zh' ? 'å®Œæˆè©•ä¼°' : 'Complete Assessment'}
                                </button>
                            </div>
                        )}
                    </div>
                    
                    <button onClick={onBack} className="mt-6 text-gray-400 hover:text-white">
                        â† {lang === 'zh' ? 'è¿”å›' : 'Back'}
                    </button>
                </div>
            );
        }

        // Level 6: Towers of Hanoi
        function HanoiGame({ lang, onWin, onBack }) {
            const [towers, setTowers] = useState([[3, 2, 1], [], []]);
            const [selected, setSelected] = useState(null);
            const [moves, setMoves] = useState(0);

            const selectTower = (index) => {
                if (selected === null) {
                    if (towers[index].length > 0) {
                        setSelected(index);
                        playSound('click');
                    }
                } else {
                    if (index === selected) {
                        setSelected(null);
                    } else {
                        const fromTop = towers[selected][towers[selected].length - 1];
                        const toTop = towers[index][towers[index].length - 1];
                        
                        if (toTop === undefined || fromTop < toTop) {
                            setTowers(prev => {
                                const newTowers = prev.map(t => [...t]);
                                newTowers[index].push(newTowers[selected].pop());
                                return newTowers;
                            });
                            setMoves(m => m + 1);
                            playSound('success');
                        } else {
                            playSound('error');
                        }
                        setSelected(null);
                    }
                }
            };

            useEffect(() => {
                if (towers[2].length === 3) {
                    onWin(Math.max(50, 100 - (moves - 7) * 5));
                }
            }, [towers]);

            const towerNames = lang === 'zh' ? ['è¨“ç·´', 'ç·´ç¿’', 'æ­£å¼'] : ['Training', 'Practice', 'Official'];

            return (
                <div className="fixed inset-0 bg-gradient-to-b from-emerald-900 to-emerald-700 flex flex-col items-center justify-center p-4">
                    <h2 className="text-2xl font-bold text-white mb-4">
                        ğŸŒ³ {lang === 'zh' ? 'å‚³æ‰¿æ™ºæ…§ (æ²³å…§å¡”)' : 'Passing Wisdom (Hanoi)'}
                    </h2>
                    <p className="text-emerald-300 mb-4">{lang === 'zh' ? `æ­¥æ•¸: ${moves} (æœ€ä½³: 7)` : `Moves: ${moves} (Optimal: 7)`}</p>
                    
                    <div className="flex gap-8">
                        {towers.map((tower, i) => (
                            <div key={i} className="flex flex-col items-center">
                                <div
                                    onClick={() => selectTower(i)}
                                    className={`w-32 h-40 flex flex-col-reverse items-center justify-start p-2 rounded-lg cursor-pointer transition ${
                                        selected === i ? 'bg-yellow-500/30 ring-2 ring-yellow-400' : 'bg-black/30 hover:bg-black/40'
                                    }`}
                                >
                                    {tower.map((disc, j) => (
                                        <div
                                            key={j}
                                            className="h-8 rounded-full bg-gradient-to-r from-emerald-400 to-emerald-600 mb-1"
                                            style={{ width: `${disc * 30 + 20}px` }}
                                        />
                                    ))}
                                </div>
                                <p className="text-white mt-2">{towerNames[i]}</p>
                            </div>
                        ))}
                    </div>
                    
                    <button onClick={onBack} className="mt-6 text-gray-400 hover:text-white">
                        â† {lang === 'zh' ? 'è¿”å›' : 'Back'}
                    </button>
                </div>
            );
        }

        // Level 7: Tic-Tac-Toe
        function TicTacToeGame({ lang, onWin, onBack }) {
            const [board, setBoard] = useState(Array(9).fill(null));
            const [isPlayerTurn, setIsPlayerTurn] = useState(true);
            const [gameOver, setGameOver] = useState(false);

            const checkWin = (b, player) => {
                const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
                return lines.some(([a,b,c]) => board[a] === player && board[b] === player && board[c] === player);
            };

            const minimax = (b, isMax) => {
                if (checkWin(b, 'ğŸ¤–')) return 10;
                if (checkWin(b, 'ğŸ’™')) return -10;
                if (!b.includes(null)) return 0;

                if (isMax) {
                    let best = -Infinity;
                    for (let i = 0; i < 9; i++) {
                        if (b[i] === null) {
                            b[i] = 'ğŸ¤–';
                            best = Math.max(best, minimax(b, false));
                            b[i] = null;
                        }
                    }
                    return best;
                } else {
                    let best = Infinity;
                    for (let i = 0; i < 9; i++) {
                        if (b[i] === null) {
                            b[i] = 'ğŸ’™';
                            best = Math.min(best, minimax(b, true));
                            b[i] = null;
                        }
                    }
                    return best;
                }
            };

            const aiMove = () => {
                let bestScore = -Infinity;
                let bestMove = null;
                const newBoard = [...board];
                
                // Prefer center
                if (newBoard[4] === null) {
                    bestMove = 4;
                } else {
                    for (let i = 0; i < 9; i++) {
                        if (newBoard[i] === null) {
                            newBoard[i] = 'ğŸ¤–';
                            const score = minimax(newBoard, false);
                            newBoard[i] = null;
                            if (score > bestScore) {
                                bestScore = score;
                                bestMove = i;
                            }
                        }
                    }
                }
                
                if (bestMove !== null) {
                    setBoard(prev => {
                        const newB = [...prev];
                        newB[bestMove] = 'ğŸ¤–';
                        return newB;
                    });
                }
                setIsPlayerTurn(true);
            };

            const playerMove = (i) => {
                if (board[i] || gameOver || !isPlayerTurn) return;
                playSound('click');
                
                setBoard(prev => {
                    const newB = [...prev];
                    newB[i] = 'ğŸ’™';
                    return newB;
                });
                setIsPlayerTurn(false);
            };

            useEffect(() => {
                if (!isPlayerTurn && !gameOver) {
                    setTimeout(aiMove, 500);
                }
            }, [isPlayerTurn, gameOver]);

            useEffect(() => {
                if (checkWin(board, 'ğŸ’™')) {
                    setGameOver(true);
                    onWin(100);
                } else if (checkWin(board, 'ğŸ¤–')) {
                    setGameOver(true);
                    onWin(50);
                } else if (!board.includes(null)) {
                    setGameOver(true);
                    onWin(70);
                }
            }, [board]);

            return (
                <div className="fixed inset-0 bg-gradient-to-b from-indigo-900 to-indigo-700 flex flex-col items-center justify-center p-4">
                    <h2 className="text-2xl font-bold text-white mb-4">
                        ğŸŒ {lang === 'zh' ? 'æ…ˆæ‚² vs æ‡·ç–‘' : 'Compassion vs Doubt'}
                    </h2>
                    <p className="text-indigo-300 mb-4">
                        {gameOver 
                            ? (lang === 'zh' ? 'éŠæˆ²çµæŸï¼' : 'Game Over!') 
                            : (isPlayerTurn 
                                ? (lang === 'zh' ? 'ä½ çš„å›åˆ ğŸ’™' : 'Your turn ğŸ’™') 
                                : (lang === 'zh' ? 'AI æ€è€ƒä¸­...' : 'AI thinking...'))}
                    </p>
                    
                    <div className="grid grid-cols-3 gap-2 bg-black/30 p-4 rounded-xl">
                        {board.map((cell, i) => (
                            <div
                                key={i}
                                onClick={() => playerMove(i)}
                                className={`w-20 h-20 flex items-center justify-center text-4xl rounded-lg cursor-pointer transition ${
                                    cell ? 'bg-indigo-600' : 'bg-indigo-800 hover:bg-indigo-700'
                                }`}
                            >
                                {cell}
                            </div>
                        ))}
                    </div>
                    
                    <button onClick={onBack} className="mt-6 text-gray-400 hover:text-white">
                        â† {lang === 'zh' ? 'è¿”å›' : 'Back'}
                    </button>
                </div>
            );
        }

        // Level 8: Bonus Cleanup Game
        function CleanupGame({ lang, onWin, onBack }) {
            const [trash, setTrash] = useState(() => 
                Array(12).fill(0).map((_, i) => ({
                    id: i,
                    x: Math.random() * 80 + 10,
                    y: Math.random() * 60 + 20,
                    collected: false,
                    emoji: ['ğŸ—‘ï¸', 'ğŸ“¦', 'ğŸ¥¤', 'ğŸ‚'][Math.floor(Math.random() * 4)]
                }))
            );
            const [collected, setCollected] = useState(0);

            const collect = (id) => {
                playSound('success');
                setTrash(prev => prev.map(t => t.id === id ? { ...t, collected: true } : t));
                setCollected(c => c + 1);
            };

            useEffect(() => {
                if (collected === 12) {
                    onWin(100);
                }
            }, [collected]);

            return (
                <div className="fixed inset-0 bg-gradient-to-b from-lime-800 to-lime-600 flex flex-col items-center justify-center p-4">
                    <h2 className="text-2xl font-bold text-white mb-4">
                        ğŸŒ± {lang === 'zh' ? 'ç’°ä¿å°å°–å…µ' : 'Environment Guardians'}
                    </h2>
                    <p className="text-lime-200 mb-4">{lang === 'zh' ? `å·²æ”¶é›†: ${collected}/12` : `Collected: ${collected}/12`}</p>
                    
                    <div className="relative w-full max-w-lg h-80 bg-green-700/50 rounded-2xl overflow-hidden">
                        {/* Background image */}
                        <div 
                            className="absolute inset-0 opacity-30"
                            style={{ 
                                backgroundImage: 'url(media/EnvironmentVangguard_.png)',
                                backgroundSize: 'cover',
                                backgroundPosition: 'center'
                            }}
                        />
                        
                        {/* Trash items */}
                        {trash.map(t => !t.collected && (
                            <div
                                key={t.id}
                                onClick={() => collect(t.id)}
                                className="absolute text-3xl cursor-pointer hover:scale-125 transition transform"
                                style={{ left: `${t.x}%`, top: `${t.y}%` }}
                            >
                                {t.emoji}
                            </div>
                        ))}
                    </div>
                    
                    <p className="text-lime-200 mt-4 text-sm">
                        {lang === 'zh' ? 'é»æ“Šæ”¶é›†æ‰€æœ‰åƒåœ¾ï¼' : 'Click to collect all trash!'}
                    </p>
                    
                    <button onClick={onBack} className="mt-4 text-gray-300 hover:text-white">
                        â† {lang === 'zh' ? 'è¿”å›' : 'Back'}
                    </button>
                </div>
            );
        }

        // ============================================================
        // COMPLETE SCREEN
        // ============================================================
        function CompleteScreen({ lang, totalScore, completedLevels, onRestart }) {
            const [confetti, setConfetti] = useState([]);
            const [slideIndex, setSlideIndex] = useState(0);
            
            // ä¸‰ç¦æœå‹™ç…§ç‰‡è¼ªæ’­
            const servicePhotos = [
                { src: 'media/å¼µé†«å¸«ä¸­é†«_é¦¬è³½å…‹v2__1_.jpg', zh: 'ğŸ¥ ä¸­é†«é‡ç¸ç¾©è¨º', en: 'ğŸ¥ TCM Acupuncture' },
                { src: 'media/å³é†«å¸«__å¥³_.png', zh: 'ğŸ’Š å¥åº·æª¢æŸ¥æœå‹™', en: 'ğŸ’Š Health Checkup' },
                { src: 'media/VegiCooking_å®Œæˆv2__1_.png', zh: 'ğŸ¥— è”¬é£Ÿçƒ¹é£ªæ•™å­¸', en: 'ğŸ¥— Veggie Cooking Class' }
            ];
            
            useEffect(() => {
                // Generate confetti
                const pieces = Array(60).fill(0).map((_, i) => ({
                    id: i,
                    x: Math.random() * 100,
                    color: ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7'][Math.floor(Math.random() * 6)],
                    delay: Math.random() * 2
                }));
                setConfetti(pieces);
                playMelody([523, 587, 659, 698, 784, 880, 988, 1047]);
                
                // Auto-rotate slideshow
                const timer = setInterval(() => {
                    setSlideIndex(i => (i + 1) % 3);
                }, 3000);
                return () => clearInterval(timer);
            }, []);

            return (
                <div className="fixed inset-0 bg-gradient-to-b from-indigo-900 via-purple-900 to-black flex flex-col items-center justify-center p-8 overflow-hidden">
                    {/* Confetti */}
                    {confetti.map(c => (
                        <div
                            key={c.id}
                            className="confetti-piece rounded-sm"
                            style={{
                                left: `${c.x}%`,
                                backgroundColor: c.color,
                                animationDelay: `${c.delay}s`
                            }}
                        />
                    ))}
                    
                    {/* Earth Tree Image */}
                    <div className="relative mb-6">
                        <img 
                            src="media/Outro___Earth___Tree_of_Unit.jpg"
                            alt="Global Unity"
                            className="w-80 h-48 object-cover rounded-2xl shadow-2xl"
                        />
                        <div className="absolute inset-0 flex items-center justify-center">
                            <span className="text-6xl star-burst">ğŸŒ</span>
                        </div>
                    </div>
                    
                    <h1 className="text-4xl font-bold text-white mb-2 text-center">
                        {lang === 'zh' ? 'ğŸ‰ æ…ˆæ‚²ä¹‹æ—…å®Œæˆï¼' : 'ğŸ‰ Journey Complete!'}
                    </h1>
                    
                    {/* Score Card */}
                    <div className="bg-white/10 backdrop-blur rounded-2xl p-6 my-6 text-center">
                        <div className="text-5xl text-yellow-400 font-bold mb-2">â­ {totalScore}</div>
                        <p className="text-gray-300">{lang === 'zh' ? 'ç¸½åˆ†' : 'Total Score'}</p>
                        <div className="text-2xl text-green-400 mt-2">+{Math.round(totalScore / 5)} ELO</div>
                    </div>
                    
                    {/* Research Stats */}
                    <div className="bg-blue-500/20 rounded-xl p-4 mb-4 text-center">
                        <p className="text-blue-300 text-sm mb-2">{lang === 'zh' ? 'ç ”ç©¶çµ±è¨ˆ' : 'Research Stats'}</p>
                        <p className="text-white">
                            {lang === 'zh' ? 'æ‹›å‹Ÿè½‰æ›ç‡' : 'Recruitment'}: <span className="text-green-400 font-bold">67%</span>
                        </p>
                        <p className="text-gray-400 text-xs">(95% CI: 38%-88%, N=15)</p>
                    </div>
                    
                    {/* ä¸‰ç¦æœå‹™ç…§ç‰‡è¼ªæ’­ */}
                    <div className="bg-white/10 backdrop-blur rounded-2xl p-4 mb-4">
                        <p className="text-center text-yellow-400 text-sm mb-3">
                            âœ¨ {lang === 'zh' ? 'æ›´å¤šä¸‰ç¦æœå‹™' : 'More Community Services'} âœ¨
                        </p>
                        <div className="relative w-64 h-40 mx-auto overflow-hidden rounded-xl">
                            {servicePhotos.map((photo, i) => (
                                <div
                                    key={i}
                                    className="absolute inset-0 transition-all duration-700"
                                    style={{
                                        opacity: slideIndex === i ? 1 : 0,
                                        transform: slideIndex === i ? 'scale(1)' : 'scale(0.9)'
                                    }}
                                >
                                    <img 
                                        src={photo.src} 
                                        alt={photo.en}
                                        className="w-full h-full object-cover"
                                    />
                                </div>
                            ))}
                        </div>
                        <p className="text-center text-white mt-2 text-sm">
                            {lang === 'zh' ? servicePhotos[slideIndex].zh : servicePhotos[slideIndex].en}
                        </p>
                        <div className="flex justify-center gap-2 mt-2">
                            {servicePhotos.map((_, i) => (
                                <button
                                    key={i}
                                    onClick={() => setSlideIndex(i)}
                                    className={`w-2 h-2 rounded-full transition ${slideIndex === i ? 'bg-yellow-400' : 'bg-gray-500'}`}
                                />
                            ))}
                        </div>
                    </div>
                    
                    {/* Survey */}
                    <a 
                        href="https://forms.gle/jU6y5j4W3LB97GMj9"
                        target="_blank"
                        rel="noopener noreferrer"
                        className="px-8 py-4 bg-green-500 hover:bg-green-400 text-white font-bold rounded-full transition mb-4"
                    >
                        ğŸ“ {lang === 'zh' ? 'å¡«å¯«å•å·åŠ å…¥å¿—å·¥' : 'Fill Survey to Join'}
                    </a>
                    
                    {/* QR Codes */}
                    <div className="flex gap-4 mb-6">
                        <img src="media/TCSF_FB.jpeg" alt="Facebook" className="w-20 h-20 rounded-lg" />
                        <img src="media/TCSF_IG_jpg.png" alt="Instagram" className="w-20 h-20 rounded-lg" />
                    </div>
                    
                    {/* Credits */}
                    <div className="text-center text-gray-400 text-sm">
                        <p>è¨±ç¾å«» Mei Hsien Hsu | LPC CS4 | Professor An Lam | Fall 2025</p>
                        <p className="mt-2 text-purple-400 italic">
                            ã€Œæ„Ÿæ©ï¼Œæ˜¯ä¸–é–“æœ€ç¾çš„èªè¨€ã€â€” Master Cheng Yen
                        </p>
                    </div>
                    
                    <button 
                        onClick={onRestart}
                        className="mt-6 text-gray-400 hover:text-white"
                    >
                        ğŸ”„ {lang === 'zh' ? 'é‡æ–°é–‹å§‹' : 'Play Again'}
                    </button>
                </div>
            );
        }

        // ============================================================
        // RENDER
        // ============================================================
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
